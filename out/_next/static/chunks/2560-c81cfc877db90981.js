(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1318,2560],{449:(e,t,i)=>{"use strict";i.d(t,{b:()=>n});var s=i(12115);let n=()=>s.useRef(null)},1318:(e,t,i)=>{"use strict";i.d(t,{default:()=>E});var s=i(12115),n=i(52596),o=i(15386),r=i(78894),a=i(17261),l=i(44934),c=i(38017),d=i(39571),h=i(13973),u=i(80398),p=i(15306),m=i(76856),g=i(95155);let _=(0,m.A)((0,g.jsx)("path",{d:"M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"}),"NavigateBefore"),f=(0,m.A)((0,g.jsx)("path",{d:"M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}),"NavigateNext");var v=i(62976),y=i(35881),b=i(74409),S=i(82700);let w=(e,t)=>{let{ownerState:i}=e;return[t.root,t[i.variant],t["size".concat((0,d.A)(i.size))],"text"===i.variant&&t["text".concat((0,d.A)(i.color))],"outlined"===i.variant&&t["outlined".concat((0,d.A)(i.color))],"rounded"===i.shape&&t.rounded,"page"===i.type&&t.page,("start-ellipsis"===i.type||"end-ellipsis"===i.type)&&t.ellipsis,("previous"===i.type||"next"===i.type)&&t.previousNext,("first"===i.type||"last"===i.type)&&t.firstLast]},C=e=>{let{classes:t,color:i,disabled:s,selected:n,size:r,shape:a,type:c,variant:h}=e,u={root:["root","size".concat((0,d.A)(r)),h,a,"standard"!==i&&"color".concat((0,d.A)(i)),"standard"!==i&&"".concat(h).concat((0,d.A)(i)),s&&"disabled",n&&"selected",{page:"page",first:"firstLast",last:"firstLast","start-ellipsis":"ellipsis","end-ellipsis":"ellipsis",previous:"previousNext",next:"previousNext"}[c]],icon:["icon"]};return(0,o.A)(u,l.q,t)},x=(0,y.default)("div",{name:"MuiPaginationItem",slot:"Root",overridesResolver:w})((0,b.A)(e=>{let{theme:t}=e;return{...t.typography.body2,borderRadius:16,textAlign:"center",boxSizing:"border-box",minWidth:32,padding:"0 6px",margin:"0 3px",color:(t.vars||t).palette.text.primary,height:"auto",["&.".concat(l.A.disabled)]:{opacity:(t.vars||t).palette.action.disabledOpacity},variants:[{props:{size:"small"},style:{minWidth:26,borderRadius:13,margin:"0 1px",padding:"0 4px"}},{props:{size:"large"},style:{minWidth:40,borderRadius:20,padding:"0 10px",fontSize:t.typography.pxToRem(15)}}]}})),T=(0,y.default)(c.A,{name:"MuiPaginationItem",slot:"Root",overridesResolver:w})((0,b.A)(e=>{let{theme:t}=e;return{...t.typography.body2,borderRadius:16,textAlign:"center",boxSizing:"border-box",minWidth:32,height:32,padding:"0 6px",margin:"0 3px",color:(t.vars||t).palette.text.primary,["&.".concat(l.A.focusVisible)]:{backgroundColor:(t.vars||t).palette.action.focus},["&.".concat(l.A.disabled)]:{opacity:(t.vars||t).palette.action.disabledOpacity},transition:t.transitions.create(["color","background-color"],{duration:t.transitions.duration.short}),"&:hover":{backgroundColor:(t.vars||t).palette.action.hover,"@media (hover: none)":{backgroundColor:"transparent"}},["&.".concat(l.A.selected)]:{backgroundColor:(t.vars||t).palette.action.selected,"&:hover":{backgroundColor:t.vars?"rgba(".concat(t.vars.palette.action.selectedChannel," / calc(").concat(t.vars.palette.action.selectedOpacity," + ").concat(t.vars.palette.action.hoverOpacity,"))"):(0,r.X4)(t.palette.action.selected,t.palette.action.selectedOpacity+t.palette.action.hoverOpacity),"@media (hover: none)":{backgroundColor:(t.vars||t).palette.action.selected}},["&.".concat(l.A.focusVisible)]:{backgroundColor:t.vars?"rgba(".concat(t.vars.palette.action.selectedChannel," / calc(").concat(t.vars.palette.action.selectedOpacity," + ").concat(t.vars.palette.action.focusOpacity,"))"):(0,r.X4)(t.palette.action.selected,t.palette.action.selectedOpacity+t.palette.action.focusOpacity)},["&.".concat(l.A.disabled)]:{opacity:1,color:(t.vars||t).palette.action.disabled,backgroundColor:(t.vars||t).palette.action.selected}},variants:[{props:{size:"small"},style:{minWidth:26,height:26,borderRadius:13,margin:"0 1px",padding:"0 4px"}},{props:{size:"large"},style:{minWidth:40,height:40,borderRadius:20,padding:"0 10px",fontSize:t.typography.pxToRem(15)}},{props:{shape:"rounded"},style:{borderRadius:(t.vars||t).shape.borderRadius}},{props:{variant:"outlined"},style:{border:t.vars?"1px solid rgba(".concat(t.vars.palette.common.onBackgroundChannel," / 0.23)"):"1px solid ".concat("light"===t.palette.mode?"rgba(0, 0, 0, 0.23)":"rgba(255, 255, 255, 0.23)"),["&.".concat(l.A.selected)]:{["&.".concat(l.A.disabled)]:{borderColor:(t.vars||t).palette.action.disabledBackground,color:(t.vars||t).palette.action.disabled}}}},{props:{variant:"text"},style:{["&.".concat(l.A.selected)]:{["&.".concat(l.A.disabled)]:{color:(t.vars||t).palette.action.disabled}}}},...Object.entries(t.palette).filter((0,h.A)(["dark","contrastText"])).map(e=>{let[i]=e;return{props:{variant:"text",color:i},style:{["&.".concat(l.A.selected)]:{color:(t.vars||t).palette[i].contrastText,backgroundColor:(t.vars||t).palette[i].main,"&:hover":{backgroundColor:(t.vars||t).palette[i].dark,"@media (hover: none)":{backgroundColor:(t.vars||t).palette[i].main}},["&.".concat(l.A.focusVisible)]:{backgroundColor:(t.vars||t).palette[i].dark},["&.".concat(l.A.disabled)]:{color:(t.vars||t).palette.action.disabled}}}}}),...Object.entries(t.palette).filter((0,h.A)(["light"])).map(e=>{let[i]=e;return{props:{variant:"outlined",color:i},style:{["&.".concat(l.A.selected)]:{color:(t.vars||t).palette[i].main,border:"1px solid ".concat(t.vars?"rgba(".concat(t.vars.palette[i].mainChannel," / 0.5)"):(0,r.X4)(t.palette[i].main,.5)),backgroundColor:t.vars?"rgba(".concat(t.vars.palette[i].mainChannel," / ").concat(t.vars.palette.action.activatedOpacity,")"):(0,r.X4)(t.palette[i].main,t.palette.action.activatedOpacity),"&:hover":{backgroundColor:t.vars?"rgba(".concat(t.vars.palette[i].mainChannel," / calc(").concat(t.vars.palette.action.activatedOpacity," + ").concat(t.vars.palette.action.focusOpacity,"))"):(0,r.X4)(t.palette[i].main,t.palette.action.activatedOpacity+t.palette.action.focusOpacity),"@media (hover: none)":{backgroundColor:"transparent"}},["&.".concat(l.A.focusVisible)]:{backgroundColor:t.vars?"rgba(".concat(t.vars.palette[i].mainChannel," / calc(").concat(t.vars.palette.action.activatedOpacity," + ").concat(t.vars.palette.action.focusOpacity,"))"):(0,r.X4)(t.palette[i].main,t.palette.action.activatedOpacity+t.palette.action.focusOpacity)}}}}})]}})),k=(0,y.default)("div",{name:"MuiPaginationItem",slot:"Icon",overridesResolver:(e,t)=>t.icon})((0,b.A)(e=>{let{theme:t}=e;return{fontSize:t.typography.pxToRem(20),margin:"0 -8px",variants:[{props:{size:"small"},style:{fontSize:t.typography.pxToRem(18)}},{props:{size:"large"},style:{fontSize:t.typography.pxToRem(22)}}]}})),E=s.forwardRef(function(e,t){var i,s,o,r;let l=(0,S.b)({props:e,name:"MuiPaginationItem"}),{className:c,color:d="standard",component:h,components:m={},disabled:y=!1,page:b,selected:w=!1,shape:E="circular",size:I="medium",slots:A={},slotProps:P={},type:D="page",variant:R="text",...O}=l,M={...l,color:d,disabled:y,selected:w,shape:E,size:I,type:D,variant:R},L=(0,a.useRtl)(),j=C(M),$={slots:{previous:null!=(i=A.previous)?i:m.previous,next:null!=(s=A.next)?s:m.next,first:null!=(o=A.first)?o:m.first,last:null!=(r=A.last)?r:m.last},slotProps:P},[N,F]=(0,v.A)("previous",{elementType:_,externalForwardedProps:$,ownerState:M}),[U,H]=(0,v.A)("next",{elementType:f,externalForwardedProps:$,ownerState:M}),[W,V]=(0,v.A)("first",{elementType:u.A,externalForwardedProps:$,ownerState:M}),[B,z]=(0,v.A)("last",{elementType:p.A,externalForwardedProps:$,ownerState:M}),q=L?({previous:"next",next:"previous",first:"last",last:"first"})[D]:D,G={previous:N,next:U,first:W,last:B}[q],J={previous:F,next:H,first:V,last:z}[q];return"start-ellipsis"===D||"end-ellipsis"===D?(0,g.jsx)(x,{ref:t,ownerState:M,className:(0,n.A)(j.root,c),children:"â€¦"}):(0,g.jsxs)(T,{ref:t,ownerState:M,component:h,disabled:y,className:(0,n.A)(j.root,c),...O,children:["page"===D&&b,G?(0,g.jsx)(k,{...J,className:j.icon,as:G}):null]})})},6270:(e,t,i)=>{"use strict";i.d(t,{b:()=>f});var s=i(79630),n=i(93495);i(12115);var o=i(52596),r=i(54750),a=i(51816),l=i(31086),c=i(24452),d=i(26096),h=i(6358),u=i(51792),p=i(95155);let m=["className","children"],g=e=>{let{classes:t}=e;return(0,a.A)({root:["toolbarContainer"]},d.B,t)},_=(0,r.A)(u.M,{name:"MuiDataGrid",slot:"ToolbarContainer",shouldForwardProp:e=>"ownerState"!==e})({display:"flex",alignItems:"center",flexWrap:"wrap",gap:c.f.spacing(1),padding:c.f.spacing(.5),minHeight:"auto"}),f=(0,l.R)(function(e,t){let{className:i,children:r}=e,a=(0,n.A)(e,m),l=(0,h.A)(),c=g(l);return r?(0,p.jsx)(_,(0,s.A)({className:(0,o.A)(c.root,i),ownerState:l},a,{ref:t,children:r})):null})},6722:(e,t,i)=>{"use strict";i.d(t,{A:()=>v});var s=i(12115),n=i(52596),o=i(15386),r=i(57692),a=i(81112);function l(e){return(0,a.Ay)("MuiPagination",e)}(0,r.A)("MuiPagination",["root","ul","outlined","text"]);var c=i(55492),d=i(1318),h=i(35881),u=i(82700),p=i(95155);let m=e=>{let{classes:t,variant:i}=e;return(0,o.A)({root:["root",i],ul:["ul"]},l,t)},g=(0,h.default)("nav",{name:"MuiPagination",slot:"Root",overridesResolver:(e,t)=>{let{ownerState:i}=e;return[t.root,t[i.variant]]}})({}),_=(0,h.default)("ul",{name:"MuiPagination",slot:"Ul",overridesResolver:(e,t)=>t.ul})({display:"flex",flexWrap:"wrap",alignItems:"center",padding:0,margin:0,listStyle:"none"});function f(e,t,i){return"page"===e?"".concat(i?"":"Go to ","page ").concat(t):"Go to ".concat(e," page")}let v=s.forwardRef(function(e,t){let i=(0,u.b)({props:e,name:"MuiPagination"}),{boundaryCount:s=1,className:o,color:r="standard",count:a=1,defaultPage:l=1,disabled:h=!1,getItemAriaLabel:v=f,hideNextButton:y=!1,hidePrevButton:b=!1,onChange:S,page:w,renderItem:C=e=>(0,p.jsx)(d.default,{...e}),shape:x="circular",showFirstButton:T=!1,showLastButton:k=!1,siblingCount:E=1,size:I="medium",variant:A="text",...P}=i,{items:D}=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{boundaryCount:t=1,componentName:i="usePagination",count:s=1,defaultPage:n=1,disabled:o=!1,hideNextButton:r=!1,hidePrevButton:a=!1,onChange:l,page:d,showFirstButton:h=!1,showLastButton:u=!1,siblingCount:p=1,...m}=e,[g,_]=(0,c.A)({controlled:d,default:n,name:i,state:"page"}),f=(e,t)=>{d||_(t),l&&l(e,t)},v=(e,t)=>Array.from({length:t-e+1},(t,i)=>e+i),y=v(1,Math.min(t,s)),b=v(Math.max(s-t+1,t+1),s),S=Math.max(Math.min(g-p,s-t-2*p-1),t+2),w=Math.min(Math.max(g+p,t+2*p+2),s-t-1),C=[...h?["first"]:[],...a?[]:["previous"],...y,...S>t+2?["start-ellipsis"]:t+1<s-t?[t+1]:[],...v(S,w),...w<s-t-1?["end-ellipsis"]:s-t>t?[s-t]:[],...b,...r?[]:["next"],...u?["last"]:[]],x=e=>{switch(e){case"first":return 1;case"previous":return g-1;case"next":return g+1;case"last":return s;default:return null}};return{items:C.map(e=>"number"==typeof e?{onClick:t=>{f(t,e)},type:"page",page:e,selected:e===g,disabled:o,"aria-current":e===g?"page":void 0}:{onClick:t=>{f(t,x(e))},type:e,page:x(e),selected:!1,disabled:o||!e.includes("ellipsis")&&("next"===e||"last"===e?g>=s:g<=1)}),...m}}({...i,componentName:"Pagination"}),R={...i,boundaryCount:s,color:r,count:a,defaultPage:l,disabled:h,getItemAriaLabel:v,hideNextButton:y,hidePrevButton:b,renderItem:C,shape:x,showFirstButton:T,showLastButton:k,siblingCount:E,size:I,variant:A},O=m(R);return(0,p.jsx)(g,{"aria-label":"pagination navigation",className:(0,n.A)(O.root,o),ownerState:R,ref:t,...P,children:(0,p.jsx)(_,{className:O.ul,ownerState:R,children:D.map((e,t)=>(0,p.jsx)("li",{children:C({...e,color:r,"aria-label":v(e.type,e.page,e.selected),shape:x,size:I,variant:A})},t))})})})},20033:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var s=i(76856),n=i(95155);let o=(0,s.A)((0,n.jsx)("path",{d:"M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2M9 11H7V9h2zm4 0h-2V9h2zm4 0h-2V9h2z"}),"Sms")},37070:(e,t,i)=>{"use strict";i.d(t,{pF:()=>eG});var s,n,o,r,a,l,c,d,h,u,p,m,g={};i.r(g),i.d(g,{Exception:()=>G,average:()=>j,difference:()=>$,flatMap:()=>B,isChrome:()=>F,isElectron:()=>N,isFirefox:()=>U,isLegacyEdge:()=>H,isSafari:()=>W,promisifyEvents:()=>z,queryToJson:()=>V,sortByMimeTypes:()=>q});var _=i(40662);class f extends _.EventEmitter{constructor(e){super(),Object.defineProperties(this,{_attempts:{value:0,writable:!0},_duration:{enumerable:!1,get(){let e=this._min*Math.pow(this._factor,this._attempts);if(this._jitter){let t=Math.random(),i=Math.floor(t*this._jitter*e);e=(1&Math.floor(10*t))==0?e-i:e+i}return 0|Math.min(e,this._max)}},_factor:{value:e.factor||2},_jitter:{value:e.jitter>0&&e.jitter<=1?e.jitter:0},_max:{value:e.max||1e4},_min:{value:e.min||100},_timeoutID:{value:null,writable:!0}})}backoff(){let e=this._duration;this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=null),this.emit("backoff",this._attempts,e),this._timeoutID=setTimeout(()=>{this.emit("ready",this._attempts,e),this._attempts++},e)}reset(){this._attempts=0,this._timeoutID&&(clearTimeout(this._timeoutID),this._timeoutID=null)}}var v=i(39249),y=i(61584);class b extends Error{constructor(e,t){super(),Object.setPrototypeOf(this,b.prototype);let i="string"==typeof e?e:this.explanation;this.message=`${this.name} (${this.code}): ${i}`,this.originalError="object"==typeof e?e:t}}!function(e){class t extends b{constructor(t,i){super(t,i),this.causes=[],this.code=20101,this.description="Invalid access token",this.explanation="Twilio was unable to validate your Access Token",this.name="AccessTokenInvalid",this.solutions=[],Object.setPrototypeOf(this,e.AccessTokenInvalid.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.AccessTokenInvalid=t;class i extends b{constructor(t,i){super(t,i),this.causes=[],this.code=20104,this.description="Access token expired or expiration date invalid",this.explanation="The Access Token provided to the Twilio API has expired, the expiration time specified in the token was invalid, or the expiration time specified was too far in the future",this.name="AccessTokenExpired",this.solutions=[],Object.setPrototypeOf(this,e.AccessTokenExpired.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.AccessTokenExpired=i;class s extends b{constructor(t,i){super(t,i),this.causes=[],this.code=20151,this.description="Authentication Failed",this.explanation="The Authentication with the provided JWT failed",this.name="AuthenticationFailed",this.solutions=[],Object.setPrototypeOf(this,e.AuthenticationFailed.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.AuthenticationFailed=s}(s||(s={})),function(e){class t extends b{constructor(t,i){super(t,i),this.causes=["The access token has an invalid Account SID, API Key, or API Key Secret."],this.code=31202,this.description="Signature validation failed.",this.explanation="The provided access token failed signature validation.",this.name="AccessTokenSignatureValidationFailed",this.solutions=["Ensure the Account SID, API Key, and API Key Secret are valid when generating your access token."],Object.setPrototypeOf(this,e.AccessTokenSignatureValidationFailed.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.AccessTokenSignatureValidationFailed=t}(n||(n={})),function(e){class t extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31400,this.description="Bad Request (HTTP/SIP)",this.explanation="The request could not be understood due to malformed syntax.",this.name="BadRequest",this.solutions=[],Object.setPrototypeOf(this,e.BadRequest.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.BadRequest=t;class i extends b{constructor(t,i){super(t,i),this.causes=["The outbound call was made to an invalid phone number.","The TwiML application sid is missing a Voice URL."],this.code=31404,this.description="Not Found (HTTP/SIP)",this.explanation="The server has not found anything matching the request.",this.name="NotFound",this.solutions=["Ensure the phone number dialed is valid.","Ensure the TwiML application is configured correctly with a Voice URL link."],Object.setPrototypeOf(this,e.NotFound.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.NotFound=i;class s extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31480,this.description="Temporarily Unavailable (SIP)",this.explanation="The callee is currently unavailable.",this.name="TemporarilyUnavailable",this.solutions=[],Object.setPrototypeOf(this,e.TemporarilyUnavailable.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.TemporarilyUnavailable=s;class n extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31486,this.description="Busy Here (SIP)",this.explanation="The callee is busy.",this.name="BusyHere",this.solutions=[],Object.setPrototypeOf(this,e.BusyHere.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.BusyHere=n}(o||(o={})),function(e){class t extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31603,this.description="Decline (SIP)",this.explanation="The callee does not wish to participate in the call.",this.name="Decline",this.solutions=[],Object.setPrototypeOf(this,e.Decline.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.Decline=t}(r||(r={})),function(e){class t extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31e3,this.description="Unknown Error",this.explanation="An unknown error has occurred. See error details for more information.",this.name="UnknownError",this.solutions=[],Object.setPrototypeOf(this,e.UnknownError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.UnknownError=t;class i extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31001,this.description="Application Not Found",this.explanation="",this.name="ApplicationNotFoundError",this.solutions=[],Object.setPrototypeOf(this,e.ApplicationNotFoundError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.ApplicationNotFoundError=i;class s extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31002,this.description="Connection Declined",this.explanation="",this.name="ConnectionDeclinedError",this.solutions=[],Object.setPrototypeOf(this,e.ConnectionDeclinedError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.ConnectionDeclinedError=s;class n extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31003,this.description="Connection Timeout",this.explanation="The server could not produce a response within a suitable amount of time.",this.name="ConnectionTimeoutError",this.solutions=[],Object.setPrototypeOf(this,e.ConnectionTimeoutError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.ConnectionTimeoutError=n;class o extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31005,this.description="Connection error",this.explanation="A connection error occurred during the call",this.name="ConnectionError",this.solutions=[],Object.setPrototypeOf(this,e.ConnectionError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.ConnectionError=o;class r extends b{constructor(t,i){super(t,i),this.causes=["The incoming call was cancelled because it was not answered in time or it was accepted/rejected by another application instance registered with the same identity."],this.code=31008,this.description="Call cancelled",this.explanation="Unable to answer because the call has ended",this.name="CallCancelledError",this.solutions=[],Object.setPrototypeOf(this,e.CallCancelledError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.CallCancelledError=r;class a extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31009,this.description="Transport error",this.explanation="No transport available to send or receive messages",this.name="TransportError",this.solutions=[],Object.setPrototypeOf(this,e.TransportError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.TransportError=a}(a||(a={})),function(e){class t extends b{constructor(t,i){super(t,i),this.causes=["Invalid content or MessageType passed to sendMessage method."],this.code=31100,this.description="The request had malformed syntax.",this.explanation="The request could not be understood due to malformed syntax.",this.name="MalformedRequestError",this.solutions=["Ensure content and MessageType passed to sendMessage method are valid."],Object.setPrototypeOf(this,e.MalformedRequestError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.MalformedRequestError=t;class i extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31101,this.description="Missing parameter array in request",this.explanation="",this.name="MissingParameterArrayError",this.solutions=[],Object.setPrototypeOf(this,e.MissingParameterArrayError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.MissingParameterArrayError=i;class s extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31102,this.description="Authorization token missing in request.",this.explanation="",this.name="AuthorizationTokenMissingError",this.solutions=[],Object.setPrototypeOf(this,e.AuthorizationTokenMissingError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.AuthorizationTokenMissingError=s;class n extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31103,this.description="Maximum parameter length has been exceeded.",this.explanation="Length of parameters cannot exceed MAX_PARAM_LENGTH.",this.name="MaxParameterLengthExceededError",this.solutions=[],Object.setPrototypeOf(this,e.MaxParameterLengthExceededError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.MaxParameterLengthExceededError=n;class o extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31104,this.description="Invalid bridge token",this.explanation="",this.name="InvalidBridgeTokenError",this.solutions=[],Object.setPrototypeOf(this,e.InvalidBridgeTokenError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.InvalidBridgeTokenError=o;class r extends b{constructor(t,i){super(t,i),this.causes=["Client name contains invalid characters."],this.code=31105,this.description="Invalid client name",this.explanation="Client name should not contain control, space, delims, or unwise characters.",this.name="InvalidClientNameError",this.solutions=["Make sure that client name does not contain any of the invalid characters."],Object.setPrototypeOf(this,e.InvalidClientNameError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.InvalidClientNameError=r;class a extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31107,this.description="The reconnect parameter is invalid",this.explanation="",this.name="ReconnectParameterInvalidError",this.solutions=[],Object.setPrototypeOf(this,e.ReconnectParameterInvalidError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.ReconnectParameterInvalidError=a}(l||(l={})),function(e){class t extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31201,this.description="Authorization error",this.explanation="The request requires user authentication. The server understood the request, but is refusing to fulfill it.",this.name="AuthorizationError",this.solutions=[],Object.setPrototypeOf(this,e.AuthorizationError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.AuthorizationError=t;class i extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31203,this.description="No valid account",this.explanation="",this.name="NoValidAccountError",this.solutions=[],Object.setPrototypeOf(this,e.NoValidAccountError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.NoValidAccountError=i;class s extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31204,this.description="Invalid JWT token",this.explanation="",this.name="InvalidJWTTokenError",this.solutions=[],Object.setPrototypeOf(this,e.InvalidJWTTokenError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.InvalidJWTTokenError=s;class n extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31205,this.description="JWT token expired",this.explanation="",this.name="JWTTokenExpiredError",this.solutions=[],Object.setPrototypeOf(this,e.JWTTokenExpiredError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.JWTTokenExpiredError=n;class o extends b{constructor(t,i){super(t,i),this.causes=["Rate limit exceeded."],this.code=31206,this.description="Rate exceeded authorized limit.",this.explanation="The request performed exceeds the authorized limit.",this.name="RateExceededError",this.solutions=["Ensure message send rate does not exceed authorized limits."],Object.setPrototypeOf(this,e.RateExceededError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.RateExceededError=o;class r extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31207,this.description="JWT token expiration too long",this.explanation="",this.name="JWTTokenExpirationTooLongError",this.solutions=[],Object.setPrototypeOf(this,e.JWTTokenExpirationTooLongError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.JWTTokenExpirationTooLongError=r;class a extends b{constructor(t,i){super(t,i),this.causes=[],this.code=31209,this.description="Reconnect attempt is not authorized.",this.explanation="",this.name="ReconnectAttemptError",this.solutions=[],Object.setPrototypeOf(this,e.ReconnectAttemptError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.ReconnectAttemptError=a;class l extends b{constructor(t,i){super(t,i),this.causes=["The Call Message Event Type is invalid and is not understood by Twilio Voice."],this.code=31210,this.description="Call Message Event Type is invalid.",this.explanation="The Call Message Event Type is invalid and is not understood by Twilio Voice.",this.name="CallMessageEventTypeInvalidError",this.solutions=["Ensure the Call Message Event Type is Valid and understood by Twilio Voice and try again."],Object.setPrototypeOf(this,e.CallMessageEventTypeInvalidError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.CallMessageEventTypeInvalidError=l;class c extends b{constructor(t,i){super(t,i),this.causes=["The payload size of Call Message Event exceeds the authorized limit."],this.code=31212,this.description="Call Message Event Payload size exceeded authorized limit.",this.explanation="The request performed to send a Call Message Event exceeds the payload size authorized limit",this.name="PayloadSizeExceededError",this.solutions=["Reduce payload size of Call Message Event to be within the authorized limit and try again."],Object.setPrototypeOf(this,e.PayloadSizeExceededError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.PayloadSizeExceededError=c}(s||(s={})),function(e){class t extends b{constructor(t,i){super(t,i),this.causes=["The user denied the getUserMedia request.","The browser denied the getUserMedia request."],this.code=31401,this.description="UserMedia Permission Denied Error",this.explanation="The browser or end-user denied permissions to user media. Therefore we were unable to acquire input audio.",this.name="PermissionDeniedError",this.solutions=["The user should accept the request next time prompted. If the browser saved the deny, the user should change that permission in their browser.","The user should to verify that the browser has permission to access the microphone at this address."],Object.setPrototypeOf(this,e.PermissionDeniedError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.PermissionDeniedError=t;class i extends b{constructor(t,i){super(t,i),this.causes=["NotFoundError - The deviceID specified was not found.","The getUserMedia constraints were overconstrained and no devices matched."],this.code=31402,this.description="UserMedia Acquisition Failed Error",this.explanation="The browser and end-user allowed permissions, however getting the media failed. Usually this is due to bad constraints, but can sometimes fail due to browser, OS or hardware issues.",this.name="AcquisitionFailedError",this.solutions=["Ensure the deviceID being specified exists.","Try acquiring media with fewer constraints."],Object.setPrototypeOf(this,e.AcquisitionFailedError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.AcquisitionFailedError=i}(c||(c={})),function(e){class t extends b{constructor(t,i){super(t,i),this.causes=[],this.code=53e3,this.description="Signaling connection error",this.explanation="Raised whenever a signaling connection error occurs that is not covered by a more specific error code.",this.name="ConnectionError",this.solutions=[],Object.setPrototypeOf(this,e.ConnectionError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.ConnectionError=t;class i extends b{constructor(t,i){super(t,i),this.causes=["The device running your application lost its Internet connection."],this.code=53001,this.description="Signaling connection disconnected",this.explanation="Raised whenever the signaling connection is unexpectedly disconnected.",this.name="ConnectionDisconnected",this.solutions=["Ensure the device running your application has access to a stable Internet connection."],Object.setPrototypeOf(this,e.ConnectionDisconnected.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.ConnectionDisconnected=i}(d||(d={})),function(e){class t extends b{constructor(t,i){super(t,i),this.causes=["The Client may not be using a supported WebRTC implementation.","The Client may not have the necessary resources to create or apply a new media description."],this.code=53400,this.description="Client is unable to create or apply a local media description",this.explanation="Raised whenever a Client is unable to create or apply a local media description.",this.name="ClientLocalDescFailed",this.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation."],Object.setPrototypeOf(this,e.ClientLocalDescFailed.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.ClientLocalDescFailed=t;class i extends b{constructor(t,i){super(t,i),this.causes=["The Client may not be using a supported WebRTC implementation.","The Client may be connecting peer-to-peer with another Participant that is not using a supported WebRTC implementation.","The Client may not have the necessary resources to apply a new media description."],this.code=53402,this.description="Client is unable to apply a remote media description",this.explanation="Raised whenever the Client receives a remote media description but is unable to apply it.",this.name="ClientRemoteDescFailed",this.solutions=["If you are experiencing this error using the JavaScript SDK, ensure you are running it with a supported WebRTC implementation."],Object.setPrototypeOf(this,e.ClientRemoteDescFailed.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.ClientRemoteDescFailed=i;class s extends b{constructor(t,i){super(t,i),this.causes=["The Client was unable to establish a media connection.","A media connection which was active failed liveliness checks."],this.code=53405,this.description="Media connection failed",this.explanation="Raised by the Client or Server whenever a media connection fails.",this.name="ConnectionError",this.solutions=["If the problem persists, try connecting to another region.","Check your Client's network connectivity.","If you've provided custom ICE Servers then ensure that the URLs and credentials are valid."],Object.setPrototypeOf(this,e.ConnectionError.prototype);let s="string"==typeof t?t:this.explanation,n="object"==typeof t?t:i;this.message=`${this.name} (${this.code}): ${s}`,this.originalError=n}}e.ConnectionError=s}(h||(h={}));let S=new Map([[20101,s.AccessTokenInvalid],[20104,s.AccessTokenExpired],[20151,s.AuthenticationFailed],[31202,n.AccessTokenSignatureValidationFailed],[31400,o.BadRequest],[31404,o.NotFound],[31480,o.TemporarilyUnavailable],[31486,o.BusyHere],[31603,r.Decline],[31e3,a.UnknownError],[31001,a.ApplicationNotFoundError],[31002,a.ConnectionDeclinedError],[31003,a.ConnectionTimeoutError],[31005,a.ConnectionError],[31008,a.CallCancelledError],[31009,a.TransportError],[31100,l.MalformedRequestError],[31101,l.MissingParameterArrayError],[31102,l.AuthorizationTokenMissingError],[31103,l.MaxParameterLengthExceededError],[31104,l.InvalidBridgeTokenError],[31105,l.InvalidClientNameError],[31107,l.ReconnectParameterInvalidError],[31201,s.AuthorizationError],[31203,s.NoValidAccountError],[31204,s.InvalidJWTTokenError],[31205,s.JWTTokenExpiredError],[31206,s.RateExceededError],[31207,s.JWTTokenExpirationTooLongError],[31209,s.ReconnectAttemptError],[31210,s.CallMessageEventTypeInvalidError],[31212,s.PayloadSizeExceededError],[31401,c.PermissionDeniedError],[31402,c.AcquisitionFailedError],[53e3,d.ConnectionError],[53001,d.ConnectionDisconnected],[53400,h.ClientLocalDescFailed],[53402,h.ClientRemoteDescFailed],[53405,h.ConnectionError]]);Object.freeze(S);let w=new Set([31001,31002,31003,31101,31102,31103,31104,31105,31107,31201,31202,31203,31204,31205,31207,31404,31480,31486,31603]);function C(e,t){var i;if("number"==typeof t&&(i=t,S.has(i))&&(e||!w.has(t))){var s=t;let e=S.get(s);if(!e)throw new x(`Error code ${s} not found`);return e}}class x extends Error{constructor(e){super(e),this.name="InvalidArgumentError"}}class T extends Error{constructor(e){super(e),this.name="InvalidStateError"}}class k extends Error{constructor(e){super(e),this.name="NotSupportedError"}}let E="@twilio/voice-sdk",I="2.16.0",A="https://sdk.twilio.com/js/client/sounds/releases/1.0.0",P=`${A}/cowbell.mp3?cache=${I}`;class D{static getLogLevelInstance(e){if(!D.loglevelInstance)try{D.loglevelInstance=(e&&e.LogLevelModule?e.LogLevelModule:y).getLogger(E)}catch(e){console.warn("Cannot create custom logger"),D.loglevelInstance=console}return D.loglevelInstance}constructor(e,t){this._log=D.getLogLevelInstance(t),this._prefix=`[TwilioVoice][${e}]`}debug(...e){this._log.debug(this._prefix,...e)}error(...e){this._log.error(this._prefix,...e)}info(...e){this._log.info(this._prefix,...e)}setDefaultLevel(e){this._log.setDefaultLevel?this._log.setDefaultLevel(e):console.warn("Logger cannot setDefaultLevel")}warn(...e){this._log.warn(this._prefix,...e)}}D.levels=y.levels,D.getLogLevelInstance();let R=`${A}/outgoing.mp3`;class O{constructor(e,t,i,s){this._name=e,this._availableDevices=t,this._beforeChange=i,this._isSupported=s,this._activeDevices=new Set,this._log=new D("OutputDeviceCollection")}delete(e){this._log.debug(".delete",e);let t=!!this._activeDevices.delete(e),i=this._availableDevices.get("default")||Array.from(this._availableDevices.values())[0];!this._activeDevices.size&&i&&this._activeDevices.add(i);let s=Array.from(this._activeDevices.values()).map(e=>e.deviceId);return this._beforeChange(this._name,s),!!t}get(){return this._activeDevices}set(e){if(this._log.debug(".set",e),!this._isSupported)return Promise.reject(new k("This browser does not support audio output selection"));let t=Array.isArray(e)?e:[e];if(!t.length)return Promise.reject(new x("Must specify at least one device to set"));let i=[],s=t.map(e=>{let t=this._availableDevices.get(e);return t||i.push(e),t});return i.length?Promise.reject(new x(`Devices not found: ${i.join(", ")}`)):new Promise(e=>{e(this._beforeChange(this._name,t))}).then(()=>{this._activeDevices.clear(),s.forEach(this._activeDevices.add,this._activeDevices)})}test(e=R){return this._isSupported?this._activeDevices.size?Promise.all(Array.from(this._activeDevices).map(t=>{let i;return new Promise(t=>{(i=new Audio(e)).oncanplay=t}).then(()=>i.setSinkId(t.deviceId).then(()=>i.play()))})):Promise.reject(new T("No active output devices to test")):Promise.reject(new k("This browser does not support audio output selection"))}}class M{constructor(e){Object.defineProperties(this,{deviceId:{get:()=>e.deviceId},groupId:{get:()=>e.groupId},kind:{get:()=>e.kind},label:{get:()=>e.label}})}}function L(e){if(!(this instanceof L))return new L(e);this.message=e}function j(e){return e&&e.length?e.reduce((e,t)=>e+t)/e.length:0}function $(e,t,i){i=i||(e=>e);let s=new Set(t.map(i));return e.filter(e=>!s.has(i(e)))}function N(e){return!!e.userAgent.match("Electron")}function F(e,t){let i=!!t.userAgent.match("CriOS"),s=!!t.userAgent.match("HeadlessChrome"),n=void 0!==e.chrome&&"Google Inc."===t.vendor&&-1===t.userAgent.indexOf("OPR")&&-1===t.userAgent.indexOf("Edge");return i||N(t)||n||s}function U(e){return!!(e=e||("undefined"==typeof window?i.g.navigator:window.navigator))&&"string"==typeof e.userAgent&&/firefox|fxios/i.test(e.userAgent)}function H(e){return!!(e=e||("undefined"==typeof window?i.g.navigator:window.navigator))&&"string"==typeof e.userAgent&&/edge\/\d+/i.test(e.userAgent)}function W(e){return!!e.vendor&&-1!==e.vendor.indexOf("Apple")&&e.userAgent&&-1===e.userAgent.indexOf("CriOS")&&-1===e.userAgent.indexOf("FxiOS")}function V(e){return e?e.split("&").reduce((e,t)=>{let i=t.split("="),s=i[0],n=decodeURIComponent((i[1]||"").replace(/\+/g,"%20"));return s&&(e[s]=n),e},{}):""}function B(e,t){let i=e instanceof Map||e instanceof Set?Array.from(e.values()):e;return t=t||(e=>e),i.reduce((e,i)=>{let s=t(i);return e.concat(s)},[])}function z(e,t,i){return new Promise((s,n)=>{function o(){e.removeListener(i,r),s()}function r(){e.removeListener(t,o),n()}e.once(t,o),e.once(i,r)})}function q(e,t){let i=t.map(e=>"audio/"+e.toLowerCase());return e.sort((e,t)=>{let s=i.indexOf(e.mimeType.toLowerCase()),n=i.indexOf(t.mimeType.toLowerCase());return(s>=0?s:Number.MAX_VALUE)-(n>=0?n:Number.MAX_VALUE)})}L.prototype.toString=function(){return`Twilio.Exception: ${this.message}`};let G=L,J={audioinput:"Audio Input",audiooutput:"Audio Output"};class Q extends _.EventEmitter{get audioConstraints(){return this._audioConstraints}get inputDevice(){return this._inputDevice}get inputStream(){return this._processedStream||this._selectedInputDeviceStream}get processedStream(){return this._processedStream}constructor(e,t,i){super(),this.availableInputDevices=new Map,this.availableOutputDevices=new Map,this._audioConstraints=null,this._defaultInputDeviceStream=null,this._enabledSounds={[eG.SoundName.Disconnect]:!0,[eG.SoundName.Incoming]:!0,[eG.SoundName.Outgoing]:!0},this._inputDevice=null,this._inputDevicePromise=null,this._isPollingInputVolume=!1,this._log=new D("AudioHelper"),this._processedStream=null,this._selectedInputDeviceStream=null,this._unknownDeviceIndexes={audioinput:{},audiooutput:{}},this._updateAvailableDevices=()=>this._mediaDevices&&this._enumerateDevices?this._enumerateDevices().then(e=>{this._updateDevices(e.filter(e=>"audiooutput"===e.kind),this.availableOutputDevices,this._removeLostOutput),this._updateDevices(e.filter(e=>"audioinput"===e.kind),this.availableInputDevices,this._removeLostInput);let t=this.availableOutputDevices.get("default")||Array.from(this.availableOutputDevices.values())[0];[this.speakerDevices,this.ringtoneDevices].forEach(e=>{!e.get().size&&this.availableOutputDevices.size&&this.isOutputSelectionSupported&&e.set(t.deviceId).catch(e=>{this._log.warn(`Unable to set audio output devices. ${e}`)})})}):Promise.reject("Enumeration not supported"),this._removeLostInput=e=>{if(!this.inputDevice||this.inputDevice.deviceId!==e.deviceId)return!1;this._destroyProcessedStream(),this._replaceStream(null),this._inputDevice=null,this._maybeStopPollingVolume();let t=this.availableInputDevices.get("default")||Array.from(this.availableInputDevices.values())[0];return t&&this.setInputDevice(t.deviceId),!0},this._removeLostOutput=e=>{let t=this.speakerDevices.delete(e),i=this.ringtoneDevices.delete(e);return t||i},i=Object.assign({AudioContext:"undefined"!=typeof AudioContext&&AudioContext,setSinkId:"undefined"!=typeof HTMLAudioElement&&HTMLAudioElement.prototype.setSinkId},i),this._beforeSetInputDevice=i.beforeSetInputDevice||(()=>Promise.resolve()),this._updateUserOptions(i),this._audioProcessorEventObserver=i.audioProcessorEventObserver,this._mediaDevices=i.mediaDevices||navigator.mediaDevices,this._onActiveInputChanged=t,this._enumerateDevices="function"==typeof i.enumerateDevices?i.enumerateDevices:this._mediaDevices&&this._mediaDevices.enumerateDevices.bind(this._mediaDevices);let s=!!(i.AudioContext||i.audioContext),n=!!this._enumerateDevices;i.enabledSounds&&(this._enabledSounds=i.enabledSounds);let o="function"==typeof i.setSinkId;this.isOutputSelectionSupported=n&&o,this.isVolumeSupported=s,this.isVolumeSupported&&(this._audioContext=i.audioContext||i.AudioContext&&new i.AudioContext,this._audioContext&&(this._inputVolumeAnalyser=this._audioContext.createAnalyser(),this._inputVolumeAnalyser.fftSize=32,this._inputVolumeAnalyser.smoothingTimeConstant=.3)),this.ringtoneDevices=new O("ringtone",this.availableOutputDevices,e,this.isOutputSelectionSupported),this.speakerDevices=new O("speaker",this.availableOutputDevices,e,this.isOutputSelectionSupported),this.addListener("newListener",e=>{"inputVolume"===e&&this._maybeStartPollingVolume()}),this.addListener("removeListener",e=>{"inputVolume"===e&&this._maybeStopPollingVolume()}),this.once("newListener",()=>{this.isOutputSelectionSupported||this._log.warn("Warning: This browser does not support audio output selection."),this.isVolumeSupported||this._log.warn("Warning: This browser does not support Twilio's volume indicator feature.")}),n&&this._initializeEnumeration(),navigator&&navigator.permissions&&"function"==typeof navigator.permissions.query?navigator.permissions.query({name:"microphone"}).then(e=>{if("granted"!==e.state){let t=()=>{this._updateAvailableDevices(),this._stopMicrophonePermissionListener()};e.addEventListener("change",t),this._microphonePermissionStatus=e,this._onMicrophonePermissionStatusChanged=t}}).catch(e=>this._log.warn(`Warning: unable to listen for microphone permission changes. ${e}`)):this._log.warn("Warning: current browser does not support permissions API.")}_destroy(){this._stopDefaultInputDeviceStream(),this._stopSelectedInputDeviceStream(),this._destroyProcessedStream(),this._maybeStopPollingVolume(),this.removeAllListeners(),this._stopMicrophonePermissionListener(),this._unbind()}_getInputDevicePromise(){return this._inputDevicePromise}_maybeStartPollingVolume(){if(!this.isVolumeSupported||!this.inputStream||(this._updateVolumeSource(),this._isPollingInputVolume||!this._inputVolumeAnalyser))return;let e=new Uint8Array(this._inputVolumeAnalyser.frequencyBinCount);this._isPollingInputVolume=!0;let t=()=>{if(this._isPollingInputVolume){if(this._inputVolumeAnalyser){this._inputVolumeAnalyser.getByteFrequencyData(e);let t=j(e);this.emit("inputVolume",t/255)}requestAnimationFrame(t)}};requestAnimationFrame(t)}_maybeStopPollingVolume(){this.isVolumeSupported&&(!this._isPollingInputVolume||this.inputStream&&this.listenerCount("inputVolume")||(this._inputVolumeSource&&(this._inputVolumeSource.disconnect(),delete this._inputVolumeSource),this._isPollingInputVolume=!1))}_openDefaultDeviceWithConstraints(e){return this._log.info("Opening default device with constraints",e),this._getUserMedia(e).then(e=>(this._log.info("Opened default device. Updating available devices."),this._updateAvailableDevices().catch(e=>{this._log.warn("Unable to updateAvailableDevices after gUM call",e)}),this._defaultInputDeviceStream=e,this._maybeCreateProcessedStream(e)))}_stopDefaultInputDeviceStream(){this._defaultInputDeviceStream&&(this._log.info("stopping default device stream"),this._defaultInputDeviceStream.getTracks().forEach(e=>e.stop()),this._defaultInputDeviceStream=null,this._destroyProcessedStream())}_unbind(){var e;(null==(e=this._mediaDevices)?void 0:e.removeEventListener)&&this._mediaDevices.removeEventListener("devicechange",this._updateAvailableDevices)}_updateUserOptions(e){"function"==typeof e.enumerateDevices&&(this._enumerateDevices=e.enumerateDevices),"function"==typeof e.getUserMedia&&(this._getUserMedia=e.getUserMedia)}addProcessor(e){if(this._log.debug(".addProcessor"),this._processor)throw new k("Adding multiple AudioProcessors is not supported at this time.");if("object"!=typeof e||null===e)throw new x("Missing AudioProcessor argument.");if("function"!=typeof e.createProcessedStream)throw new x("Missing createProcessedStream() method.");if("function"!=typeof e.destroyProcessedStream)throw new x("Missing destroyProcessedStream() method.");return this._processor=e,this._audioProcessorEventObserver.emit("add"),this._restartStreams()}disconnect(e){return this._log.debug(".disconnect",e),this._maybeEnableSound(eG.SoundName.Disconnect,e)}incoming(e){return this._log.debug(".incoming",e),this._maybeEnableSound(eG.SoundName.Incoming,e)}outgoing(e){return this._log.debug(".outgoing",e),this._maybeEnableSound(eG.SoundName.Outgoing,e)}removeProcessor(e){if(this._log.debug(".removeProcessor"),"object"!=typeof e||null===e)throw new x("Missing AudioProcessor argument.");if(this._processor!==e)throw new x("Cannot remove an AudioProcessor that has not been previously added.");return this._destroyProcessedStream(),this._processor=null,this._audioProcessorEventObserver.emit("remove"),this._restartStreams()}setAudioConstraints(e){return this._log.debug(".setAudioConstraints",e),this._audioConstraints=Object.assign({},e),delete this._audioConstraints.deviceId,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()}setInputDevice(e){return this._log.debug(".setInputDevice",e),this._setInputDevice(e,!1)}unsetAudioConstraints(){return this._log.debug(".unsetAudioConstraints"),this._audioConstraints=null,this.inputDevice?this._setInputDevice(this.inputDevice.deviceId,!0):Promise.resolve()}unsetInputDevice(){return(this._log.debug(".unsetInputDevice",this.inputDevice),this.inputDevice)?(this._destroyProcessedStream(),this._onActiveInputChanged(null).then(()=>{this._replaceStream(null),this._inputDevice=null,this._maybeStopPollingVolume()})):Promise.resolve()}_destroyProcessedStream(){if(this._processor&&this._processedStream){this._log.info("destroying processed stream");let e=this._processedStream;this._processedStream.getTracks().forEach(e=>e.stop()),this._processedStream=null,this._processor.destroyProcessedStream(e),this._audioProcessorEventObserver.emit("destroy")}}_getUnknownDeviceIndex(e){let t=e.deviceId,i=e.kind,s=this._unknownDeviceIndexes[i][t];return s||(s=Object.keys(this._unknownDeviceIndexes[i]).length+1,this._unknownDeviceIndexes[i][t]=s),s}_initializeEnumeration(){if(!this._mediaDevices||!this._enumerateDevices)throw new k("Enumeration is not supported");this._mediaDevices.addEventListener&&this._mediaDevices.addEventListener("devicechange",this._updateAvailableDevices),this._updateAvailableDevices().then(()=>{this.isOutputSelectionSupported&&Promise.all([this.speakerDevices.set("default"),this.ringtoneDevices.set("default")]).catch(e=>{this._log.warn(`Warning: Unable to set audio output devices. ${e}`)})})}_maybeCreateProcessedStream(e){return this._processor?(this._log.info("Creating processed stream"),this._processor.createProcessedStream(e).then(e=>(this._processedStream=e,this._audioProcessorEventObserver.emit("create"),this._processedStream))):Promise.resolve(e)}_maybeEnableSound(e,t){return void 0!==t&&(this._enabledSounds[e]=t),this._enabledSounds[e]}_replaceStream(e){this._log.info("Replacing with new stream."),this._selectedInputDeviceStream&&(this._log.info("Old stream detected. Stopping tracks."),this._stopSelectedInputDeviceStream()),this._selectedInputDeviceStream=e}_restartStreams(){if(this.inputDevice&&this._selectedInputDeviceStream)return this._log.info("Restarting selected input device"),this._setInputDevice(this.inputDevice.deviceId,!0);if(this._defaultInputDeviceStream){let e=this.availableInputDevices.get("default")||Array.from(this.availableInputDevices.values())[0];return this._log.info("Restarting default input device, now becoming selected."),this._setInputDevice(e.deviceId,!0)}return Promise.resolve()}_setInputDevice(e,t){return(0,v.sH)(this,void 0,void 0,function*(){return this._inputDevicePromise=(0,v.sH)(this,void 0,void 0,function*(){if(yield this._beforeSetInputDevice(),"string"!=typeof e)return Promise.reject(new x("Must specify the device to set"));let i=this.availableInputDevices.get(e);if(!i)return Promise.reject(new x(`Device not found: ${e}`));if(this._log.info("Setting input device. ID: "+e),this._inputDevice&&this._inputDevice.deviceId===e&&this._selectedInputDeviceStream){if(!t)return Promise.resolve();this._log.info("Same track detected on setInputDevice, stopping old tracks."),this._stopSelectedInputDeviceStream()}this._stopDefaultInputDeviceStream();let s={audio:Object.assign({deviceId:{exact:e}},this.audioConstraints)};return this._log.info("setInputDevice: getting new tracks."),this._getUserMedia(s).then(e=>(this._destroyProcessedStream(),this._maybeCreateProcessedStream(e).then(t=>(this._log.info("setInputDevice: invoking _onActiveInputChanged."),this._onActiveInputChanged(t).then(()=>{this._replaceStream(e),this._inputDevice=i,this._maybeStartPollingVolume()})))))}).finally(()=>{this._inputDevicePromise=null})})}_stopMicrophonePermissionListener(){var e;(null==(e=this._microphonePermissionStatus)?void 0:e.removeEventListener)&&this._microphonePermissionStatus.removeEventListener("change",this._onMicrophonePermissionStatusChanged)}_stopSelectedInputDeviceStream(){this._selectedInputDeviceStream&&(this._log.info("Stopping selected device stream"),this._selectedInputDeviceStream.getTracks().forEach(e=>e.stop()))}_updateDevices(e,t,i){let s=e.map(e=>e.deviceId),n=Array.from(t.values()).map(e=>e.deviceId),o=[],r=$(n,s);r.forEach(e=>{let s=t.get(e);s&&(t.delete(e),i(s)&&o.push(s))});let a=!1;if(e.forEach(e=>{let i=t.get(e.deviceId),s=this._wrapMediaDeviceInfo(e);i&&i.label===s.label||(t.set(e.deviceId,s),a=!0)}),a||r.length){let e="default",t=this.inputDevice&&this.inputDevice.deviceId===e,i=this._defaultInputDeviceStream&&this.availableInputDevices.get(e);(t||i)&&(this._log.warn("Calling getUserMedia after device change to ensure that the           tracks of the active device (default) have not gone stale."),setTimeout(()=>{this._setInputDevice(e,!0)},0)),this._log.debug("#deviceChange",o),this.emit("deviceChange",o)}}_updateVolumeSource(){if(this.inputStream&&this._audioContext&&this._inputVolumeAnalyser){this._inputVolumeSource&&this._inputVolumeSource.disconnect();try{this._inputVolumeSource=this._audioContext.createMediaStreamSource(this.inputStream),this._inputVolumeSource.connect(this._inputVolumeAnalyser)}catch(e){this._log.warn("Unable to update volume source",e),delete this._inputVolumeSource}}}_wrapMediaDeviceInfo(e){let t={deviceId:e.deviceId,groupId:e.groupId,kind:e.kind,label:e.label};if(!t.label)if("default"===t.deviceId)t.label="Default";else{let i=this._getUnknownDeviceIndex(e);t.label=`Unknown ${J[t.kind]} Device ${i}`}return new M(t)}}Q||(Q={});var X=Q;class K extends _.EventEmitter{constructor(){super(),this._log=new D("AudioProcessorEventObserver"),this._log.info("Creating AudioProcessorEventObserver instance"),this.on("enabled",()=>this._reEmitEvent("enabled")),this.on("add",()=>this._reEmitEvent("add")),this.on("remove",()=>this._reEmitEvent("remove")),this.on("create",()=>this._reEmitEvent("create-processed-stream")),this.on("destroy",()=>this._reEmitEvent("destroy-processed-stream"))}destroy(){this.removeAllListeners()}_reEmitEvent(e){this._log.info(`AudioProcessor:${e}`),this.emit("event",{name:e,group:"audio-processor"})}}let Y={dtmf0:[1360,960],dtmf1:[1230,720],dtmf2:[1360,720],dtmf3:[1480,720],dtmf4:[1230,790],dtmf5:[1360,790],dtmf6:[1480,790],dtmf7:[1230,870],dtmf8:[1360,870],dtmf9:[1480,870],dtmfh:[1480,960],dtmfs:[1230,960]};class Z{constructor(e){this._context=e,this._gainNodes=[],this._gainNodes=[this._context.createGain(),this._context.createGain()],this._gainNodes.forEach(e=>{e.connect(this._context.destination),e.gain.value=.1,this._gainNodes.push(e)})}cleanup(){this._gainNodes.forEach(e=>{e.disconnect()})}play(e){let t=Y[e];if(!t)throw new x("Invalid DTMF sound name");[this._context.createOscillator(),this._context.createOscillator()].forEach((e,i)=>{e.type="sine",e.frequency.value=t[i],e.connect(this._gainNodes[i]),e.start(),e.stop(this._context.currentTime+.1),e.addEventListener("ended",()=>e.disconnect())})}}let ee=function(e,t,i){let s=JSON.stringify(t.body||{}),n=new Headers;t.headers=t.headers||[],Object.entries(t.headers).forEach(([e,t])=>n.append(e,t)),fetch(t.url,{body:s,headers:n,method:e}).then(e=>e.text(),i).then(e=>i(null,e),i)};ee.get=function(e,t){return new this("GET",e,t)},ee.post=function(e,t){return new this("POST",e,t)};class et extends _.EventEmitter{constructor(e,t,i){if(super(),!(this instanceof et))return new et(e,t,i);let s=(i=Object.assign({defaultPayload:()=>({})},i)).defaultPayload;"function"!=typeof s&&(s=()=>Object.assign({},i.defaultPayload));let n=!0,o=Object.assign({app_name:void 0,app_version:void 0},i.metadata);Object.defineProperties(this,{_defaultPayload:{value:s},_host:{value:i.host,writable:!0},_isEnabled:{get:()=>n,set(e){n=e}},_log:{value:new D("EventPublisher")},_request:{value:i.request||ee,writable:!0},_token:{value:t,writable:!0},isEnabled:{enumerable:!0,get:()=>n},metadata:{enumerable:!0,get:()=>o},productName:{enumerable:!0,value:e},token:{enumerable:!0,get(){return this._token}}})}}function ei(e){return{audio_codec:e.codecName,audio_level_in:e.audioInputLevel,audio_level_out:e.audioOutputLevel,bytes_received:e.bytesReceived,bytes_sent:e.bytesSent,call_volume_input:e.inputVolume,call_volume_output:e.outputVolume,jitter:e.jitter,mos:e.mos&&Math.round(100*e.mos)/100,packets_lost:e.packetsLost,packets_lost_fraction:e.packetsLostFraction&&Math.round(100*e.packetsLostFraction)/100,packets_received:e.packetsReceived,rtt:e.rtt,timestamp:new Date(e.timestamp).toISOString(),total_bytes_received:e.totals.bytesReceived,total_bytes_sent:e.totals.bytesSent,total_packets_lost:e.totals.packetsLost,total_packets_received:e.totals.packetsReceived,total_packets_sent:e.totals.packetsSent}}et.prototype._post=function(e,t,i,s,n,o,r){if(!this.isEnabled&&!r||!this._host)return this._log.debug("Publishing cancelled",JSON.stringify({isEnabled:this.isEnabled,force:r,host:this._host})),Promise.resolve();if(!o||(!o.parameters||!o.parameters.CallSid)&&!o.outboundConnectionId)return o?this._log.debug("Publishing cancelled. Missing connection info",JSON.stringify({outboundConnectionId:o.outboundConnectionId,parameters:o.parameters})):this._log.debug("Publishing cancelled. Missing connection object"),Promise.resolve();let a={group:i,level:t.toUpperCase(),name:s,payload:n&&n.forEach?n.slice(0):Object.assign(this._defaultPayload(o),n),payload_type:"application/json",private:!1,publisher:this.productName,timestamp:new Date().toISOString()};this.metadata&&(a.publisher_metadata=this.metadata),"EndpointEvents"===e&&this._log.debug("Publishing insights",JSON.stringify({endpointName:e,event:a,force:r,host:this._host}));let l={body:a,headers:{"Content-Type":"application/json","X-Twilio-Token":this.token},url:`https://${this._host}/v4/${e}`};return new Promise((e,t)=>{this._request.post(l,i=>{i?(this.emit("error",i),t(i)):e()})}).catch(e=>{this._log.error(`Unable to post ${i} ${s} event to Insights. Received error: ${e}`)})},et.prototype.post=function(e,t,i,s,n,o){return this._post("EndpointEvents",e,t,i,s,n,o)},et.prototype.debug=function(e,t,i,s){return this.post("debug",e,t,i,s)},et.prototype.info=function(e,t,i,s){return this.post("info",e,t,i,s)},et.prototype.warn=function(e,t,i,s){return this.post("warning",e,t,i,s)},et.prototype.error=function(e,t,i,s){return this.post("error",e,t,i,s)},et.prototype.postMetrics=function(e,t,i,s,n){return new Promise(o=>{let r=i.map(ei).map(e=>Object.assign(e,s));o(this._post("EndpointMetrics","info",e,t,r,n))})},et.prototype.setHost=function(e){this._host=e},et.prototype.setToken=function(e){this._token=e},et.prototype.enable=function(){this._isEnabled=!0},et.prototype.disable=function(){this._isEnabled=!1};let es="undefined"!=typeof window?window.RTCStatsReport:void 0;function en(e){if(!(this instanceof en))return new en(e);let t=this;Object.defineProperties(this,{_map:{value:e},size:{enumerable:!0,get:()=>t._map.size}}),this[Symbol.iterator]=e[Symbol.iterator]}function eo(e){return{bytesReceived:void 0,bytesSent:void 0,dtlsState:void 0,id:e.id,localCertificateId:e.stat("localCertificateId"),remoteCertificateId:e.stat("remoteCertificateId"),rtcpTransportStatsId:void 0,selectedCandidatePairId:e.stat("selectedCandidatePairId"),timestamp:Date.parse(e.timestamp),type:"transport"}}function er(e,t){return{associateStatsId:void 0,codecId:`codec-${e.id}`,firCount:t?ec(e,"googFirsSent"):void 0,id:e.id,isRemote:void 0,mediaType:e.stat("mediaType"),nackCount:t?ec(e,"googNacksSent"):ec(e,"googNacksReceived"),pliCount:t?ec(e,"googPlisSent"):ec(e,"googPlisReceived"),qpSum:ec(e,"qpSum"),sliCount:void 0,ssrc:e.stat("ssrc"),timestamp:Date.parse(e.timestamp),trackId:`track-${e.id}`,transportId:e.stat("transportId")}}function ea(e,t){return{candidateType:function(e){switch(e){case"peerreflexive":return"prflx";case"serverreflexive":return"srflx";default:return e}}(e.stat("candidateType")),deleted:void 0,id:e.id,ip:e.stat("ipAddress"),isRemote:t,port:ec(e,"portNumber"),priority:ed(e,"priority"),protocol:e.stat("transport"),relayProtocol:void 0,timestamp:Date.parse(e.timestamp),transportId:void 0,type:t?"remote-candidate":"local-candidate",url:void 0}}function el(e){return isNaN(e)||""===e?void 0:parseInt(e,10)/1e3}function ec(e,t){let i=e.stat(t);return eu(e,t)?parseInt(i,10):void 0}function ed(e,t){let i=e.stat(t);return eu(e,t)?parseFloat(i):void 0}function eh(e,t){let i=e.stat(t);return eu(e,t)?"true"===i||!0===i:void 0}function eu(e,t){let i=e.stat(t);return void 0!==i&&""!==i}function ep(e,t){return"function"==typeof e.get?e.get(t):e.find(e=>e.id===t)}function em(e){let t;if(!e)return Promise.reject(new x("PeerConnection is null"));if("function"!=typeof e.getStats)return Promise.reject(new k("WebRTC statistics are unsupported"));try{t=e.getStats()}catch(i){t=new Promise(t=>e.getStats(t)).then(en.fromRTCStatsResponse)}return t}function eg(e,t){return t=Object.assign({createRTCSample:ef},t),em(e).then(t.createRTCSample)}function e_(){}function ef(e){let t,i=null,s=new e_;Array.from(e.values()).forEach(n=>{if(n.isRemote)return;let o=n.type.replace("-","");if(t=t||n.timestamp,n.remoteId){let t=ep(e,n.remoteId);t&&t.roundTripTime&&(s.rtt=1e3*t.roundTripTime)}switch(o){case"inboundrtp":s.timestamp=s.timestamp||n.timestamp,s.jitter=1e3*n.jitter,s.packetsLost=n.packetsLost,s.packetsReceived=n.packetsReceived,s.bytesReceived=n.bytesReceived;break;case"outboundrtp":if(s.timestamp=n.timestamp,s.packetsSent=n.packetsSent,s.bytesSent=n.bytesSent,n.codecId){let t=ep(e,n.codecId);s.codecName=t?t.mimeType&&t.mimeType.match(/(.*\/)?(.*)/)[2]:n.codecId}break;case"transport":i=n.id}}),s.timestamp||(s.timestamp=t);let n=ep(e,i);if(!n)return s;let o=ep(e,n.selectedCandidatePairId);if(!o)return s;let r=ep(e,o.localCandidateId),a=ep(e,o.remoteCandidateId);return s.rtt||(s.rtt=o&&1e3*o.currentRoundTripTime),Object.assign(s,{localAddress:r&&(r.address||r.ip),remoteAddress:a&&(a.address||a.ip)}),s}es&&(en.prototype=Object.create(es.prototype),en.prototype.constructor=en),["entries","forEach","get","has","keys","values"].forEach(e=>{en.prototype[e]=function(...t){return this._map[e](...t)}}),en.fromArray=function(e){return new en(e.reduce((e,t)=>(e.set(t.id,t),e),new Map))},en.fromRTCStatsResponse=function(e){let t,i=new Map,s=e.result().reduce((e,s)=>{var n,o,r,a,l;let c=s.id;switch(s.type){case"googCertificate":e.set(c,{base64Certificate:(n=s).stat("googDerBase64"),fingerprint:n.stat("googFingerprint"),fingerprintAlgorithm:n.stat("googFingerprintAlgorithm"),id:n.id,issuerCertificateId:n.stat("googIssuerId"),timestamp:Date.parse(n.timestamp),type:"certificate"});break;case"datachannel":e.set(c,{bytesReceived:void 0,bytesSent:void 0,datachannelid:(o=s).stat("datachannelid"),id:o.id,label:o.stat("label"),messagesReceived:void 0,messagesSent:void 0,protocol:o.stat("protocol"),state:o.stat("state"),timestamp:Date.parse(o.timestamp),transportId:o.stat("transportId"),type:"data-channel"});break;case"googCandidatePair":eh(s,"googActiveConnection")&&(t=c),e.set(c,{availableIncomingBitrate:void 0,availableOutgoingBitrate:void 0,bytesReceived:ec(r=s,"bytesReceived"),bytesSent:ec(r,"bytesSent"),consentRequestsSent:ec(r,"consentRequestsSent"),currentRoundTripTime:el(r.stat("googRtt")),id:r.id,lastPacketReceivedTimestamp:void 0,lastPacketSentTimestamp:void 0,localCandidateId:r.stat("localCandidateId"),nominated:void 0,priority:void 0,readable:void 0,remoteCandidateId:r.stat("remoteCandidateId"),requestsReceived:ec(r,"requestsReceived"),requestsSent:ec(r,"requestsSent"),responsesReceived:ec(r,"responsesReceived"),responsesSent:ec(r,"responsesSent"),retransmissionsReceived:void 0,retransmissionsSent:void 0,state:void 0,timestamp:Date.parse(r.timestamp),totalRoundTripTime:void 0,transportId:r.stat("googChannelId"),type:"candidate-pair",writable:eh(r,"googWritable")});break;case"localcandidate":e.set(c,ea(s,!1));break;case"remotecandidate":e.set(c,ea(s,!0));break;case"ssrc":eu(s,"packetsReceived")?e.set(`rtp-${c}`,function(e){let t=er(e,!0);return Object.assign(t,{burstDiscardCount:void 0,burstDiscardRate:void 0,burstLossCount:void 0,burstLossRate:void 0,burstPacketsDiscarded:void 0,burstPacketsLost:void 0,bytesReceived:ec(e,"bytesReceived"),fractionLost:void 0,framesDecoded:ec(e,"framesDecoded"),gapDiscardRate:void 0,gapLossRate:void 0,jitter:el(e.stat("googJitterReceived")),packetsDiscarded:void 0,packetsLost:ec(e,"packetsLost"),packetsReceived:ec(e,"packetsReceived"),packetsRepaired:void 0,roundTripTime:el(e.stat("googRtt")),type:"inbound-rtp"}),t}(s)):e.set(`rtp-${c}`,function(e){let t=er(e,!1);return Object.assign(t,{bytesSent:ec(e,"bytesSent"),framesEncoded:ec(e,"framesEncoded"),packetsSent:ec(e,"packetsSent"),remoteTimestamp:void 0,targetBitrate:void 0,type:"outbound-rtp"}),t}(s)),e.set(`track-${c}`,{audioLevel:eu(a=s,"audioOutputLevel")?ec(a,"audioOutputLevel")/32767:(ec(a,"audioInputLevel")||0)/32767,detached:void 0,echoReturnLoss:ed(a,"googEchoCancellationReturnLoss"),echoReturnLossEnhancement:ed(a,"googEchoCancellationReturnLossEnhancement"),ended:void 0,frameHeight:eu(a,"googFrameHeightReceived")?ec(a,"googFrameHeightReceived"):ec(a,"googFrameHeightSent"),frameWidth:eu(a,"googFrameWidthReceived")?ec(a,"googFrameWidthReceived"):ec(a,"googFrameWidthSent"),framesCorrupted:void 0,framesDecoded:ec(a,"framesDecoded"),framesDropped:void 0,framesPerSecond:void 0,framesReceived:void 0,framesSent:ec(a,"framesEncoded"),fullFramesLost:void 0,id:a.id,kind:a.stat("mediaType"),partialFramesLost:void 0,remoteSource:void 0,ssrcIds:void 0,timestamp:Date.parse(a.timestamp),trackIdentifier:a.stat("googTrackId"),type:"track"}),e.set(`codec-${c}`,{channels:void 0,clockRate:void 0,id:(l=s).id,implementation:void 0,mimeType:`${l.stat("mediaType")}/${l.stat("googCodecName")}`,payloadType:void 0,sdpFmtpLine:void 0,timestamp:Date.parse(l.timestamp),type:"codec"});break;case"googComponent":let d=eo(s);i.set(d.selectedCandidatePairId,c),e.set(c,eo(s))}return e},new Map);if(t){let e=i.get(t);e&&(s.get(e).dtlsState="connected")}return new en(s)};class ev extends _.EventEmitter{constructor(e,t){super(),this._hasInsightsErrored=!1,this._log=new D("PreflightTest"),this._networkTiming={},this._options={codecPreferences:[e5.Codec.PCMU,e5.Codec.Opus],edge:"roaming",fakeMicInput:!1,logLevel:"error",signalingTimeoutMs:1e4},this._status=ev.Status.Connecting,Object.assign(this._options,t),this._samples=[],this._warnings=[],this._startTime=Date.now(),this._initDevice(e,Object.assign(Object.assign({},this._options),{fileInputStream:this._options.fakeMicInput?this._getStreamFromFile():void 0}));let i=["codecPreferences","edge","fakeMicInput","logLevel","signalingTimeoutMs"],s=["audioContext","deviceFactory","fileInputStream","getRTCIceCandidateStatsReport","iceServers","rtcConfiguration"];if("object"==typeof t){let e=Object.assign({},t);Object.keys(e).forEach(t=>{i.includes(t)||s.includes(t)||delete e[t],s.includes(t)&&(e[t]=!0)}),this._log.debug(".constructor",JSON.stringify(e))}}stop(){this._log.debug(".stop");let e=new a.CallCancelledError;this._device?(this._device.once(eG.EventName.Unregistered,()=>this._onFailed(e)),this._device.destroy()):this._onFailed(e)}_emitWarning(e,t,i){let s={name:e,description:t};i&&(s.rtcWarning=i),this._warnings.push(s),this._log.debug(`#${ev.Events.Warning}`,JSON.stringify(s)),this.emit(ev.Events.Warning,s)}_getCallQuality(e){return e>4.2?ev.CallQuality.Excellent:e>=4.1&&e<=4.2?ev.CallQuality.Great:e>=3.7&&e<=4?ev.CallQuality.Good:e>=3.1&&e<=3.6?ev.CallQuality.Fair:ev.CallQuality.Degraded}_getReport(){var e,t,i;let s=this._getRTCStats(),n={start:this._startTime};this._endTime&&(n.end=this._endTime,n.duration=this._endTime-this._startTime);let o={callSid:this._callSid,edge:this._edge,iceCandidateStats:null!=(t=null==(e=this._rtcIceCandidateStatsReport)?void 0:e.iceCandidateStats)?t:[],networkTiming:this._networkTiming,samples:this._samples,selectedEdge:this._options.edge,stats:s,testTiming:n,totals:this._getRTCSampleTotals(),warnings:this._warnings},r=null==(i=this._rtcIceCandidateStatsReport)?void 0:i.selectedIceCandidatePairStats;return r&&(o.selectedIceCandidatePairStats=r,o.isTurnRequired="relay"===r.localCandidate.candidateType||"relay"===r.remoteCandidate.candidateType),s&&(o.callQuality=this._getCallQuality(s.mos.average)),o}_getRTCSampleTotals(){if(this._latestSample)return Object.assign({},this._latestSample.totals)}_getRTCStats(){let e=this._samples.findIndex(e=>"number"==typeof e.mos&&e.mos>0),t=e>=0?this._samples.slice(e):[];if(t&&t.length)return["jitter","mos","rtt"].reduce((e,i)=>{let s=t.map(e=>e[i]);return Object.assign(Object.assign({},e),{[i]:{average:Number((s.reduce((e,t)=>e+t)/s.length).toPrecision(5)),max:Math.max(...s),min:Math.min(...s)}})},{})}_getStreamFromFile(){let e=this._options.audioContext;if(!e)throw new k("Cannot fake input audio stream: AudioContext is not supported by this browser.");let t=new Audio(P);t.addEventListener("canplaythrough",()=>t.play()),"function"==typeof t.setAttribute&&t.setAttribute("crossorigin","anonymous");let i=e.createMediaElementSource(t),s=e.createMediaStreamDestination();return i.connect(s),s.stream}_initDevice(e,t){try{this._device=new(t.deviceFactory||eG)(e,{chunderw:t.chunderw,codecPreferences:t.codecPreferences,edge:t.edge,eventgw:t.eventgw,fileInputStream:t.fileInputStream,logLevel:t.logLevel,preflight:!0}),this._device.once(eG.EventName.Registered,()=>{this._onDeviceRegistered()}),this._device.once(eG.EventName.Error,e=>{this._onDeviceError(e)}),this._device.register()}catch(e){setTimeout(()=>{this._onFailed(e)});return}this._signalingTimeoutTimer=setTimeout(()=>{this._onDeviceError(new d.ConnectionError("WebSocket Connection Timeout"))},t.signalingTimeoutMs)}_onDeviceError(e){this._device.destroy(),this._onFailed(e)}_onDeviceRegistered(){return(0,v.sH)(this,void 0,void 0,function*(){if(clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),this._call=yield this._device.connect({rtcConfiguration:this._options.rtcConfiguration}),this._networkTiming.signaling={start:Date.now()},this._setupCallHandlers(this._call),this._edge=this._device.edge||void 0,this._options.fakeMicInput){this._echoTimer=setTimeout(()=>this._device.disconnectAll(),2e4);let e=this._device.audio;e&&(e.disconnect(!1),e.outgoing(!1))}this._call.once("disconnect",()=>{this._device.once(eG.EventName.Unregistered,()=>this._onUnregistered()),this._device.destroy()}),this._call._publisher.on("error",()=>{this._hasInsightsErrored||this._emitWarning("insights-connection-error","Received an error when attempting to connect to Insights gateway"),this._hasInsightsErrored=!0})})}_onFailed(e){clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),this._releaseHandlers(),this._endTime=Date.now(),this._status=ev.Status.Failed,this._log.debug(`#${ev.Events.Failed}`,e),this.emit(ev.Events.Failed,e)}_onUnregistered(){setTimeout(()=>{this._status!==ev.Status.Failed&&(clearTimeout(this._echoTimer),clearTimeout(this._signalingTimeoutTimer),this._releaseHandlers(),this._endTime=Date.now(),this._status=ev.Status.Completed,this._report=this._getReport(),this._log.debug(`#${ev.Events.Completed}`,JSON.stringify(this._report)),this.emit(ev.Events.Completed,this._report))},10)}_releaseHandlers(){[this._device,this._call].forEach(e=>{e&&e.eventNames().forEach(t=>e.removeAllListeners(t))})}_setupCallHandlers(e){this._options.fakeMicInput&&e.once("volume",()=>{e._mediaHandler.outputs.forEach(e=>e.audio.muted=!0)}),e.on("warning",(e,t)=>{this._emitWarning(e,"Received an RTCWarning. See .rtcWarning for the RTCWarning",t)}),e.once("accept",()=>{this._callSid=e._mediaHandler.callSid,this._status=ev.Status.Connected,this._log.debug(`#${ev.Events.Connected}`),this.emit(ev.Events.Connected)}),e.on("sample",t=>(0,v.sH)(this,void 0,void 0,function*(){this._latestSample||(this._rtcIceCandidateStatsReport=yield(this._options.getRTCIceCandidateStatsReport||function(e){return em(e).then(e=>{let t,{candidatePairs:i,localCandidates:s,remoteCandidates:n,transport:o}=Array.from(e.values()).reduce((e,t)=>{switch(["candidatePairs","localCandidates","remoteCandidates"].forEach(t=>{e[t]||(e[t]=[])}),t.type){case"candidate-pair":e.candidatePairs.push(t);break;case"local-candidate":e.localCandidates.push(t);break;case"remote-candidate":e.remoteCandidates.push(t);break;case"transport":t.selectedCandidatePairId&&(e.transport=t)}return e},{}),r=i.find(e=>e.selected||o&&e.id===o.selectedCandidatePairId);return r&&(t={localCandidate:s.find(e=>e.id===r.localCandidateId),remoteCandidate:n.find(e=>e.id===r.remoteCandidateId)}),{iceCandidateStats:[...s,...n],selectedIceCandidatePairStats:t}})})(e._mediaHandler.version.pc)),this._latestSample=t,this._samples.push(t),this._log.debug(`#${ev.Events.Sample}`,JSON.stringify(t)),this.emit(ev.Events.Sample,t)})),[{reportLabel:"peerConnection",type:"pcconnection"},{reportLabel:"ice",type:"iceconnection"},{reportLabel:"dtls",type:"dtlstransport"},{reportLabel:"signaling",type:"signaling"}].forEach(({type:t,reportLabel:i})=>{let s=`on${t}statechange`,n=e._mediaHandler[s];e._mediaHandler[s]=e=>{let t=this._networkTiming[i]=this._networkTiming[i]||{start:0};"connecting"===e||"checking"===e?t.start=Date.now():"connected"!==e&&"stable"!==e||t.duration||(t.end=Date.now(),t.duration=t.end-t.start),n(e)}})}get callSid(){return this._callSid}get endTime(){return this._endTime}get latestSample(){return this._latestSample}get report(){return this._report}get startTime(){return this._startTime}get status(){return this._status}}!function(e){var t,i,s;(t=e.CallQuality||(e.CallQuality={})).Excellent="excellent",t.Great="great",t.Good="good",t.Fair="fair",t.Degraded="degraded",(i=e.Events||(e.Events={})).Completed="completed",i.Connected="connected",i.Failed="failed",i.Sample="sample",i.Warning="warning",(s=e.Status||(e.Status={})).Connecting="connecting",s.Connected="connected",s.Completed="completed",s.Failed="failed"}(ev||(ev={}));let ey=globalThis.WebSocket;!function(e){e.Connecting="connecting",e.Closed="closed",e.Open="open"}(u||(u={}));class eb extends _.EventEmitter{constructor(e,t={}){super(),this.state=u.Closed,this._backoffStartTime={preferred:null,primary:null},this._connectedUri=null,this._log=new D("WSTransport"),this._shouldFallback=!1,this._uriIndex=0,this._moveUriIndex=()=>{this._uriIndex++,this._uriIndex>=this._uris.length&&(this._uriIndex=0)},this._onSocketClose=e=>{if(this._log.error(`Received websocket close event code: ${e.code}. Reason: ${e.reason}`),1006===e.code||1015===e.code){this.emit("error",{code:31005,message:e.reason||"Websocket connection to Twilio's signaling servers were unexpectedly ended. If this is happening consistently, there may be an issue resolving the hostname provided. If a region or an edge is being specified in Device setup, ensure it is valid.",twilioError:new d.ConnectionError});let t=this.state===u.Open||this._previousState===u.Open;(this._shouldFallback||!t)&&this._moveUriIndex(),this._shouldFallback=!0}this._closeSocket()},this._onSocketError=e=>{this._log.error(`WebSocket received error: ${e.message}`),this.emit("error",{code:31e3,message:e.message||"WSTransport socket error",twilioError:new d.ConnectionDisconnected})},this._onSocketMessage=e=>{if(this._setHeartbeatTimeout(),this._socket&&"\n"===e.data){this._socket.send("\n"),this._log.debug("heartbeat");return}e&&"string"==typeof e.data&&this._log.debug(`Received: ${e.data}`),this.emit("message",e)},this._onSocketOpen=()=>{this._log.info("WebSocket opened successfully."),this._timeOpened=Date.now(),this._shouldFallback=!1,this._setState(u.Open),clearTimeout(this._connectTimeout),this._resetBackoffs(),this._setHeartbeatTimeout(),this.emit("open")},this._options=Object.assign(Object.assign({},eb.defaultConstructorOptions),t),this._uris=e,this._backoff=this._setupBackoffs()}close(){this._log.info("WSTransport.close() called..."),this._close()}open(){if(this._log.info("WSTransport.open() called..."),this._socket&&(this._socket.readyState===ey.CONNECTING||this._socket.readyState===ey.OPEN))return void this._log.info("WebSocket already open.");this._preferredUri?this._connect(this._preferredUri):this._connect(this._uris[this._uriIndex])}send(e){if(this._log.debug(`Sending: ${e}`),!this._socket||this._socket.readyState!==ey.OPEN)return this._log.debug("Cannot send message. WebSocket is not open."),!1;try{this._socket.send(e)}catch(e){return this._log.error("Error while sending message:",e.message),this._closeSocket(),!1}return!0}updatePreferredURI(e){this._preferredUri=e}updateURIs(e){"string"==typeof e&&(e=[e]),this._uris=e,this._uriIndex=0}_close(){this._setState(u.Closed),this._closeSocket()}_closeSocket(){if(clearTimeout(this._connectTimeout),clearTimeout(this._heartbeatTimeout),this._log.info("Closing and cleaning up WebSocket..."),!this._socket)return void this._log.info("No WebSocket to clean up.");this._socket.removeEventListener("close",this._onSocketClose),this._socket.removeEventListener("error",this._onSocketError),this._socket.removeEventListener("message",this._onSocketMessage),this._socket.removeEventListener("open",this._onSocketOpen),(this._socket.readyState===ey.CONNECTING||this._socket.readyState===ey.OPEN)&&this._socket.close(),this._timeOpened&&Date.now()-this._timeOpened>1e4&&this._resetBackoffs(),this.state!==u.Closed&&this._performBackoff(),delete this._socket,this.emit("close")}_connect(e,t){this._log.info("number"==typeof t?`Attempting to reconnect (retry #${t})...`:"Attempting to connect..."),this._closeSocket(),this._setState(u.Connecting),this._connectedUri=e;try{this._socket=new this._options.WebSocket(this._connectedUri)}catch(e){this._log.error("Could not connect to endpoint:",e.message),this._close(),this.emit("error",{code:31e3,message:e.message||`Could not connect to ${this._connectedUri}`,twilioError:new d.ConnectionDisconnected});return}this._socket.addEventListener("close",this._onSocketClose),this._socket.addEventListener("error",this._onSocketError),this._socket.addEventListener("message",this._onSocketMessage),this._socket.addEventListener("open",this._onSocketOpen),delete this._timeOpened,this._connectTimeout=setTimeout(()=>{this._log.info("WebSocket connection attempt timed out."),this._moveUriIndex(),this._closeSocket()},this._options.connectTimeoutMs)}_performBackoff(){this._preferredUri?(this._log.info("Preferred URI set; backing off."),this._backoff.preferred.backoff()):(this._log.info("Preferred URI not set; backing off."),this._backoff.primary.backoff())}_resetBackoffs(){this._backoff.preferred.reset(),this._backoff.primary.reset(),this._backoffStartTime.preferred=null,this._backoffStartTime.primary=null}_setHeartbeatTimeout(){clearTimeout(this._heartbeatTimeout),this._heartbeatTimeout=setTimeout(()=>{this._log.info("No messages received in 15 seconds. Reconnecting..."),this._shouldFallback=!0,this._closeSocket()},15e3)}_setState(e){this._previousState=this.state,this.state=e}_setupBackoffs(){let e={factor:2,jitter:.4,max:this._options.maxPreferredDelayMs,min:100};this._log.info("Initializing preferred transport backoff using config: ",e);let t=new f(e);t.on("backoff",(e,t)=>{if(this.state===u.Closed)return void this._log.info("Preferred backoff initiated but transport state is closed; not attempting a connection.");this._log.info(`Will attempt to reconnect Websocket to preferred URI in ${t}ms`),0===e&&(this._backoffStartTime.preferred=Date.now(),this._log.info(`Preferred backoff start; ${this._backoffStartTime.preferred}`))}),t.on("ready",(e,t)=>{if(this.state===u.Closed)return void this._log.info("Preferred backoff ready but transport state is closed; not attempting a connection.");if(null===this._backoffStartTime.preferred)return void this._log.info("Preferred backoff start time invalid; not attempting a connection.");if(Date.now()-this._backoffStartTime.preferred>this._options.maxPreferredDurationMs){this._log.info("Max preferred backoff attempt time exceeded; falling back to primary backoff."),this._preferredUri=null,this._backoff.primary.backoff();return}if("string"!=typeof this._preferredUri){this._log.info("Preferred URI cleared; falling back to primary backoff."),this._preferredUri=null,this._backoff.primary.backoff();return}this._connect(this._preferredUri,e+1)});let i={factor:2,jitter:.4,max:this._options.maxPrimaryDelayMs,min:this._uris&&this._uris.length>1?Math.floor(4001*Math.random())+1e3:100};this._log.info("Initializing primary transport backoff using config: ",i);let s=new f(i);return s.on("backoff",(e,t)=>{if(this.state===u.Closed)return void this._log.info("Primary backoff initiated but transport state is closed; not attempting a connection.");this._log.info(`Will attempt to reconnect WebSocket in ${t}ms`),0===e&&(this._backoffStartTime.primary=Date.now(),this._log.info(`Primary backoff start; ${this._backoffStartTime.primary}`))}),s.on("ready",(e,t)=>this.state===u.Closed?void this._log.info("Primary backoff ready but transport state is closed; not attempting a connection."):null===this._backoffStartTime.primary?void this._log.info("Primary backoff start time invalid; not attempting a connection."):Date.now()-this._backoffStartTime.primary>this._options.maxPrimaryDurationMs?void this._log.info("Max primary backoff attempt time exceeded; not attempting a connection."):void this._connect(this._uris[this._uriIndex],e+1)),{preferred:t,primary:s}}get uri(){return this._connectedUri}}eb.defaultConstructorOptions={WebSocket:ey,connectTimeoutMs:5e3,maxPreferredDelayMs:1e3,maxPreferredDurationMs:15e3,maxPrimaryDelayMs:2e4,maxPrimaryDurationMs:1/0};class eS extends _.EventEmitter{constructor(e,t,i){if(super(),!(this instanceof eS))return new eS(e,t,i);let s={TransportFactory:eb};for(let e in i=i||{},s)e in i||(i[e]=s[e]);this.options=i,this.token=e||"",this.status="disconnected",this.gateway=null,this.region=null,this._messageQueue=[],this._preferredUri=null,this._uris=t,this._handleTransportClose=this._handleTransportClose.bind(this),this._handleTransportError=this._handleTransportError.bind(this),this._handleTransportMessage=this._handleTransportMessage.bind(this),this._handleTransportOpen=this._handleTransportOpen.bind(this),this._log=new D("PStream"),this.on("error",()=>{this._log.warn("Unexpected error handled in pstream")});let n=this;return this.addListener("ready",()=>{n.status="ready"}),this.addListener("offline",()=>{n.status="offline"}),this.addListener("close",()=>{n._log.info('Received "close" from server. Destroying PStream...'),n._destroy()}),this.transport=new this.options.TransportFactory(this._uris,{backoffMaxMs:this.options.backoffMaxMs,maxPreferredDurationMs:this.options.maxPreferredDurationMs}),Object.defineProperties(this,{uri:{enumerable:!0,get(){return this.transport.uri}}}),this.transport.on("close",this._handleTransportClose),this.transport.on("error",this._handleTransportError),this.transport.on("message",this._handleTransportMessage),this.transport.on("open",this._handleTransportOpen),this.transport.open(),this}}eS.prototype._handleTransportClose=function(){this.emit("transportClose"),"disconnected"!==this.status&&("offline"!==this.status&&this.emit("offline",this),this.status="disconnected")},eS.prototype._handleTransportError=function(e){if(!e)return void this.emit("error",{error:{code:31e3,message:"Websocket closed without a provided reason",twilioError:new d.ConnectionDisconnected}});this.emit("error",void 0!==e.code?{error:e}:e)},eS.prototype._handleTransportMessage=function(e){if(!e||!e.data||"string"!=typeof e.data)return;let{type:t,payload:i={}}=JSON.parse(e.data);this.gateway=i.gateway||this.gateway,this.region=i.region||this.region,"error"===t&&i.error&&(i.error.twilioError=new d.ConnectionError),this.emit(t,i)},eS.prototype._handleTransportOpen=function(){this.status="connected",this.setToken(this.token),this.emit("transportOpen"),this._messageQueue.splice(0,this._messageQueue.length).forEach(e=>this._publish(...e))},eS.toString=()=>"[Twilio.PStream class]",eS.prototype.toString=()=>"[Twilio.PStream instance]",eS.prototype.setToken=function(e){this._log.info("Setting token and publishing listen"),this.token=e;let t=0,i=this.options.maxPreferredDurationMs;this._log.info(`maxPreferredDurationMs:${i}`),"number"==typeof i&&i>=0&&(t=Math.min(Math.ceil(i/1e3),30)),this._log.info(`reconnectTimeout:${t}`);let s={browserinfo:function(){let e="undefined"!=typeof navigator?navigator:{};return{browser:{platform:e.platform||"unknown",userAgent:e.userAgent||"unknown"},p:"browser",plugin:"rtc",v:I}}(),reconnectTimeout:t,token:e};this._publish("listen",s)},eS.prototype.sendMessage=function(e,t,i="application/json",s,n){this._publish("message",{callsid:e,content:t,contenttype:i,messagetype:s,voiceeventsid:n},!0)},eS.prototype.register=function(e){this._publish("register",{media:e},!0)},eS.prototype.invite=function(e,t,i){this._publish("invite",{callsid:t,sdp:e,twilio:i?{params:i}:{}},!0)},eS.prototype.reconnect=function(e,t,i){this._publish("invite",{callsid:t,reconnect:i,sdp:e,twilio:{}},!0)},eS.prototype.answer=function(e,t){this._publish("answer",{sdp:e,callsid:t},!0)},eS.prototype.dtmf=function(e,t){this._publish("dtmf",{callsid:e,dtmf:t},!0)},eS.prototype.hangup=function(e,t){this._publish("hangup",t?{callsid:e,message:t}:{callsid:e},!0)},eS.prototype.reject=function(e){this._publish("reject",{callsid:e},!0)},eS.prototype.reinvite=function(e,t){this._publish("reinvite",{sdp:e,callsid:t},!1)},eS.prototype._destroy=function(){this.transport.removeListener("close",this._handleTransportClose),this.transport.removeListener("error",this._handleTransportError),this.transport.removeListener("message",this._handleTransportMessage),this.transport.removeListener("open",this._handleTransportOpen),this.transport.close(),this.emit("offline",this)},eS.prototype.destroy=function(){return this._log.info("PStream.destroy() called..."),this._destroy(),this},eS.prototype.updatePreferredURI=function(e){this._preferredUri=e,this.transport.updatePreferredURI(e)},eS.prototype.updateURIs=function(e){this._uris=e,this.transport.updateURIs(this._uris)},eS.prototype.publish=function(e,t){return this._publish(e,t,!0)},eS.prototype._publish=function(e,t,i){let s=JSON.stringify({payload:t,type:e,version:"1.6"});!this.transport.send(s)&&(this.emit("error",{error:{code:31009,message:"No transport available to send or receive messages",twilioError:new a.TransportError}}),i&&this._messageQueue.push([e,t,!0]))},!function(e){e.Sydney="sydney",e.SaoPaulo="sao-paulo",e.Dublin="dublin",e.Frankfurt="frankfurt",e.Tokyo="tokyo",e.Singapore="singapore",e.Ashburn="ashburn",e.Umatilla="umatilla",e.Roaming="roaming",e.AshburnIx="ashburn-ix",e.SanJoseIx="san-jose-ix",e.LondonIx="london-ix",e.FrankfurtIx="frankfurt-ix",e.SingaporeIx="singapore-ix",e.SydneyIx="sydney-ix",e.TokyoIx="tokyo-ix"}(p||(p={})),function(e){e.Au1="au1",e.Au1Ix="au1-ix",e.Br1="br1",e.De1="de1",e.De1Ix="de1-ix",e.Gll="gll",e.Ie1="ie1",e.Ie1Ix="ie1-ix",e.Ie1Tnx="ie1-tnx",e.Jp1="jp1",e.Jp1Ix="jp1-ix",e.Sg1="sg1",e.Sg1Ix="sg1-ix",e.Sg1Tnx="sg1-tnx",e.Us1="us1",e.Us1Ix="us1-ix",e.Us1Tnx="us1-tnx",e.Us2="us2",e.Us2Ix="us2-ix",e.Us2Tnx="us2-tnx"}(m||(m={}));let ew={ASIAPAC_SINGAPORE:m.Sg1,ASIAPAC_SYDNEY:m.Au1,ASIAPAC_TOKYO:m.Jp1,EU_FRANKFURT:m.De1,EU_IRELAND:m.Ie1,SOUTH_AMERICA_SAO_PAULO:m.Br1,US_EAST_VIRGINIA:m.Us1,US_WEST_OREGON:m.Us2},eC={[m.Au1]:p.Sydney,[m.Br1]:p.SaoPaulo,[m.Ie1]:p.Dublin,[m.De1]:p.Frankfurt,[m.Jp1]:p.Tokyo,[m.Sg1]:p.Singapore,[m.Us1]:p.Ashburn,[m.Us2]:p.Umatilla,[m.Gll]:p.Roaming,[m.Us1Ix]:p.AshburnIx,[m.Us2Ix]:p.SanJoseIx,[m.Ie1Ix]:p.LondonIx,[m.De1Ix]:p.FrankfurtIx,[m.Sg1Ix]:p.SingaporeIx,[m.Au1Ix]:p.SydneyIx,[m.Jp1Ix]:p.TokyoIx,[m.Us1Tnx]:p.AshburnIx,[m.Us2Tnx]:p.AshburnIx,[m.Ie1Tnx]:p.LondonIx,[m.Sg1Tnx]:p.SingaporeIx},ex=p.Roaming;function eT(e){return`voice-js.${e}.twilio.com`}function ek(e){return e?`eventgw.${e}.twilio.com`:"eventgw.twilio.com"}function eE(e){return`wss://${e}/signal`}function eI(e){let t;if(e&&"string"!=typeof e&&!Array.isArray(e))throw new x("If `edge` is provided, it must be of type `string` or an array of strings.");return e?(Array.isArray(e)?e:[e]).map(e=>eT(e)):[eT(ex)]}let eA={0:"PCMU",8:"PCMA"};function eP(e,t){if("number"!=typeof t||t<6e3||t>51e4)return e;let i=/a=rtpmap:(\d+) opus/m.exec(e),s=i&&i.length?i[1]:111,n=RegExp(`a=fmtp:${s}`);return e.split("\n").map(e=>n.test(e)?e+`;maxaveragebitrate=${t}`:e).join("\n")}function eD(e,t){var i,s;let n=e.replace(/\r\n\r\n$/,"\r\n").split("\r\nm=").slice(1).map(e=>`m=${e}`).filter(e=>{let t=RegExp("m=.*","gm"),i=RegExp("a=.*","gm");return t.test(e)&&i.test(e)});return[e.split("\r\nm=")[0]].concat(n.map(e=>{var i;if(!/^m=(audio|video)/.test(e))return e;let s=e.match(/^m=(audio|video)/)[1],n=Array.from((function(e){let t=e.split("\r\n")[0].match(/([0-9]+)/g);return t?t.slice(1).map(e=>parseInt(e,10)):[]})(i=e).reduce((e,t)=>{let s=RegExp(`a=rtpmap:${t} ([^/]+)`),n=i.match(s),o=n?n[1].toLowerCase():eA[t]?eA[t].toLowerCase():"";return e.set(t,o)},new Map)).reduce((e,t)=>{let i=t[0],s=t[1],n=e.get(s)||[];return e.set(s,n.concat(i))},new Map),o=function(e,t){let i=B(t=t.map(e=>e.toLowerCase()),t=>e.get(t)||[]),s=B($(Array.from(e.keys()),t),t=>e.get(t));return i.concat(s)}(n,t),r=function(e,t){let i=t.split("\r\n"),s=i[0],n=i.slice(1);return[s=s.replace(/([0-9]+\s?)+$/,e.join(" "))].concat(n).join("\r\n")}(o,e),a=n.get("pcma")||[],l=n.get("pcmu")||[];return("audio"===s?new Set(a.concat(l)):new Set).has(o[0])?r.replace(/\r\nb=(AS|TIAS):([0-9]+)/g,""):r})).join("\r\n")}function eR(e){if(this.log=new D("RTCPC"),"undefined"==typeof window)return void this.log.info("No RTCPeerConnection implementation available. The window object was not found.");e&&e.RTCPeerConnection?this.RTCPeerConnection=e.RTCPeerConnection:"function"==typeof window.RTCPeerConnection?this.RTCPeerConnection=window.RTCPeerConnection:"function"==typeof window.webkitRTCPeerConnection?this.RTCPeerConnection=webkitRTCPeerConnection:"function"==typeof window.mozRTCPeerConnection?(this.RTCPeerConnection=mozRTCPeerConnection,window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate):this.log.info("No RTCPeerConnection implementation available")}function eO(e,t,i,s){return function(){let n=Array.prototype.slice.call(arguments);return new Promise(i=>{let o=e.apply(t,n);if(!s)return void i(o);if("object"==typeof o&&"function"==typeof o.then)i(o);else throw Error()}).catch(()=>new Promise((s,o)=>{e.apply(t,i?[s,o].concat(n):n.concat([s,o]))}))}}function eM(e,t){return eO(e,t,!1,!1)}function eL(e,t,i){if(!e||!t)throw new x("Audiohelper, and pstream are required arguments");if(!(this instanceof eL))return new eL(e,t,i);function s(){this._log.warn("Unexpected noop call in peerconnection")}this._log=new D("PeerConnection"),this.onaudio=s,this.onopen=s,this.onerror=s,this.onclose=s,this.ondisconnected=s,this.onfailed=s,this.onconnected=s,this.onreconnected=s,this.onsignalingstatechange=s,this.ondtlstransportstatechange=s,this.onicegatheringfailure=s,this.onicegatheringstatechange=s,this.oniceconnectionstatechange=s,this.onpcconnectionstatechange=s,this.onicecandidate=s,this.onselectedcandidatepairchange=s,this.onvolume=s,this.version=null,this.pstream=t,this.stream=null,this.sinkIds=new Set(["default"]),this.outputs=new Map,this.status="connecting",this.callSid=null,this.isMuted=!1;let n="undefined"!=typeof window&&(window.AudioContext||window.webkitAudioContext);return this._isSinkSupported=!!n&&"undefined"!=typeof HTMLAudioElement&&HTMLAudioElement.prototype.setSinkId,this._audioContext=n&&e._audioContext,this._audioHelper=e,this._hasIceCandidates=!1,this._hasIceGatheringFailures=!1,this._iceGatheringTimeoutId=null,this._masterAudio=null,this._masterAudioDeviceId=null,this._mediaStreamSource=null,this._dtmfSender=null,this._dtmfSenderUnsupported=!1,this._callEvents=[],this._nextTimeToPublish=Date.now(),this._onAnswerOrRinging=s,this._onHangup=s,this._remoteStream=null,this._shouldManageStream=!0,this._iceState="new",this.options=i=i||{},this.navigator=i.navigator||("undefined"!=typeof navigator?navigator:null),this.util=i.util||g,this.codecPreferences=i.codecPreferences,this}function ej(e,t){let i;return i=t?new t:"undefined"!=typeof MediaStream?new MediaStream:new webkitMediaStream,e.getAudioTracks().forEach(i.addTrack,i),i}function e$(e,t){if(void 0!==e.srcObject)e.srcObject=t;else if(void 0!==e.mozSrcObject)e.mozSrcObject=t;else{if(void 0===e.src)return!1;let i=e.options.window||window;e.src=(i.URL||i.webkitURL).createObjectURL(t)}return!0}function eN(e,t){return(t=t||{}).util=t.util||g,t.navigator=t.navigator||("undefined"!=typeof navigator?navigator:null),new Promise((i,s)=>{if(!t.navigator)throw new k("getUserMedia is not supported");switch("function"){case typeof(t.navigator.mediaDevices&&t.navigator.mediaDevices.getUserMedia):return i(t.navigator.mediaDevices.getUserMedia(e));case typeof t.navigator.webkitGetUserMedia:return t.navigator.webkitGetUserMedia(e,i,s);case typeof t.navigator.mozGetUserMedia:return t.navigator.mozGetUserMedia(e,i,s);case typeof t.navigator.getUserMedia:return t.navigator.getUserMedia(e,i,s);default:throw new k("getUserMedia is not supported")}}).catch(e=>{throw t.util.isFirefox()&&"NotReadableError"===e.name?new k("Firefox does not currently support opening multiple audio input trackssimultaneously, even across different tabs.\nRelated Bugzilla thread: https://bugzilla.mozilla.org/show_bug.cgi?id=1299324"):e})}function eF(){return`KX${function(){if("object"!=typeof window)throw new k("This platform is not supported.");let{crypto:e}=window;if("object"!=typeof e)throw new k("The `crypto` module is not available on this platform.");if("function"!=typeof e.getRandomValues)throw new k("The function `crypto.getRandomValues` is not available on this platform.");if("function"!=typeof window.Uint8Array)throw new k("The `Uint8Array` module is not available on this platform.");return e.getRandomValues(new window.Uint8Array(16)).reduce((e,t)=>`${e}${t.toString(16).padStart(2,"0")}`,"")}()}`}eR.prototype.create=function(e){this.pc=new this.RTCPeerConnection(e)},eR.prototype.createModernConstraints=e=>{if(void 0===e)return null;let t=Object.assign({},e);return"undefined"==typeof webkitRTCPeerConnection||H()?(void 0!==e.audio&&(t.offerToReceiveAudio=e.audio),void 0!==e.video&&(t.offerToReceiveVideo=e.video)):(t.mandatory={},void 0!==e.audio&&(t.mandatory.OfferToReceiveAudio=e.audio),void 0!==e.video&&(t.mandatory.OfferToReceiveVideo=e.video)),delete t.audio,delete t.video,t},eR.prototype.createOffer=function(e,t,i,s){var n;return t=this.createModernConstraints(t),(n=this.pc.createOffer,eO(n,this.pc,!0,!0))(t).then(t=>{if(!this.pc)return Promise.resolve();let i=eP(t.sdp,e);return eM(this.pc.setLocalDescription,this.pc)(new RTCSessionDescription({sdp:i,type:"offer"}))}).then(i,s)},eR.prototype.createAnswer=function(e,t,i,s){var n;return t=this.createModernConstraints(t),(n=this.pc.createAnswer,eO(n,this.pc,!0,!0))(t).then(t=>{if(!this.pc)return Promise.resolve();let i=eP(t.sdp,e);return eM(this.pc.setLocalDescription,this.pc)(new RTCSessionDescription({sdp:i,type:"answer"}))}).then(i,s)},eR.prototype.processSDP=function(e,t,i,s,n,o){let r=new RTCSessionDescription({sdp:i=eD(i,t),type:"offer"});return eM(this.pc.setRemoteDescription,this.pc)(r).then(()=>{this.createAnswer(e,s,n,o)})},eR.prototype.getSDP=function(){return this.pc.localDescription.sdp},eR.prototype.processAnswer=function(e,t,i,s){return this.pc?(t=eD(t,e),eM(this.pc.setRemoteDescription,this.pc)(new RTCSessionDescription({sdp:t,type:"answer"})).then(i,s)):Promise.resolve()},eR.test=()=>{if("object"==typeof navigator){let e=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;if(H(navigator))return!1;if(e&&"function"==typeof window.RTCPeerConnection)return!0;if(e&&"function"==typeof window.webkitRTCPeerConnection)return!0;if(e&&"function"==typeof window.mozRTCPeerConnection){try{let e=new window.mozRTCPeerConnection;if("function"!=typeof e.getLocalStreams)return!1}catch(e){return!1}return!0}else if("undefined"!=typeof RTCIceGatherer)return!0}return!1},eL.prototype.uri=function(){return this._uri},eL.prototype.openDefaultDeviceWithConstraints=function(e){return this._audioHelper._openDefaultDeviceWithConstraints(e).then(this._setInputTracksFromStream.bind(this,!1))},eL.prototype.setInputTracksFromStream=function(e){let t=this;return this._setInputTracksFromStream(!0,e).then(()=>{t._shouldManageStream=!1})},eL.prototype._createAnalyser=(e,t)=>{t=Object.assign({fftSize:32,smoothingTimeConstant:.3},t);let i=e.createAnalyser();for(let e in t)i[e]=t[e];return i},eL.prototype._setVolumeHandler=function(e){this.onvolume=e},eL.prototype._startPollingVolume=function(){if(!this._audioContext||!this.stream||!this._remoteStream)return;let e=this._audioContext,t=new Uint8Array((this._inputAnalyser=this._createAnalyser(e)).frequencyBinCount);this._inputAnalyser2=this._createAnalyser(e,{maxDecibels:0,minDecibels:-127,smoothingTimeConstant:0});let i=new Uint8Array((this._outputAnalyser=this._createAnalyser(e)).frequencyBinCount);this._outputAnalyser2=this._createAnalyser(e,{maxDecibels:0,minDecibels:-127,smoothingTimeConstant:0}),this._updateInputStreamSource(this.stream),this._updateOutputStreamSource(this._remoteStream);let s=this;setTimeout(function e(){if(!s._audioContext)return;if("closed"===s.status){s._inputAnalyser.disconnect(),s._outputAnalyser.disconnect(),s._inputAnalyser2.disconnect(),s._outputAnalyser2.disconnect();return}s._inputAnalyser.getByteFrequencyData(t);let n=s.util.average(t);s._inputAnalyser2.getByteFrequencyData(t);let o=s.util.average(t);s._outputAnalyser.getByteFrequencyData(i);let r=s.util.average(i);s._outputAnalyser2.getByteFrequencyData(i);let a=s.util.average(i);s.onvolume(n/255,r/255,o,a),setTimeout(e,50)},50)},eL.prototype._stopStream=function(){this._shouldManageStream&&this._audioHelper._stopDefaultInputDeviceStream()},eL.prototype._updateInputStreamSource=function(e){this._inputStreamSource&&this._inputStreamSource.disconnect();try{this._inputStreamSource=this._audioContext.createMediaStreamSource(e),this._inputStreamSource.connect(this._inputAnalyser),this._inputStreamSource.connect(this._inputAnalyser2)}catch(e){this._log.warn("Unable to update input MediaStreamSource",e),this._inputStreamSource=null}},eL.prototype._updateOutputStreamSource=function(e){this._outputStreamSource&&this._outputStreamSource.disconnect();try{this._outputStreamSource=this._audioContext.createMediaStreamSource(e),this._outputStreamSource.connect(this._outputAnalyser),this._outputStreamSource.connect(this._outputAnalyser2)}catch(e){this._log.warn("Unable to update output MediaStreamSource",e),this._outputStreamSource=null}},eL.prototype._setInputTracksFromStream=function(e,t){if(!t)return Promise.reject(new x("Can not set input stream to null while in a call"));if(!t.getAudioTracks().length)return Promise.reject(new x("Supplied input stream has no audio tracks"));let i=this.stream,s=()=>(this.mute(this.isMuted),Promise.resolve(this.stream));return i?(this._shouldManageStream&&this._stopStream(),this._sender||(this._sender=this.version.pc.getSenders()[0]),this._sender.replaceTrack(t.getAudioTracks()[0]).then(()=>(this._updateInputStreamSource(t),this.stream=e?ej(t,this.options.MediaStream):t,s()))):(this.stream=e?ej(t,this.options.MediaStream):t,s())},eL.prototype._onInputDevicesChanged=function(){this.stream&&this.stream.getAudioTracks().every(e=>"ended"===e.readyState)&&this._shouldManageStream&&this.openDefaultDeviceWithConstraints({audio:!0})},eL.prototype._onIceGatheringFailure=function(e){this._hasIceGatheringFailures=!0,this.onicegatheringfailure(e)},eL.prototype._onMediaConnectionStateChange=function(e){let t,i=this._iceState;if(i!==e&&("connected"===e||"disconnected"===e||"failed"===e))switch(this._iceState=e,e){case"connected":"disconnected"===i||"failed"===i?(t="ICE liveliness check succeeded. Connection with Twilio restored",this._log.info(t),this.onreconnected(t)):(t="Media connection established.",this._log.info(t),this.onconnected(t)),this._stopIceGatheringTimeout(),this._hasIceGatheringFailures=!1;break;case"disconnected":t="ICE liveliness check failed. May be having trouble connecting to Twilio",this._log.warn(t),this.ondisconnected(t);break;case"failed":t="Connection with Twilio was interrupted.",this._log.warn(t),this.onfailed(t)}},eL.prototype._setSinkIds=function(e){return this._isSinkSupported?(this.sinkIds=new Set(e.forEach?e:[e]),this.version?this._updateAudioOutputs():Promise.resolve()):Promise.reject(new k("Audio output selection is not supported by this browser"))},eL.prototype._startIceGatheringTimeout=function(){this._stopIceGatheringTimeout(),this._iceGatheringTimeoutId=setTimeout(()=>{this._onIceGatheringFailure("timeout")},15e3)},eL.prototype._stopIceGatheringTimeout=function(){clearInterval(this._iceGatheringTimeoutId)},eL.prototype._updateAudioOutputs=function(){let e=Array.from(this.sinkIds).filter(function(e){return!this.outputs.has(e)},this),t=Array.from(this.outputs.keys()).filter(function(e){return!this.sinkIds.has(e)},this),i=this;return Promise.all(e.map(this._createAudioOutput,this)).then(()=>Promise.all(t.map(i._removeAudioOutput,i)))},eL.prototype._createAudio=function(e){let t=new Audio(e);return this.onaudio(t),t},eL.prototype._createAudioOutput=function(e){let t=null;this._mediaStreamSource&&(t=this._audioContext.createMediaStreamDestination(),this._mediaStreamSource.connect(t));let i=this._createAudio();e$(i,t&&t.stream?t.stream:this.pcStream);let s=this;return i.setSinkId(e).then(()=>i.play()).then(()=>{s.outputs.set(e,{audio:i,dest:t})})},eL.prototype._removeAudioOutputs=function(){return this._masterAudio&&void 0!==this._masterAudioDeviceId&&(this._disableOutput(this,this._masterAudioDeviceId),this.outputs.delete(this._masterAudioDeviceId),this._masterAudioDeviceId=null,this._masterAudio.paused||this._masterAudio.pause(),void 0!==this._masterAudio.srcObject?this._masterAudio.srcObject=null:this._masterAudio.src="",this._masterAudio=null),Array.from(this.outputs.keys()).map(this._removeAudioOutput,this)},eL.prototype._disableOutput=function(e,t){let i=e.outputs.get(t);i&&(i.audio&&(i.audio.pause(),i.audio.src=""),i.dest&&i.dest.disconnect())},eL.prototype._reassignMasterOutput=function(e,t){let i=e.outputs.get(t);e.outputs.delete(t);let s=this,n=Array.from(e.outputs.keys())[0],o="string"==typeof n?n:"default";return i.audio.setSinkId(o).then(()=>{s._disableOutput(e,o),e.outputs.set(o,i),e._masterAudioDeviceId=o}).catch(function(){e.outputs.set(t,i),s._log.info("Could not reassign master output. Attempted to roll back.")})},eL.prototype._removeAudioOutput=function(e){return this._masterAudioDeviceId===e?this._reassignMasterOutput(this,e):(this._disableOutput(this,e),this.outputs.delete(e),Promise.resolve())},eL.prototype._onAddTrack=function(e,t){let i=e._masterAudio=this._createAudio();e$(i,t),i.play();let s=Array.from(e.outputs.keys())[0],n="string"==typeof s?s:"default";e._masterAudioDeviceId=n,e.outputs.set(n,{audio:i});try{e._mediaStreamSource=e._audioContext.createMediaStreamSource(t)}catch(e){this._log.warn("Unable to create a MediaStreamSource from onAddTrack",e),this._mediaStreamSource=null}e.pcStream=t,e._updateAudioOutputs()},eL.prototype._fallbackOnAddTrack=function(e,t){let i=document&&document.createElement("audio");i.autoplay=!0,e$(i,t)||e._log.info("Error attaching stream to element."),e.outputs.set("default",{audio:i})},eL.prototype._setEncodingParameters=function(e){if(!e||!this._sender||"function"!=typeof this._sender.getParameters||"function"!=typeof this._sender.setParameters)return;let t=this._sender.getParameters();(t.priority||t.encodings&&t.encodings.length)&&(t.priority="high",t.encodings&&t.encodings.length&&t.encodings.forEach(e=>{e.priority="high",e.networkPriority="high"}),this._sender.setParameters(t))},eL.prototype._setupPeerConnection=function(e){var t,i;let s=this,n=new(this.options.rtcpcFactory||eR)({RTCPeerConnection:this.options.RTCPeerConnection});n.create(e),t=n.pc,i=this.stream,"function"==typeof t.addTrack?i.getAudioTracks().forEach(e=>{t.addTrack(e,i)}):t.addStream(i);let o=RTCRtpReceiver.getCapabilities("audio").codecs;this._log.debug("sorting codecs",o,this.codecPreferences);let r=q(o,this.codecPreferences),[a]=n.pc.getTransceivers();this._log.debug("setting sorted codecs",r),a.setCodecPreferences(r);let l="ontrack"in n.pc?"ontrack":"onaddstream";return n.pc[l]=e=>{let t=s._remoteStream=e.stream||e.streams[0];"function"==typeof n.pc.getSenders&&(this._sender=n.pc.getSenders()[0]),s._isSinkSupported?s._onAddTrack(s,t):s._fallbackOnAddTrack(s,t),s._startPollingVolume()},n},eL.prototype._maybeSetIceAggressiveNomination=function(e){return this.options.forceAggressiveIceNomination?F(window,window.navigator)?e.split("\n").filter(e=>-1===e.indexOf("a=ice-lite")).join("\n"):e:e},eL.prototype._setupChannel=function(){let e=this.version.pc;this.version.pc.onopen=()=>{this.status="open",this.onopen()},this.version.pc.onstatechange=()=>{this.version.pc&&"stable"===this.version.pc.readyState&&(this.status="open",this.onopen())},this.version.pc.onsignalingstatechange=()=>{let t=e.signalingState;this._log.info(`signalingState is "${t}"`),this.version.pc&&"stable"===this.version.pc.signalingState&&(this.status="open",this.onopen()),this.onsignalingstatechange(e.signalingState)},e.onconnectionstatechange=t=>{let i=e.connectionState;if(!i&&t&&t.target){let e=t.target;i=e.connectionState||e.connectionState_,this._log.info(`pc.connectionState not detected. Using target PC. State=${i}`)}i?this._log.info(`pc.connectionState is "${i}"`):this._log.warn(`onconnectionstatechange detected but state is "${i}"`),this.onpcconnectionstatechange(i),this._onMediaConnectionStateChange(i)},e.onicecandidate=e=>{let{candidate:t}=e;t&&(this._hasIceCandidates=!0,this.onicecandidate(t),this._setupRTCIceTransportListener()),this._log.info(`ICE Candidate: ${JSON.stringify(t)}`)},e.onicegatheringstatechange=()=>{let t=e.iceGatheringState;"gathering"===t?this._startIceGatheringTimeout():"complete"===t&&(this._stopIceGatheringTimeout(),this._hasIceCandidates||this._onIceGatheringFailure("none"),this._hasIceCandidates&&this._hasIceGatheringFailures&&this._startIceGatheringTimeout()),this._log.info(`pc.iceGatheringState is "${e.iceGatheringState}"`),this.onicegatheringstatechange(t)},e.oniceconnectionstatechange=()=>{this._log.info(`pc.iceConnectionState is "${e.iceConnectionState}"`),this.oniceconnectionstatechange(e.iceConnectionState),this._onMediaConnectionStateChange(e.iceConnectionState)}},eL.prototype._initializeMediaStream=function(e){return"open"!==this.status&&("disconnected"===this.pstream.status?(this.onerror({info:{code:31e3,message:"Cannot establish connection. Client is disconnected",twilioError:new d.ConnectionDisconnected}}),this.close(),!1):(this.version=this._setupPeerConnection(e),this._setupChannel(),!0))},eL.prototype._removeReconnectionListeners=function(){this.pstream&&(this.pstream.removeListener("answer",this._onAnswerOrRinging),this.pstream.removeListener("hangup",this._onHangup))},eL.prototype._setupRTCDtlsTransportListener=function(){let e=this.getRTCDtlsTransport();if(!e||e.onstatechange)return;let t=()=>{this._log.info(`dtlsTransportState is "${e.state}"`),this.ondtlstransportstatechange(e.state)};t(),e.onstatechange=t},eL.prototype._setupRTCIceTransportListener=function(){let e=this._getRTCIceTransport();e&&!e.onselectedcandidatepairchange&&(e.onselectedcandidatepairchange=()=>this.onselectedcandidatepairchange(e.getSelectedCandidatePair()))},eL.prototype.iceRestart=function(){this._log.info("Attempting to restart ICE..."),this._hasIceCandidates=!1,this.version.createOffer(this.options.maxAverageBitrate,{iceRestart:!0}).then(()=>{this._removeReconnectionListeners(),this._onAnswerOrRinging=e=>{if(this._removeReconnectionListeners(),!e.sdp||"have-local-offer"!==this.version.pc.signalingState){let t=`Invalid state or param during ICE Restart:hasSdp:${!!e.sdp}, signalingState:${this.version.pc.signalingState}`;this._log.warn(t);return}let t=this._maybeSetIceAggressiveNomination(e.sdp);this._answerSdp=t,"closed"!==this.status&&this.version.processAnswer(this.codecPreferences,t,null,e=>{let t=e&&e.message?e.message:e;this._log.error(`Failed to process answer during ICE Restart. Error: ${t}`)})},this._onHangup=()=>{this._log.info("Received hangup during ICE Restart"),this._removeReconnectionListeners()},this.pstream.on("answer",this._onAnswerOrRinging),this.pstream.on("hangup",this._onHangup),this.pstream.reinvite(this.version.getSDP(),this.callSid)}).catch(e=>{let t=e&&e.message?e.message:e;this._log.error(`Failed to createOffer during ICE Restart. Error: ${t}`),this.onfailed(t)})},eL.prototype.makeOutgoingCall=function(e,t,i,s,n){if(!this._initializeMediaStream(s))return;let o=this;function r(){o.options&&o._setEncodingParameters(o.options.dscp),n(o.version.pc)}function a(e){let t=e.message||e;o.onerror({info:{code:31e3,message:`Error processing answer: ${t}`,twilioError:new h.ClientRemoteDescFailed}})}this.callSid=i,this._onAnswerOrRinging=e=>{if(!e.sdp)return;let t=this._maybeSetIceAggressiveNomination(e.sdp);o._answerSdp=t,"closed"!==o.status&&o.version.processAnswer(this.codecPreferences,t,r,a),o.pstream.removeListener("answer",o._onAnswerOrRinging),o.pstream.removeListener("ringing",o._onAnswerOrRinging)},this.pstream.on("answer",this._onAnswerOrRinging),this.pstream.on("ringing",this._onAnswerOrRinging),this.version.createOffer(this.options.maxAverageBitrate,{audio:!0},function(){"closed"!==o.status&&(t?o.pstream.reconnect(o.version.getSDP(),o.callSid,t):o.pstream.invite(o.version.getSDP(),o.callSid,e),o._setupRTCDtlsTransportListener())},function(e){let t=e.message||e;o.onerror({info:{code:31e3,message:`Error creating the offer: ${t}`,twilioError:new h.ClientLocalDescFailed}})})},eL.prototype.answerIncomingCall=function(e,t,i,s){if(!this._initializeMediaStream(i))return;t=this._maybeSetIceAggressiveNomination(t),this._answerSdp=t.replace(/^a=setup:actpass$/gm,"a=setup:passive"),this.callSid=e;let n=this;this.version.processSDP(this.options.maxAverageBitrate,this.codecPreferences,t,{audio:!0},function(){"closed"!==n.status&&(n.pstream.answer(n.version.getSDP(),e),n.options&&n._setEncodingParameters(n.options.dscp),s(n.version.pc),n._setupRTCDtlsTransportListener())},function(e){let t=e.message||e;n.onerror({info:{code:31e3,message:`Error creating the answer: ${t}`,twilioError:new h.ClientRemoteDescFailed}})})},eL.prototype.close=function(){this.version&&this.version.pc&&("closed"!==this.version.pc.signalingState&&this.version.pc.close(),this.version.pc=null),this.stream&&(this.mute(!1),this._stopStream()),this.stream=null,this._removeReconnectionListeners(),this._stopIceGatheringTimeout(),Promise.all(this._removeAudioOutputs()).catch(()=>{}),this._mediaStreamSource&&this._mediaStreamSource.disconnect(),this._inputAnalyser&&this._inputAnalyser.disconnect(),this._outputAnalyser&&this._outputAnalyser.disconnect(),this._inputAnalyser2&&this._inputAnalyser2.disconnect(),this._outputAnalyser2&&this._outputAnalyser2.disconnect(),this.status="closed",this.onclose()},eL.prototype.reject=function(e){this.callSid=e},eL.prototype.ignore=function(e){this.callSid=e},eL.prototype.mute=function(e){this.isMuted=e,this.stream&&(this._sender&&this._sender.track?this._sender.track.enabled=!e:("function"==typeof this.stream.getAudioTracks?this.stream.getAudioTracks():this.stream.audioTracks).forEach(t=>{t.enabled=!e}))},eL.prototype.getOrCreateDTMFSender=function(){if(this._dtmfSender||this._dtmfSenderUnsupported)return this._dtmfSender||null;let e=this,t=this.version.pc;if(!t)return this._log.warn("No RTCPeerConnection available to call createDTMFSender on"),null;if("function"==typeof t.getSenders&&("function"==typeof RTCDTMFSender||"function"==typeof RTCDtmfSender)){let e=t.getSenders().find(e=>e.dtmf);if(e)return this._log.info("Using RTCRtpSender#dtmf"),this._dtmfSender=e.dtmf,this._dtmfSender}if("function"==typeof t.createDTMFSender&&"function"==typeof t.getLocalStreams){let i=t.getLocalStreams().map(t=>{let i=e._getAudioTracks(t);return i&&i[0]})[0];return i?(this._log.info("Creating RTCDTMFSender"),this._dtmfSender=t.createDTMFSender(i),this._dtmfSender):(this._log.warn("No local audio MediaStreamTrack available on the RTCPeerConnection to pass to createDTMFSender"),null)}return this._log.info("RTCPeerConnection does not support RTCDTMFSender"),this._dtmfSenderUnsupported=!0,null},eL.prototype.getRTCDtlsTransport=function(){let e=this.version&&this.version.pc&&"function"==typeof this.version.pc.getSenders&&this.version.pc.getSenders()[0];return e&&e.transport||null},eL.prototype._canStopMediaStreamTrack=()=>"function"==typeof MediaStreamTrack.prototype.stop,eL.prototype._getAudioTracks=e=>"function"==typeof e.getAudioTracks?e.getAudioTracks():e.audioTracks,eL.prototype._getRTCIceTransport=function(){let e=this.getRTCDtlsTransport();return e&&e.iceTransport||null},eL.protocol=eR.test()?new eR:null,eL.enabled=eR.test();class eU{constructor(){this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}get promise(){return this._promise}reject(e){this._reject(e)}resolve(e){this._resolve(e)}}class eH{constructor(){this._operations=[]}enqueue(e){let t=!!this._operations.length,i=new eU;return this._operations.push({deferred:i,callback:e}),t||this._processQueue(),i.promise}_processQueue(){return(0,v.sH)(this,void 0,void 0,function*(){for(;this._operations.length;){let e,t,i,{deferred:s,callback:n}=this._operations[0];try{e=yield n(),i=!0}catch(e){t=e}this._operations.shift(),i?s.resolve(e):s.reject(t)}})}}class eW{get reject(){return this._reject}get resolve(){return this._resolve}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}}class eV{constructor(){this._eventEmitter=new _.EventEmitter}addEventListener(e,t){return this._eventEmitter.addListener(e,t)}dispatchEvent(e,...t){return this._eventEmitter.emit(e,...t)}removeEventListener(e,t){return this._eventEmitter.removeListener(e,t)}}class eB extends eV{get destination(){return this._destination}get loop(){return this._loop}set loop(e){let t=this;e||!this.loop||this.paused||this._audioNode.addEventListener("ended",function e(){t._audioNode.removeEventListener("ended",e),t.pause()}),this._loop=e}get muted(){return 0===this._gainNode.gain.value}set muted(e){this._gainNode.gain.value=+!e}get paused(){return null===this._audioNode}get src(){return this._src}set src(e){this._load(e)}get srcObject(){return this._audioElement.srcObject}set srcObject(e){this._audioElement.srcObject=e}get sinkId(){return this._sinkId}constructor(e,t={},i={}){super(),this._audioNode=null,this._loop=!1,this._pendingPlayDeferreds=[],this._sinkId="default",this._src="","string"!=typeof t&&(i=t),this._audioContext=e,this._audioElement=new(i.AudioFactory||Audio),this._bufferPromise=this._createPlayDeferred().promise,this._destination=this._audioContext.destination,this._gainNode=this._audioContext.createGain(),this._gainNode.connect(this._destination),this._XMLHttpRequest=i.XMLHttpRequestFactory||XMLHttpRequest,this.addEventListener("canplaythrough",()=>{this._resolvePlayDeferreds()}),"string"==typeof t&&(this.src=t)}load(){this._load(this._src)}pause(){this.paused||(this._audioElement.pause(),this._audioNode.stop(),this._audioNode.disconnect(this._gainNode),this._audioNode=null,this._rejectPlayDeferreds(Error("The play() request was interrupted by a call to pause().")))}play(){return(0,v.sH)(this,void 0,void 0,function*(){if(!this.paused){if(yield this._bufferPromise,!this.paused)return;throw Error("The play() request was interrupted by a call to pause().")}this._audioNode=this._audioContext.createBufferSource(),this._audioNode.loop=this.loop,this._audioNode.addEventListener("ended",()=>{this._audioNode&&this._audioNode.loop||this.dispatchEvent("ended")});let e=yield this._bufferPromise;if(this.paused)throw Error("The play() request was interrupted by a call to pause().");if(this._audioNode.buffer=e,this._audioNode.connect(this._gainNode),this._audioNode.start(),this._audioElement.srcObject)return this._audioElement.play()})}setSinkId(e){return(0,v.sH)(this,void 0,void 0,function*(){if("function"!=typeof this._audioElement.setSinkId)throw Error("This browser does not support setSinkId.");if(e!==this.sinkId){if("default"===e){this.paused||this._gainNode.disconnect(this._destination),this._audioElement.srcObject=null,this._destination=this._audioContext.destination,this._gainNode.connect(this._destination),this._sinkId=e;return}yield this._audioElement.setSinkId(e),this._audioElement.srcObject||(this._gainNode.disconnect(this._audioContext.destination),this._destination=this._audioContext.createMediaStreamDestination(),this._audioElement.srcObject=this._destination.stream,this._sinkId=e,this._gainNode.connect(this._destination))}})}_createPlayDeferred(){let e=new eW;return this._pendingPlayDeferreds.push(e),e}_load(e){this._src&&this._src!==e&&this.pause(),this._src=e,this._bufferPromise=new Promise((t,i)=>(0,v.sH)(this,void 0,void 0,function*(){if(!e)return this._createPlayDeferred().promise;let i=yield function(e,t,i){return(0,v.sH)(this,void 0,void 0,function*(){let s=new t;s.open("GET",i,!0),s.responseType="arraybuffer";let n=yield new Promise(e=>{s.addEventListener("load",e),s.send()});try{return e.decodeAudioData(n.target.response)}catch(t){return new Promise(t=>{e.decodeAudioData(n.target.response,t)})}})}(this._audioContext,this._XMLHttpRequest,e);this.dispatchEvent("canplaythrough"),t(i)}))}_rejectPlayDeferreds(e){let t=this._pendingPlayDeferreds;t.splice(0,t.length).forEach(({reject:t})=>t(e))}_resolvePlayDeferreds(e){let t=this._pendingPlayDeferreds;t.splice(0,t.length).forEach(({resolve:t})=>t(e))}}function ez(e,t,i){if(!(this instanceof ez))return new ez(e,t,i);if(!e||!t)throw new x("name and url are required arguments");(i=Object.assign({AudioFactory:"undefined"!=typeof Audio?Audio:null,maxDuration:0,shouldLoop:!1},i)).AudioPlayer=i.audioContext?eB.bind(eB,i.audioContext):i.AudioFactory,Object.defineProperties(this,{_Audio:{value:i.AudioPlayer},_activeEls:{value:new Map},_isSinkSupported:{value:null!==i.AudioFactory&&"function"==typeof i.AudioFactory.prototype.setSinkId},_maxDuration:{value:i.maxDuration},_maxDurationTimeout:{value:null,writable:!0},_operations:{value:new eH},_playPromise:{value:null,writable:!0},_shouldLoop:{value:i.shouldLoop},_sinkIds:{value:["default"]},isPlaying:{enumerable:!0,get(){return!!this._playPromise}},name:{enumerable:!0,value:e},url:{enumerable:!0,value:t}}),this._Audio&&this._play(!0,!1)}function eq(e){e&&(e.pause(),e.src="",e.srcObject=null,e.load())}ez.prototype._playAudioElement=function(e,t,i){let s=this._activeEls.get(e);if(!s)throw new x(`sinkId: "${e}" doesn't have an audio element`);return s.muted=!!t,s.loop=!!i,s.play().then(()=>s).catch(t=>{throw eq(s),this._activeEls.delete(e),t})},ez.prototype._play=function(e,t){this.isPlaying&&this._stop(),this._maxDuration>0&&(this._maxDurationTimeout=setTimeout(this._stop.bind(this),this._maxDuration)),t="boolean"==typeof t?t:this._shouldLoop;let i=this;return this._playPromise=Promise.all(this._sinkIds.map(function(s){if(!i._Audio)return Promise.resolve();let n=i._activeEls.get(s);return n?i._playAudioElement(s,e,t):("function"==typeof(n=new i._Audio(i.url)).setAttribute&&n.setAttribute("crossorigin","anonymous"),new Promise(e=>{n.addEventListener("canplaythrough",e)}).then(()=>(i._isSinkSupported?n.setSinkId(s):Promise.resolve()).then(function(){return(i._activeEls.set(s,n),i._playPromise)?i._playAudioElement(s,e,t):Promise.resolve()})))}))},ez.prototype._stop=function(){this._activeEls.forEach((e,t)=>{this._sinkIds.includes(t)?(e.pause(),e.currentTime=0):(eq(e),this._activeEls.delete(t))}),clearTimeout(this._maxDurationTimeout),this._playPromise=null,this._maxDurationTimeout=null},ez.prototype.setSinkIds=function(e){this._isSinkSupported&&(e=e.forEach?e:[e],[].splice.apply(this._sinkIds,[0,this._sinkIds.length].concat(e)))},ez.prototype.stop=function(){this._operations.enqueue(()=>(this._stop(),Promise.resolve()))},ez.prototype.play=function(){return this._operations.enqueue(()=>this._play())};class eG extends _.EventEmitter{static get audioContext(){return eG._audioContext}static get extension(){let e,t,i="undefined"!=typeof document?document.createElement("audio"):{canPlayType:!1};try{e=i.canPlayType&&!!i.canPlayType("audio/mpeg").replace(/no/,"")}catch(t){e=!1}try{t=i.canPlayType&&!!i.canPlayType("audio/ogg;codecs='vorbis'").replace(/no/,"")}catch(e){t=!1}return t&&!e?"ogg":"mp3"}static get isSupported(){return eR.test()}static get packageName(){return E}static runPreflight(e,t){return new ev(e,Object.assign({audioContext:eG._getOrCreateAudioContext()},t))}static toString(){return"[Twilio.Device class]"}static get version(){return I}static _getOrCreateAudioContext(){return eG._audioContext||("undefined"!=typeof AudioContext?eG._audioContext=new AudioContext:"undefined"!=typeof webkitAudioContext&&(eG._audioContext=new webkitAudioContext)),eG._audioContext}constructor(e,t={}){if(super(),this._activeCall=null,this._audio=null,this._audioProcessorEventObserver=null,this._callInputStream=null,this._calls=[],this._callSinkIds=["default"],this._chunderURIs=[],this._defaultOptions={allowIncomingWhileBusy:!1,closeProtection:!1,codecPreferences:[e5.Codec.PCMU,e5.Codec.Opus],dscp:!0,enableImprovedSignalingErrorPrecision:!1,forceAggressiveIceNomination:!1,logLevel:y.levels.ERROR,maxCallSignalingTimeoutMs:0,preflight:!1,sounds:{},tokenRefreshMs:1e4,voiceEventSidGenerator:eF},this._edge=null,this._home=null,this._identity=null,this._log=new D("Device"),this._makeCallPromise=null,this._options={},this._preferredURI=null,this._publisher=null,this._region=null,this._regTimer=null,this._shouldReRegister=!1,this._soundcache=new Map,this._state=eG.State.Unregistered,this._stateEventMapping={[eG.State.Destroyed]:eG.EventName.Destroyed,[eG.State.Unregistered]:eG.EventName.Unregistered,[eG.State.Registering]:eG.EventName.Registering,[eG.State.Registered]:eG.EventName.Registered},this._stream=null,this._streamConnectedPromise=null,this._tokenWillExpireTimeout=null,this._createDefaultPayload=e=>{let t={aggressive_nomination:this._options.forceAggressiveIceNomination,browser_extension:this._isBrowserExtension,dscp:!!this._options.dscp,ice_restart_enabled:!0,platform:"undefined"!=typeof RTCIceGatherer?"ORTC":"WebRTC",sdk_version:I};function i(e,i){i&&(t[e]=i)}if(e){let s=e.parameters.CallSid;i("call_sid",/^TJ/.test(s)?void 0:s),i("temp_call_sid",e.outboundConnectionId),i("audio_codec",e.codec),t.direction=e.direction}return i("gateway",this._stream&&this._stream.gateway),i("region",this._stream&&this._stream.region),t},this._onSignalingClose=()=>{this._stream=null,this._streamConnectedPromise=null},this._onSignalingConnected=e=>{var t;let i=ew[e.region]||null;if(this._edge=e.edge||eC[i]||e.region,this._region=i||e.region,this._home=e.home,null==(t=this._publisher)||t.setHost(ek(e.home)),e.token&&(this._identity=e.token.identity,"number"==typeof e.token.ttl&&"number"==typeof this._options.tokenRefreshMs)){let t=Math.max(0,1e3*e.token.ttl-this._options.tokenRefreshMs);this._tokenWillExpireTimeout=setTimeout(()=>{this._log.debug("#tokenWillExpire"),this.emit("tokenWillExpire",this),this._tokenWillExpireTimeout&&(clearTimeout(this._tokenWillExpireTimeout),this._tokenWillExpireTimeout=null)},t)}let s=this._getChunderws()||eI(this._edge);if(s.length>0){let[e]=s;this._preferredURI=eE(e)}else this._log.warn("Could not parse a preferred URI from the stream#connected event.");this._shouldReRegister&&this.register()},this._onSignalingError=e=>{if("object"!=typeof e)return void this._log.warn("Invalid signaling error payload",e);let{error:t,callsid:i,voiceeventsid:n}=e;if("object"!=typeof t||n)return void this._log.warn("Ignoring signaling error payload",{originalError:t,voiceeventsid:n});let o="string"==typeof i&&this._findCall(i)||void 0,{code:r,message:l}=t,{twilioError:c}=t;if("number"==typeof r)if(31201===r)c=new s.AuthenticationFailed(t);else if(31204===r)c=new s.AccessTokenInvalid(t);else if(31205===r)this._stopRegistrationTimer(),c=new s.AccessTokenExpired(t);else{let e=C(!!this._options.enableImprovedSignalingErrorPrecision,r);void 0!==e&&(c=new e(t))}c||(this._log.error("Unknown signaling error: ",t),c=new a.UnknownError(l,t)),this._log.error("Received error: ",c),this._log.debug("#error",t),this.emit(eG.EventName.Error,c,o)},this._onSignalingInvite=e=>(0,v.sH)(this,void 0,void 0,function*(){var t;let i,s=!!this._activeCall;if(s&&!this._options.allowIncomingWhileBusy)return void this._log.info("Device busy; ignoring incoming invite");if(!e.callsid||!e.sdp){this._log.debug("#error",e),this.emit(eG.EventName.Error,new o.BadRequest("Malformed invite from gateway"));return}let n=e.parameters||{};n.CallSid=n.CallSid||e.callsid;let r=Object.assign({},V(n.Params));this._makeCallPromise=this._makeCall(r,{callParameters:n,enableImprovedSignalingErrorPrecision:!!this._options.enableImprovedSignalingErrorPrecision,offerSdp:e.sdp,reconnectToken:e.reconnect,voiceEventSidGenerator:this._options.voiceEventSidGenerator});try{i=yield this._makeCallPromise}finally{this._makeCallPromise=null}this._calls.push(i),i.once("accept",()=>{this._soundcache.get(eG.SoundName.Incoming).stop(),this._publishNetworkChange()});let a=(null==(t=this._audio)?void 0:t.incoming())&&!s?()=>this._soundcache.get(eG.SoundName.Incoming).play():()=>Promise.resolve();this._showIncomingCall(i,a)}),this._onSignalingOffline=()=>{this._log.info("Stream is offline"),this._edge=null,this._region=null,this._shouldReRegister=this.state!==eG.State.Unregistered,this._setState(eG.State.Unregistered)},this._onSignalingReady=()=>{this._log.info("Stream is ready"),this._setState(eG.State.Registered)},this._publishNetworkChange=()=>{this._activeCall&&this._networkInformation&&this._publisher.info("network-information","network-change",{connection_type:this._networkInformation.type,downlink:this._networkInformation.downlink,downlinkMax:this._networkInformation.downlinkMax,effective_type:this._networkInformation.effectiveType,rtt:this._networkInformation.rtt},this._activeCall)},this._updateInputStream=e=>{let t=this._activeCall;return t&&!e?Promise.reject(new T("Cannot unset input device while a call is in progress.")):(this._callInputStream=e,t?t._setInputTracksFromStream(e):Promise.resolve())},this._updateSinkIds=(e,t)=>("ringtone"===e?this._updateRingtoneSinkIds(t):this._updateSpeakerSinkIds(t)).then(()=>{this._publisher.info("audio",`${e}-devices-set`,{audio_device_ids:t},this._activeCall)},i=>{throw this._publisher.error("audio",`${e}-devices-set-failed`,{audio_device_ids:t,message:i.message},this._activeCall),i}),this._setupLoglevel(t.logLevel),this._logOptions("constructor",t),this.updateToken(e),H())throw new k("Microsoft Edge Legacy (https://support.microsoft.com/en-us/help/4533505/what-is-microsoft-edge-legacy) is deprecated and will not be able to connect to Twilio to make or receive calls after September 1st, 2020. Please see this documentation for a list of supported browsers https://www.twilio.com/docs/voice/client/javascript#supported-browsers");if(!eG.isSupported&&t.ignoreBrowserSupport){if(window&&window.location&&"http:"===window.location.protocol)throw new k("twilio.js wasn't able to find WebRTC browser support.           This is most likely because this page is served over http rather than https,           which does not support WebRTC in many browsers. Please load this page over https and           try again.");throw new k("twilio.js 1.3+ SDKs require WebRTC browser support.         For more information, see <https://www.twilio.com/docs/api/client/twilio-js>.         If you have any questions about this announcement, please contact         Twilio Support at <help@twilio.com>.")}let i=globalThis,n=i.msBrowser||i.browser||i.chrome;if(this._isBrowserExtension=!!n&&!!n.runtime&&!!n.runtime.id||!!i.safari&&!!i.safari.extension,this._isBrowserExtension&&this._log.info("Running as browser extension."),navigator){let e=navigator;this._networkInformation=e.connection||e.mozConnection||e.webkitConnection}this._networkInformation&&"function"==typeof this._networkInformation.addEventListener&&this._networkInformation.addEventListener("change",this._publishNetworkChange),eG._getOrCreateAudioContext(),eG._audioContext&&!eG._dialtonePlayer&&(eG._dialtonePlayer=new Z(eG._audioContext)),this._boundDestroy=this.destroy.bind(this),this._boundConfirmClose=this._confirmClose.bind(this),"undefined"!=typeof window&&window.addEventListener&&(window.addEventListener("unload",this._boundDestroy),window.addEventListener("pagehide",this._boundDestroy)),this.updateOptions(t)}get audio(){return this._audio}connect(){return(0,v.sH)(this,arguments,void 0,function*(e={}){let t,i,s,n;if(this._log.debug(".connect",JSON.stringify(e)),this._throwIfDestroyed(),this._activeCall)throw new T("A Call is already active");if(e.connectToken){try{let n=JSON.parse(decodeURIComponent(atob(e.connectToken)));t=n.customParameters,i=n.parameters,s=n.signalingReconnectToken}catch(e){throw new x("Cannot parse connectToken")}if(!i||!i.CallSid||!s)throw new x("Invalid connectToken")}let o=!1,r={},a={enableImprovedSignalingErrorPrecision:!!this._options.enableImprovedSignalingErrorPrecision,rtcConfiguration:e.rtcConfiguration,voiceEventSidGenerator:this._options.voiceEventSidGenerator};s&&i?(o=!0,a.callParameters=i,a.reconnectCallSid=i.CallSid,a.reconnectToken=s,r=t||r):r=e.params||r,this._makeCallPromise=this._makeCall(r,a,o);try{n=this._activeCall=yield this._makeCallPromise}finally{this._makeCallPromise=null}return this._calls.splice(0).forEach(e=>e.ignore()),this._soundcache.get(eG.SoundName.Incoming).stop(),n.accept({rtcConstraints:e.rtcConstraints}),this._publishNetworkChange(),n})}get calls(){return this._calls}destroy(){var e;this._log.debug(".destroy"),this._log.debug("Rejecting any incoming calls"),this._calls.slice(0).forEach(e=>e.reject()),this.disconnectAll(),this._stopRegistrationTimer(),this._destroyStream(),this._destroyAudioHelper(),null==(e=this._audioProcessorEventObserver)||e.destroy(),this._destroyPublisher(),this._networkInformation&&"function"==typeof this._networkInformation.removeEventListener&&this._networkInformation.removeEventListener("change",this._publishNetworkChange),"undefined"!=typeof window&&window.removeEventListener&&(window.removeEventListener("beforeunload",this._boundConfirmClose),window.removeEventListener("unload",this._boundDestroy),window.removeEventListener("pagehide",this._boundDestroy)),this._setState(eG.State.Destroyed),_.EventEmitter.prototype.removeAllListeners.call(this)}disconnectAll(){this._log.debug(".disconnectAll"),this._calls.splice(0).forEach(e=>e.disconnect()),this._activeCall&&this._activeCall.disconnect()}get edge(){return this._edge}get home(){return this._home}get identity(){return this._identity}get isBusy(){return!!this._activeCall}register(){return(0,v.sH)(this,void 0,void 0,function*(){if(this._log.debug(".register"),this.state!==eG.State.Unregistered)throw new T(`Attempt to register when device is in state "${this.state}". Must be "${eG.State.Unregistered}".`);this._shouldReRegister=!1,this._setState(eG.State.Registering),yield this._streamConnectedPromise||this._setupStream(),yield this._sendPresence(!0),yield z(this,eG.State.Registered,eG.State.Unregistered)})}get state(){return this._state}get token(){return this._token}toString(){return"[Twilio.Device instance]"}unregister(){return(0,v.sH)(this,void 0,void 0,function*(){if(this._log.debug(".unregister"),this.state!==eG.State.Registered)throw new T(`Attempt to unregister when device is in state "${this.state}". Must be "${eG.State.Registered}".`);this._shouldReRegister=!1;let e=yield this._streamConnectedPromise,t=new Promise(t=>{e.on("offline",t)});yield this._sendPresence(!1),yield t})}updateOptions(e={}){if(this._logOptions("updateOptions",e),this.state===eG.State.Destroyed)throw new T(`Attempt to "updateOptions" when device is in state "${this.state}".`);this._options=Object.assign(Object.assign(Object.assign({},this._defaultOptions),this._options),e);let t=new Set(this._chunderURIs),i=this._chunderURIs=(this._getChunderws()||eI(this._options.edge)).map(eE),s=t.size!==i.length;if(!s){for(let e of i)if(!t.has(e)){s=!0;break}}if(this.isBusy&&s)throw new T("Cannot change Edge while on an active Call");for(let e of(this._setupLoglevel(this._options.logLevel),Object.keys(eG._defaultSounds))){let t=eG._defaultSounds[e],i=`${A}/${t.filename}.${eG.extension}?cache=${I}`,s=this._options.sounds&&this._options.sounds[e]||i,n=new(this._options.Sound||ez)(e,s,{audioContext:this._options.disableAudioContextSounds?null:eG.audioContext,maxDuration:t.maxDuration,shouldLoop:t.shouldLoop});this._soundcache.set(e,n)}this._setupAudioHelper(),this._setupPublisher(),s&&this._streamConnectedPromise&&this._setupStream(),"undefined"!=typeof window&&"function"==typeof window.addEventListener&&this._options.closeProtection&&(window.removeEventListener("beforeunload",this._boundConfirmClose),window.addEventListener("beforeunload",this._boundConfirmClose))}updateToken(e){if(this._log.debug(".updateToken"),this.state===eG.State.Destroyed)throw new T(`Attempt to "updateToken" when device is in state "${this.state}".`);if("string"!=typeof e)throw new x('Parameter "token" must be of type "string".');this._token=e,this._stream&&this._stream.setToken(this._token),this._publisher&&this._publisher.setToken(this._token)}_confirmClose(e){if(!this._activeCall)return"";let t=this._options.closeProtection||!1,i="string"!=typeof t?"A call is currently in-progress. Leaving or reloading this page will end the call.":t;return(e||window.event).returnValue=i,i}_destroyAudioHelper(){this._audio&&(this._audio._destroy(),this._audio=null)}_destroyPublisher(){this._publisher&&(this._publisher=null)}_destroyStream(){this._stream&&(this._stream.removeListener("close",this._onSignalingClose),this._stream.removeListener("connected",this._onSignalingConnected),this._stream.removeListener("error",this._onSignalingError),this._stream.removeListener("invite",this._onSignalingInvite),this._stream.removeListener("offline",this._onSignalingOffline),this._stream.removeListener("ready",this._onSignalingReady),this._stream.destroy(),this._stream=null),this._onSignalingOffline(),this._streamConnectedPromise=null}_findCall(e){return this._calls.find(t=>t.parameters.CallSid===e||t.outboundConnectionId===e)||null}_getChunderws(){return"string"==typeof this._options.chunderw?[this._options.chunderw]:Array.isArray(this._options.chunderw)?this._options.chunderw:null}_logOptions(e,t={}){let i=["allowIncomingWhileBusy","appName","appVersion","closeProtection","codecPreferences","disableAudioContextSounds","dscp","edge","enableImprovedSignalingErrorPrecision","forceAggressiveIceNomination","logLevel","maxAverageBitrate","maxCallSignalingTimeoutMs","sounds","tokenRefreshMs"],s=["RTCPeerConnection","enumerateDevices","getUserMedia","MediaStream"];if("object"==typeof t){let n=Object.assign({},t);Object.keys(n).forEach(e=>{i.includes(e)||s.includes(e)||delete n[e],s.includes(e)&&(n[e]=!0)}),this._log.debug(`.${e}`,JSON.stringify(n))}}_makeCall(e,t){return(0,v.sH)(this,arguments,void 0,function*(e,t,i=!1){var s;let n=null==(s=this._audio)?void 0:s._getInputDevicePromise();n&&(this._log.debug("inputDevicePromise detected, waiting..."),yield n,this._log.debug("inputDevicePromise resolved"));let o={audioHelper:this._audio,onIgnore:()=>{this._soundcache.get(eG.SoundName.Incoming).stop()},pstream:yield this._streamConnectedPromise||this._setupStream(),publisher:this._publisher,soundcache:this._soundcache};t=Object.assign({MediaStream:this._options.MediaStream,RTCPeerConnection:this._options.RTCPeerConnection,beforeAccept:e=>{this._activeCall&&this._activeCall!==e&&(this._activeCall.disconnect(),this._removeCall(this._activeCall))},codecPreferences:this._options.codecPreferences,customSounds:this._options.sounds,dialtonePlayer:eG._dialtonePlayer,dscp:this._options.dscp,forceAggressiveIceNomination:this._options.forceAggressiveIceNomination,getInputStream:()=>this._options.fileInputStream||this._callInputStream,getSinkIds:()=>this._callSinkIds,maxAverageBitrate:this._options.maxAverageBitrate,preflight:this._options.preflight,rtcConstraints:this._options.rtcConstraints,shouldPlayDisconnect:()=>{var e;return null==(e=this._audio)?void 0:e.disconnect()},twimlParams:e,voiceEventSidGenerator:this._options.voiceEventSidGenerator},t);let r=()=>{if(!this._stream)return void this._log.warn("UnsetPreferredUri called without a stream");null===this._activeCall&&0===this._calls.length&&this._stream.updatePreferredURI(null)},a=new(this._options.Call||e5)(o,t);return this._publisher.info("settings","init",{MediaStream:!!this._options.MediaStream,RTCPeerConnection:!!this._options.RTCPeerConnection,enumerateDevices:!!this._options.enumerateDevices,getUserMedia:!!this._options.getUserMedia},a),a.once("accept",()=>{var e,t,s;this._stream.updatePreferredURI(this._preferredURI),this._removeCall(a),this._activeCall=a,this._audio&&this._audio._maybeStartPollingVolume(),a.direction===e5.CallDirection.Outgoing&&(null==(e=this._audio)?void 0:e.outgoing())&&!i&&this._soundcache.get(eG.SoundName.Outgoing).play();let n={edge:this._edge||this._region};this._options.edge&&(n.selected_edge=Array.isArray(this._options.edge)?this._options.edge:[this._options.edge]),this._publisher.info("settings","edge",n,a),(null==(t=this._audio)?void 0:t.processedStream)&&(null==(s=this._audioProcessorEventObserver)||s.emit("enabled"))}),a.addListener("error",e=>{"closed"===a.status()&&(this._removeCall(a),r()),this._audio&&this._audio._maybeStopPollingVolume(),this._maybeStopIncomingSound()}),a.once("cancel",()=>{this._log.info(`Canceled: ${a.parameters.CallSid}`),this._removeCall(a),r(),this._audio&&this._audio._maybeStopPollingVolume(),this._maybeStopIncomingSound()}),a.once("disconnect",()=>{this._audio&&this._audio._maybeStopPollingVolume(),this._removeCall(a),r(),this._maybeStopIncomingSound()}),a.once("reject",()=>{this._log.info(`Rejected: ${a.parameters.CallSid}`),this._audio&&this._audio._maybeStopPollingVolume(),this._removeCall(a),r(),this._maybeStopIncomingSound()}),a.on("transportClose",()=>{a.status()===e5.State.Pending&&(this._audio&&this._audio._maybeStopPollingVolume(),this._removeCall(a),this._maybeStopIncomingSound())}),a})}_maybeStopIncomingSound(){this._calls.length||this._soundcache.get(eG.SoundName.Incoming).stop()}_removeCall(e){this._activeCall===e&&(this._activeCall=null,this._makeCallPromise=null);for(let t=this._calls.length-1;t>=0;t--)e===this._calls[t]&&this._calls.splice(t,1)}_sendPresence(e){return(0,v.sH)(this,void 0,void 0,function*(){let t=yield this._streamConnectedPromise;t&&(t.register({audio:e}),e?this._startRegistrationTimer():this._stopRegistrationTimer())})}_setState(e){if(e===this.state)return;this._state=e;let t=this._stateEventMapping[e];this._log.debug(`#${t}`),this.emit(t)}_setupAudioHelper(){this._audioProcessorEventObserver||(this._audioProcessorEventObserver=new K,this._audioProcessorEventObserver.on("event",({name:e,group:t})=>{this._publisher.info(t,e,{},this._activeCall)}));let e={audioContext:eG.audioContext,audioProcessorEventObserver:this._audioProcessorEventObserver,beforeSetInputDevice:()=>this._makeCallPromise?(this._log.debug("beforeSetInputDevice pause detected"),this._makeCallPromise):(this._log.debug("beforeSetInputDevice pause not detected, setting default"),Promise.resolve()),enumerateDevices:this._options.enumerateDevices,getUserMedia:this._options.getUserMedia||eN};if(this._audio){this._log.info("Found existing audio helper; updating options..."),this._audio._updateUserOptions(e);return}this._audio=new(this._options.AudioHelper||X)(this._updateSinkIds,this._updateInputStream,e),this._audio.on("deviceChange",e=>{let t=this._activeCall,i=e.map(e=>e.deviceId);this._publisher.info("audio","device-change",{lost_active_device_ids:i},t),t&&t._mediaHandler._onInputDevicesChanged()})}_setupLoglevel(e){let t="number"==typeof e||"string"==typeof e?e:y.levels.ERROR;this._log.setDefaultLevel(t),this._log.info("Set logger default level to",t)}_setupPublisher(){this._publisher&&(this._log.info("Found existing publisher; destroying..."),this._destroyPublisher());let e={defaultPayload:this._createDefaultPayload,metadata:{app_name:this._options.appName,app_version:this._options.appVersion}};return this._options.eventgw&&(e.host=this._options.eventgw),this._home&&(e.host=ek(this._home)),this._publisher=new(this._options.Publisher||et)("twilio-js-sdk",this.token,e),!1===this._options.publishEvents?this._publisher.disable():this._publisher.on("error",e=>{this._log.warn("Cannot connect to insights.",e)}),this._publisher}_setupStream(){return this._stream&&(this._log.info("Found existing stream; destroying..."),this._destroyStream()),this._log.info("Setting up VSP"),this._stream=new(this._options.PStream||eS)(this.token,this._chunderURIs,{backoffMaxMs:this._options.backoffMaxMs,maxPreferredDurationMs:this._options.maxCallSignalingTimeoutMs}),this._stream.addListener("close",this._onSignalingClose),this._stream.addListener("connected",this._onSignalingConnected),this._stream.addListener("error",this._onSignalingError),this._stream.addListener("invite",this._onSignalingInvite),this._stream.addListener("offline",this._onSignalingOffline),this._stream.addListener("ready",this._onSignalingReady),this._streamConnectedPromise=z(this._stream,"connected","close").then(()=>this._stream)}_showIncomingCall(e,t){let i;return Promise.race([t(),new Promise((e,t)=>{i=setTimeout(()=>{t(Error("Playing incoming ringtone took too long; it might not play. Continuing execution..."))},2e3)})]).catch(e=>{this._log.warn(e.message)}).then(()=>{clearTimeout(i),this._log.debug("#incoming",JSON.stringify({customParameters:e.customParameters,parameters:e.parameters})),this.emit(eG.EventName.Incoming,e)})}_startRegistrationTimer(){this._stopRegistrationTimer(),this._regTimer=setTimeout(()=>{this._sendPresence(!0)},3e4)}_stopRegistrationTimer(){this._regTimer&&clearTimeout(this._regTimer)}_throwIfDestroyed(){if(this.state===eG.State.Destroyed)throw new T("Device has been destroyed.")}_updateRingtoneSinkIds(e){return Promise.resolve(this._soundcache.get(eG.SoundName.Incoming).setSinkIds(e))}_updateSpeakerSinkIds(e){Array.from(this._soundcache.entries()).filter(e=>e[0]!==eG.SoundName.Incoming).forEach(t=>t[1].setSinkIds(e)),this._callSinkIds=e;let t=this._activeCall;return t?t._setSinkIds(e):Promise.resolve()}}eG._defaultSounds={disconnect:{filename:"disconnect",maxDuration:3e3},dtmf0:{filename:"dtmf-0",maxDuration:1e3},dtmf1:{filename:"dtmf-1",maxDuration:1e3},dtmf2:{filename:"dtmf-2",maxDuration:1e3},dtmf3:{filename:"dtmf-3",maxDuration:1e3},dtmf4:{filename:"dtmf-4",maxDuration:1e3},dtmf5:{filename:"dtmf-5",maxDuration:1e3},dtmf6:{filename:"dtmf-6",maxDuration:1e3},dtmf7:{filename:"dtmf-7",maxDuration:1e3},dtmf8:{filename:"dtmf-8",maxDuration:1e3},dtmf9:{filename:"dtmf-9",maxDuration:1e3},dtmfh:{filename:"dtmf-hash",maxDuration:1e3},dtmfs:{filename:"dtmf-star",maxDuration:1e3},incoming:{filename:"incoming",shouldLoop:!0},outgoing:{filename:"outgoing",maxDuration:3e3}},function(e){var t,i,s;(t=e.EventName||(e.EventName={})).Error="error",t.Incoming="incoming",t.Destroyed="destroyed",t.Unregistered="unregistered",t.Registering="registering",t.Registered="registered",t.TokenWillExpire="tokenWillExpire",(i=e.State||(e.State={})).Destroyed="destroyed",i.Unregistered="unregistered",i.Registering="registering",i.Registered="registered",(s=e.SoundName||(e.SoundName={})).Incoming="incoming",s.Outgoing="outgoing",s.Disconnect="disconnect",s.Dtmf0="dtmf0",s.Dtmf1="dtmf1",s.Dtmf2="dtmf2",s.Dtmf3="dtmf3",s.Dtmf4="dtmf4",s.Dtmf5="dtmf5",s.Dtmf6="dtmf6",s.Dtmf7="dtmf7",s.Dtmf8="dtmf8",s.Dtmf9="dtmf9",s.DtmfS="dtmfs",s.DtmfH="dtmfh"}(eG||(eG={}));class eJ{constructor(e,t=!1){let i;this.deleted=!1;let s=e.candidate.split("network-cost ");s[1]&&(i=parseInt(s[1],10)),this.candidateType=e.type,this.ip=e.ip||e.address,this.isRemote=t,this.networkCost=i,this.port=e.port,this.priority=e.priority,this.protocol=e.protocol,this.relatedAddress=e.relatedAddress,this.relatedPort=e.relatedPort,this.tcpType=e.tcpType,this.transportId=e.sdpMid}toPayload(){return{candidate_type:this.candidateType,deleted:this.deleted,ip:this.ip,is_remote:this.isRemote,"network-cost":this.networkCost,port:this.port,priority:this.priority,protocol:this.protocol,related_address:this.relatedAddress,related_port:this.relatedPort,tcp_type:this.tcpType,transport_id:this.transportId}}}function eQ(e){return"number"==typeof e&&!isNaN(e)&&isFinite(e)&&e>=0}var eX={calculate:function(e,t,i){if("number"!=typeof e||"number"!=typeof t||"number"!=typeof i||!eQ(e)||!eQ(t)||!eQ(i))return null;let s=e+2*t+10,n=0;switch(!0){case s<160:n=94.768-s/40;break;case s<1e3:n=94.768-(s-120)/10}return 1+.035*(n=!0==i<=n/2.5?Math.max(n-2.5*i,6.52):0)+7e-6*n*(n-60)*(100-n)},isNonNegativeNumber:eQ};let eK={audioInputLevel:{minStandardDeviation:327.67,sampleCount:10},audioOutputLevel:{minStandardDeviation:327.67,sampleCount:10},bytesReceived:{clearCount:2,min:1,raiseCount:3,sampleCount:3},bytesSent:{clearCount:2,min:1,raiseCount:3,sampleCount:3},jitter:{max:30},mos:{min:3},packetsLostFraction:[{max:1},{clearValue:1,maxAverage:3,sampleCount:7}],rtt:{max:400}};class eY extends _.EventEmitter{constructor(e){super(),this._activeWarnings=new Map,this._currentStreaks=new Map,this._inputVolumes=[],this._outputVolumes=[],this._sampleBuffer=[],this._supplementalSampleBuffers={audioInputLevel:[],audioOutputLevel:[]},this._warningsEnabled=!0,e=e||{},this._getRTCStats=e.getRTCStats||eg,this._mos=e.Mos||eX,this._peerConnection=e.peerConnection,this._thresholds=Object.assign(Object.assign({},eK),e.thresholds);let t=Object.values(this._thresholds).map(e=>e.sampleCount).filter(e=>!!e);this._maxSampleCount=Math.max(5,...t),this._peerConnection&&this.enable(this._peerConnection)}addVolumes(e,t){this._inputVolumes.push(e),this._outputVolumes.push(t)}disable(){return this._sampleInterval&&(clearInterval(this._sampleInterval),delete this._sampleInterval),this}disableWarnings(){return this._warningsEnabled&&this._activeWarnings.clear(),this._warningsEnabled=!1,this}enable(e){if(e){if(this._peerConnection&&e!==this._peerConnection)throw new x("Attempted to replace an existing PeerConnection in StatsMonitor.enable");this._peerConnection=e}if(!this._peerConnection)throw new x("Can not enable StatsMonitor without a PeerConnection");return this._sampleInterval=this._sampleInterval||setInterval(this._fetchSample.bind(this),1e3),this}enableWarnings(){return this._warningsEnabled=!0,this}hasActiveWarning(e,t){let i=`${e}:${t}`;return!!this._activeWarnings.get(i)}_addSample(e){let t=this._sampleBuffer;t.push(e),t.length>this._maxSampleCount&&t.splice(0,t.length-this._maxSampleCount)}_clearWarning(e,t,i){let s=`${e}:${t}`,n=this._activeWarnings.get(s);!n||Date.now()-n.timeRaised<5e3||(this._activeWarnings.delete(s),this.emit("warning-cleared",Object.assign(Object.assign({},i),{name:e,threshold:{name:t,value:this._thresholds[e][t]}})))}_createSample(e,t){let i=t&&t.totals.bytesSent||0,s=t&&t.totals.bytesReceived||0,n=t&&t.totals.packetsSent||0,o=t&&t.totals.packetsReceived||0,r=t&&t.totals.packetsLost||0,a=e.bytesSent-i,l=e.bytesReceived-s,c=e.packetsSent-n,d=e.packetsReceived-o,h=e.packetsLost-r,u=d+h,p=u>0?h/u*100:0,m=e.packetsReceived+e.packetsLost,g=m>0?e.packetsLost/m*100:100,_="number"!=typeof e.rtt&&t?t.rtt:e.rtt,f=this._inputVolumes.splice(0);this._supplementalSampleBuffers.audioInputLevel.push(f);let v=this._outputVolumes.splice(0);return this._supplementalSampleBuffers.audioOutputLevel.push(v),{audioInputLevel:Math.round(j(f)),audioOutputLevel:Math.round(j(v)),bytesReceived:l,bytesSent:a,codecName:e.codecName,jitter:e.jitter,mos:this._mos.calculate(_,e.jitter,t&&p),packetsLost:h,packetsLostFraction:p,packetsReceived:d,packetsSent:c,rtt:_,timestamp:e.timestamp,totals:{bytesReceived:e.bytesReceived,bytesSent:e.bytesSent,packetsLost:e.packetsLost,packetsLostFraction:g,packetsReceived:e.packetsReceived,packetsSent:e.packetsSent}}}_fetchSample(){this._getSample().then(e=>{this._addSample(e),this._raiseWarnings(),this.emit("sample",e)}).catch(e=>{this.disable(),this.emit("error",e)})}_getSample(){return this._getRTCStats(this._peerConnection).then(e=>{let t=null;return this._sampleBuffer.length&&(t=this._sampleBuffer[this._sampleBuffer.length-1]),this._createSample(e,t)})}_raiseWarning(e,t,i){let s,n=`${e}:${t}`;if(this._activeWarnings.has(n))return;this._activeWarnings.set(n,{timeRaised:Date.now()});let o=this._thresholds[e];if(Array.isArray(o)){let e=o.find(e=>t in e);e&&(s=e[t])}else s=this._thresholds[e][t];this.emit("warning",Object.assign(Object.assign({},i),{name:e,threshold:{name:t,value:s}}))}_raiseWarnings(){this._warningsEnabled&&Object.keys(this._thresholds).forEach(e=>this._raiseWarningsForStat(e))}_raiseWarningsForStat(e){(Array.isArray(this._thresholds[e])?this._thresholds[e]:[this._thresholds[e]]).forEach(t=>{let i,s=this._sampleBuffer,n=t.clearCount||0,o=t.raiseCount||3,r=t.sampleCount||this._maxSampleCount,a=s.slice(-r),l=a.map(t=>t[e]);if(!l.some(e=>null==e)){var c,d;if("number"==typeof t.max&&(c=t.max,(i=l.reduce((e,t)=>e+=+(t>c),0))>=o?this._raiseWarning(e,"max",{values:l,samples:a}):i<=n&&this._clearWarning(e,"max",{values:l,samples:a})),"number"==typeof t.min&&(d=t.min,(i=l.reduce((e,t)=>e+=+(t<d),0))>=o?this._raiseWarning(e,"min",{values:l,samples:a}):i<=n&&this._clearWarning(e,"min",{values:l,samples:a})),"number"==typeof t.maxDuration&&s.length>1){let i=(a=s.slice(-2))[0][e],n=a[1][e],o=this._currentStreaks.get(e)||0,r=i===n?o+1:0;this._currentStreaks.set(e,r),r>=t.maxDuration?this._raiseWarning(e,"maxDuration",{value:r}):0===r&&this._clearWarning(e,"maxDuration",{value:o})}if("number"==typeof t.minStandardDeviation){let i=this._supplementalSampleBuffers[e];if(!i||i.length<t.sampleCount)return;i.length>t.sampleCount&&i.splice(0,i.length-t.sampleCount);let s=function(e){if(e.length<=0)return null;let t=e.reduce((e,t)=>e+t,0)/e.length,i=e.map(e=>Math.pow(e-t,2));return Math.sqrt(i.reduce((e,t)=>e+t,0)/i.length)}(i.slice(-r).reduce((e,t)=>[...e,...t],[]));if("number"!=typeof s)return;s<t.minStandardDeviation?this._raiseWarning(e,"minStandardDeviation",{value:s}):this._clearWarning(e,"minStandardDeviation",{value:s})}[["maxAverage",(e,t)=>e>t],["minAverage",(e,t)=>e<t]].forEach(([i,s])=>{if("number"==typeof t[i]&&l.length>=r){let n=j(l);s(n,t[i])?this._raiseWarning(e,i,{values:l,samples:a}):s(n,t.clearValue||t[i])||this._clearWarning(e,i,{values:l,samples:a})}})}})}}let eZ={factor:1.1,jitter:.5,max:3e4,min:1},e0={disconnect:!0,info:{code:31003,message:"Connection with Twilio was interrupted.",twilioError:new h.ConnectionError}},e1={packetsLostFraction:{max:"packet-loss",maxAverage:"packets-lost-fraction"}},e3={audioInputLevel:"audio-input-level",audioOutputLevel:"audio-output-level",bytesReceived:"bytes-received",bytesSent:"bytes-sent",jitter:"jitter",mos:"mos",rtt:"rtt"},e2={max:"high-",maxAverage:"high-",maxDuration:"constant-",min:"low-",minStandardDeviation:"constant-"};class e5 extends _.EventEmitter{get direction(){return this._direction}get codec(){return this._codec}get connectToken(){let e=this._signalingReconnectToken,t=this.parameters&&this.parameters.CallSid?this.parameters.CallSid:void 0;if(e&&t)return btoa(encodeURIComponent(JSON.stringify({customParameters:this.customParameters&&"function"==typeof this.customParameters.keys?Array.from(this.customParameters.keys()).reduce((e,t)=>(e[t]=this.customParameters.get(t),e),{}):{},parameters:this.parameters||{},signalingReconnectToken:e})))}constructor(e,t){super(),this.parameters={},this._inputVolumeStreak=0,this._isAnswered=!1,this._isCancelled=!1,this._isRejected=!1,this._latestInputVolume=0,this._latestOutputVolume=0,this._log=new D("Call"),this._mediaStatus=e5.State.Pending,this._messages=new Map,this._metricsSamples=[],this._options={MediaHandler:eL,MediaStream:null,enableImprovedSignalingErrorPrecision:!1,offerSdp:null,shouldPlayDisconnect:()=>!0,voiceEventSidGenerator:eF},this._outputVolumeStreak=0,this._shouldSendHangup=!0,this._signalingStatus=e5.State.Pending,this._soundcache=new Map,this._status=e5.State.Pending,this._wasConnected=!1,this.toString=()=>"[Twilio.Call instance]",this._emitWarning=(e,t,i,s,n,o)=>{let r=`${e}warning${n?"-cleared":"-raised"}`;if("constant-audio-input-level"===t&&this.isMuted())return;let a=n?"info":"warning";"constant-audio-output-level"===t&&(a="info");let l={threshold:i};if(s&&(s instanceof Array?l.values=s.map(e=>"number"==typeof e?Math.round(100*e)/100:s):l.value=s),this._publisher.post(a,r,t,{data:l},this),"constant-audio-output-level"!==t){let e=n?"warning-cleared":"warning";this._log.debug(`#${e}`,t),this.emit(e,t,o&&!n?o:null)}},this._onAck=e=>{let{acktype:t,callsid:i,voiceeventsid:s}=e;if(this.parameters.CallSid!==i)return void this._log.warn(`Received ack from a different callsid: ${i}`);"message"===t&&this._onMessageSent(s)},this._onAnswer=e=>{"string"==typeof e.reconnect&&(this._signalingReconnectToken=e.reconnect),this._isAnswered&&this._status!==e5.State.Reconnecting||(this._setCallSid(e),this._isAnswered=!0,this._maybeTransitionToOpen())},this._onCancel=e=>{let t=e.callsid;this.parameters.CallSid===t&&(this._isCancelled=!0,this._publisher.info("connection","cancel",null,this),this._cleanupEventListeners(),this._mediaHandler.close(),this._status=e5.State.Closed,this._log.debug("#cancel"),this.emit("cancel"),this._pstream.removeListener("cancel",this._onCancel))},this._onConnected=()=>{this._log.info("Received connected from pstream"),this._signalingReconnectToken&&this._mediaHandler.version&&this._pstream.reconnect(this._mediaHandler.version.getSDP(),this.parameters.CallSid,this._signalingReconnectToken)},this._onHangup=e=>{if(this.status()!==e5.State.Closed){if(e.callsid&&(this.parameters.CallSid||this.outboundConnectionId)){if(e.callsid!==this.parameters.CallSid&&e.callsid!==this.outboundConnectionId)return}else if(e.callsid)return;if(this._log.info("Received HANGUP from gateway"),e.error){let t=e.error.code,i=C(this._options.enableImprovedSignalingErrorPrecision,t),s=void 0!==i?new i(e.error.message):new a.ConnectionError("Error sent from gateway in HANGUP",e.error);this._log.error("Received an error from the gateway:",s),this._log.debug("#error",s),this.emit("error",s)}this._shouldSendHangup=!1,this._publisher.info("connection","disconnected-by-remote",null,this),this._disconnect(null,!0),this._cleanupEventListeners()}},this._onMediaFailure=e=>{let{ConnectionDisconnected:t,ConnectionFailed:i,IceGatheringFailed:s,LowBytes:n}=e5.MediaFailure,o=e===i||e===s;if(!F(window,window.navigator)&&e===i)return this._mediaHandler.onerror(e0);if(this._mediaStatus===e5.State.Reconnecting){if(o){if(Date.now()-this._mediaReconnectStartTime>eZ.max)return this._log.warn("Exceeded max ICE retries"),this._mediaHandler.onerror(e0);try{this._mediaReconnectBackoff.backoff()}catch(e){if(!(e.message&&"Backoff in progress."===e.message))throw e}}return}let r=this._mediaHandler.version.pc,a=r&&"disconnected"===r.iceConnectionState,l=this._monitor.hasActiveWarning("bytesSent","min")||this._monitor.hasActiveWarning("bytesReceived","min");if(e===n&&a||e===t&&l||o){let e=new h.ConnectionError("Media connection failed.");this._log.warn("ICE Connection disconnected."),this._publisher.warn("connection","error",e,this),this._publisher.info("connection","reconnecting",null,this),this._mediaReconnectStartTime=Date.now(),this._status=e5.State.Reconnecting,this._mediaStatus=e5.State.Reconnecting,this._mediaReconnectBackoff.reset(),this._mediaReconnectBackoff.backoff(),this._log.debug("#reconnecting"),this.emit("reconnecting",e)}},this._onMediaReconnected=()=>{this._mediaStatus===e5.State.Reconnecting&&(this._log.info("ICE Connection reestablished."),this._mediaStatus=e5.State.Open,this._signalingStatus===e5.State.Open&&(this._publisher.info("connection","reconnected",null,this),this._log.debug("#reconnected"),this.emit("reconnected"),this._status=e5.State.Open))},this._onMessageReceived=e=>{let{callsid:t,content:i,contenttype:s,messagetype:n,voiceeventsid:o}=e;if(this.parameters.CallSid!==t)return void this._log.warn(`Received a message from a different callsid: ${t}`);let r={content:i,contentType:s,messageType:n,voiceEventSid:o};this._publisher.info("call-message",n,{content_type:s,event_type:"received",voice_event_sid:o},this),this._log.debug("#messageReceived",JSON.stringify(r)),this.emit("messageReceived",r)},this._onMessageSent=e=>{if(!this._messages.has(e))return void this._log.warn(`Received a messageSent with a voiceEventSid that doesn't exists: ${e}`);let t=this._messages.get(e);this._messages.delete(e),this._publisher.info("call-message",null==t?void 0:t.messageType,{content_type:null==t?void 0:t.contentType,event_type:"sent",voice_event_sid:e},this),this._log.debug("#messageSent",JSON.stringify(t)),this.emit("messageSent",t)},this._onRinging=e=>{if(this._setCallSid(e),this._status!==e5.State.Connecting&&this._status!==e5.State.Ringing)return;let t=!!e.sdp;this._status=e5.State.Ringing,this._publisher.info("connection","outgoing-ringing",{hasEarlyMedia:t},this),this._log.debug("#ringing"),this.emit("ringing",t)},this._onRTCSample=e=>{let t=Object.assign(Object.assign({},e),{inputVolume:this._latestInputVolume,outputVolume:this._latestOutputVolume});this._codec=t.codecName,this._metricsSamples.push(t),this._metricsSamples.length>=10&&this._publishMetrics(),this.emit("sample",e)},this._onSignalingError=e=>{let{callsid:t,voiceeventsid:i,error:s}=e;if(this.parameters.CallSid!==t)return void this._log.warn(`Received an error from a different callsid: ${t}`);if(i&&this._messages.has(i)){let t;this._messages.delete(i),this._log.warn("Received an error while sending a message.",e),this._publisher.error("call-message","error",{code:s.code,message:s.message,voice_event_sid:i},this);let n=C(!!this._options.enableImprovedSignalingErrorPrecision,s.code);void 0!==n&&(t=new n(s)),t||(this._log.error("Unknown Call Message Error: ",s),t=new a.UnknownError(s.message,s)),this._log.debug("#error",s,t),this.emit("error",t)}},this._onSignalingReconnected=()=>{this._signalingStatus===e5.State.Reconnecting&&(this._log.info("Signaling Connection reestablished."),this._signalingStatus=e5.State.Open,this._mediaStatus===e5.State.Open&&(this._publisher.info("connection","reconnected",null,this),this._log.debug("#reconnected"),this.emit("reconnected"),this._status=e5.State.Open))},this._onTransportClose=()=>{this._log.error("Received transportClose from pstream"),this._log.debug("#transportClose"),this.emit("transportClose"),this._signalingReconnectToken?(this._status=e5.State.Reconnecting,this._signalingStatus=e5.State.Reconnecting,this._publisher.info("connection","reconnecting",null,this),this._log.debug("#reconnecting"),this.emit("reconnecting",new d.ConnectionDisconnected)):(this._status=e5.State.Closed,this._signalingStatus=e5.State.Closed)},this._reemitWarning=(e,t)=>{let i,s=/^audio/.test(e.name)?"audio-level-":"network-quality-",n=e2[e.threshold.name];e.name in e1?i=e1[e.name][e.threshold.name]:e.name in e3&&(i=e3[e.name]);let o=n+i;this._emitWarning(s,o,e.threshold.value,e.values||e.value,t,e)},this._reemitWarningCleared=e=>{this._reemitWarning(e,!0)},this._soundcache=e.soundcache,"function"==typeof e.onIgnore&&(this._onIgnore=e.onIgnore);let i=t&&t.twimlParams||{};this.customParameters=new Map(Object.entries(i).map(([e,t])=>[e,String(t)])),Object.assign(this._options,t),this._options.callParameters&&(this.parameters=this._options.callParameters),this._options.reconnectToken&&(this._signalingReconnectToken=this._options.reconnectToken),this._voiceEventSidGenerator=this._options.voiceEventSidGenerator||eF,this._direction=this.parameters.CallSid&&!this._options.reconnectCallSid?e5.CallDirection.Incoming:e5.CallDirection.Outgoing,this.parameters?this.callerInfo=this.parameters.StirStatus?{isVerified:"TN-Validation-Passed-A"===this.parameters.StirStatus}:null:this.callerInfo=null,this._mediaReconnectBackoff=new f(eZ),this._mediaReconnectBackoff.on("ready",()=>this._mediaHandler.iceRestart()),this.outboundConnectionId="TJSxxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)});let s=this._publisher=e.publisher;this._direction===e5.CallDirection.Incoming?s.info("connection","incoming",null,this):s.info("connection","outgoing",{preflight:this._options.preflight,reconnect:!!this._options.reconnectCallSid},this);let n=this._monitor=new(this._options.StatsMonitor||eY);n.on("sample",this._onRTCSample),n.disableWarnings(),setTimeout(()=>n.enableWarnings(),5e3),n.on("warning",(e,t)=>{("bytesSent"===e.name||"bytesReceived"===e.name)&&this._onMediaFailure(e5.MediaFailure.LowBytes),this._reemitWarning(e,t)}),n.on("warning-cleared",e=>{this._reemitWarningCleared(e)}),this._mediaHandler=new this._options.MediaHandler(e.audioHelper,e.pstream,{MediaStream:this._options.MediaStream,RTCPeerConnection:this._options.RTCPeerConnection,codecPreferences:this._options.codecPreferences,dscp:this._options.dscp,forceAggressiveIceNomination:this._options.forceAggressiveIceNomination,maxAverageBitrate:this._options.maxAverageBitrate}),this.on("volume",(e,t)=>{this._inputVolumeStreak=this._checkVolume(e,this._inputVolumeStreak,this._latestInputVolume,"input"),this._outputVolumeStreak=this._checkVolume(t,this._outputVolumeStreak,this._latestOutputVolume,"output"),this._latestInputVolume=e,this._latestOutputVolume=t}),this._mediaHandler.onaudio=e=>{this._log.debug("#audio"),this.emit("audio",e)},this._mediaHandler.onvolume=(e,t,i,s)=>{n.addVolumes(i/255*32767,s/255*32767),this.emit("volume",e,t)},this._mediaHandler.ondtlstransportstatechange=e=>{this._publisher.post("failed"===e?"error":"debug","dtls-transport-state",e,null,this)},this._mediaHandler.onpcconnectionstatechange=e=>{let t="debug",i=this._mediaHandler.getRTCDtlsTransport();"failed"===e&&(t=i&&"failed"===i.state?"error":"warning"),this._publisher.post(t,"pc-connection-state",e,null,this)},this._mediaHandler.onicecandidate=e=>{let t=new eJ(e).toPayload();this._publisher.debug("ice-candidate","ice-candidate",t,this)},this._mediaHandler.onselectedcandidatepairchange=e=>{let t=new eJ(e.local).toPayload(),i=new eJ(e.remote,!0).toPayload();this._publisher.debug("ice-candidate","selected-ice-candidate-pair",{local_candidate:t,remote_candidate:i},this)},this._mediaHandler.oniceconnectionstatechange=e=>{this._publisher.post("failed"===e?"error":"debug","ice-connection-state",e,null,this)},this._mediaHandler.onicegatheringfailure=e=>{this._publisher.warn("ice-gathering-state",e,null,this),this._onMediaFailure(e5.MediaFailure.IceGatheringFailed)},this._mediaHandler.onicegatheringstatechange=e=>{this._publisher.debug("ice-gathering-state",e,null,this)},this._mediaHandler.onsignalingstatechange=e=>{this._publisher.debug("signaling-state",e,null,this)},this._mediaHandler.ondisconnected=e=>{this._log.warn(e),this._publisher.warn("network-quality-warning-raised","ice-connectivity-lost",{message:e},this),this._log.debug("#warning","ice-connectivity-lost"),this.emit("warning","ice-connectivity-lost"),this._onMediaFailure(e5.MediaFailure.ConnectionDisconnected)},this._mediaHandler.onfailed=e=>{this._onMediaFailure(e5.MediaFailure.ConnectionFailed)},this._mediaHandler.onconnected=()=>{this._status===e5.State.Reconnecting&&this._onMediaReconnected()},this._mediaHandler.onreconnected=e=>{this._log.info(e),this._publisher.info("network-quality-warning-cleared","ice-connectivity-lost",{message:e},this),this._log.debug("#warning-cleared","ice-connectivity-lost"),this.emit("warning-cleared","ice-connectivity-lost"),this._onMediaReconnected()},this._mediaHandler.onerror=e=>{!0===e.disconnect&&this._disconnect(e.info&&e.info.message);let t=e.info.twilioError||new a.UnknownError(e.info.message);this._log.error("Received an error from MediaStream:",e),this._log.debug("#error",t),this.emit("error",t)},this._mediaHandler.onopen=()=>{this._status!==e5.State.Open&&this._status!==e5.State.Reconnecting&&(this._status===e5.State.Ringing||this._status===e5.State.Connecting?(this.mute(this._mediaHandler.isMuted),this._mediaStatus=e5.State.Open,this._maybeTransitionToOpen()):this._mediaHandler.close())},this._mediaHandler.onclose=()=>{this._status=e5.State.Closed,this._options.shouldPlayDisconnect&&this._options.shouldPlayDisconnect()&&!this._isCancelled&&!this._isRejected&&this._soundcache.get(eG.SoundName.Disconnect).play(),n.disable(),this._publishMetrics(),this._isCancelled||this._isRejected||(this._log.debug("#disconnect"),this.emit("disconnect",this))},this._pstream=e.pstream,this._pstream.on("ack",this._onAck),this._pstream.on("cancel",this._onCancel),this._pstream.on("error",this._onSignalingError),this._pstream.on("ringing",this._onRinging),this._pstream.on("transportClose",this._onTransportClose),this._pstream.on("connected",this._onConnected),this._pstream.on("message",this._onMessageReceived),this.on("error",e=>{this._publisher.error("connection","error",{code:e.code,message:e.message},this),this._pstream&&"disconnected"===this._pstream.status&&this._cleanupEventListeners()}),this.on("disconnect",()=>{this._cleanupEventListeners()})}_setInputTracksFromStream(e){return this._mediaHandler.setInputTracksFromStream(e)}_setSinkIds(e){return this._mediaHandler._setSinkIds(e)}accept(e){if(this._log.debug(".accept",e),this._status!==e5.State.Pending)return void this._log.debug(`.accept noop. status is '${this._status}'`);let t=(e=e||{}).rtcConfiguration||this._options.rtcConfiguration,i=e.rtcConstraints||this._options.rtcConstraints||{},s={audio:void 0===i.audio||i.audio};this._status=e5.State.Connecting;let n=()=>{if(this._status!==e5.State.Connecting){this._cleanupEventListeners(),this._mediaHandler.close();return}let e=e=>{let t=this._direction===e5.CallDirection.Incoming?"accepted-by-local":"accepted-by-remote";this._publisher.info("connection",t,null,this);let{codecName:i,codecParams:s}=function(e){let[,t,i]=/a=rtpmap:(\d+) (\S+)/m.exec(e)||[null,"",""],[,s]=RegExp(`a=fmtp:${t} (\\S+)`,"m").exec(e)||[null,""];return{codecName:i,codecParams:s}}(this._mediaHandler.version.getSDP());this._publisher.info("settings","codec",{codec_params:s,selected_codec:i},this),this._monitor.enable(e)},i="function"==typeof this._options.getSinkIds&&this._options.getSinkIds();if(Array.isArray(i)&&this._mediaHandler._setSinkIds(i).catch(()=>{}),this._pstream.addListener("hangup",this._onHangup),this._direction===e5.CallDirection.Incoming)this._isAnswered=!0,this._pstream.on("answer",this._onAnswer),this._mediaHandler.answerIncomingCall(this.parameters.CallSid,this._options.offerSdp,t,e);else{let i=Array.from(this.customParameters.entries()).map(e=>`${encodeURIComponent(e[0])}=${encodeURIComponent(e[1])}`).join("&");this._pstream.on("answer",this._onAnswer),this._mediaHandler.makeOutgoingCall(i,this._signalingReconnectToken,this._options.reconnectCallSid||this.outboundConnectionId,t,e)}};this._options.beforeAccept&&this._options.beforeAccept(this);let o="function"==typeof this._options.getInputStream&&this._options.getInputStream();(o?this._mediaHandler.setInputTracksFromStream(o):this._mediaHandler.openDefaultDeviceWithConstraints(s)).then(()=>{this._publisher.info("get-user-media","succeeded",{data:{audioConstraints:s}},this),n()},e=>{let t;31208===e.code||-1!==["PermissionDeniedError","NotAllowedError"].indexOf(e.name)?(t=new c.PermissionDeniedError,this._publisher.error("get-user-media","denied",{data:{audioConstraints:s,error:e}},this)):(t=new c.AcquisitionFailedError,this._publisher.error("get-user-media","failed",{data:{audioConstraints:s,error:e}},this)),this._disconnect(),this._log.debug("#error",e),this.emit("error",t)})}disconnect(){this._log.debug(".disconnect"),this._disconnect()}getLocalStream(){return this._mediaHandler&&this._mediaHandler.stream}getRemoteStream(){return this._mediaHandler&&this._mediaHandler._remoteStream}ignore(){if(this._log.debug(".ignore"),this._status!==e5.State.Pending)return void this._log.debug(`.ignore noop. status is '${this._status}'`);this._status=e5.State.Closed,this._mediaHandler.ignore(this.parameters.CallSid),this._publisher.info("connection","ignored-by-local",null,this),this._onIgnore&&this._onIgnore()}isMuted(){return this._mediaHandler.isMuted}mute(e=!0){this._log.debug(".mute",e);let t=this._mediaHandler.isMuted;this._mediaHandler.mute(e);let i=this._mediaHandler.isMuted;t!==i&&(this._publisher.info("connection",i?"muted":"unmuted",null,this),this._log.debug("#mute",i),this.emit("mute",i,this))}postFeedback(e,t){if(null==e)return this._postFeedbackDeclined();if(!Object.values(e5.FeedbackScore).includes(e))throw new x(`Feedback score must be one of: ${Object.values(e5.FeedbackScore)}`);if(null!=t&&!Object.values(e5.FeedbackIssue).includes(t))throw new x(`Feedback issue must be one of: ${Object.values(e5.FeedbackIssue)}`);return this._publisher.info("feedback","received",{issue_name:t,quality_score:e},this,!0)}reject(){if(this._log.debug(".reject"),this._status!==e5.State.Pending)return void this._log.debug(`.reject noop. status is '${this._status}'`);this._isRejected=!0,this._pstream.reject(this.parameters.CallSid),this._mediaHandler.reject(this.parameters.CallSid),this._publisher.info("connection","rejected-by-local",null,this),this._cleanupEventListeners(),this._mediaHandler.close(),this._status=e5.State.Closed,this._log.debug("#reject"),this.emit("reject")}sendDigits(e){if(this._log.debug(".sendDigits",e),e.match(/[^0-9*#w]/))throw new x("Illegal character passed into sendDigits");let t=this._options.customSounds||{},i=[];e.split("").forEach(e=>{let t="w"!==e?`dtmf${e}`:"";"dtmf*"===t&&(t="dtmfs"),"dtmf#"===t&&(t="dtmfh"),i.push(t)});let s=()=>{let e=i.shift();e&&(this._options.dialtonePlayer&&!t[e]?this._options.dialtonePlayer.play(e):this._soundcache.get(e).play()),i.length&&setTimeout(()=>s(),200)};s();let n=this._mediaHandler.getOrCreateDTMFSender();if(n){if(!("canInsertDTMF"in n)||n.canInsertDTMF){this._log.info("Sending digits using RTCDTMFSender"),function e(t){if(!t.length)return;let i=t.shift();i&&i.length&&n.insertDTMF(i,160,70),setTimeout(e.bind(null,t),500)}(e.split("w"));return}this._log.info("RTCDTMFSender cannot insert DTMF")}if(this._log.info("Sending digits over PStream"),null!==this._pstream&&"disconnected"!==this._pstream.status)this._pstream.dtmf(this.parameters.CallSid,e);else{let e=new a.ConnectionError("Could not send DTMF: Signaling channel is disconnected");this._log.debug("#error",e),this.emit("error",e)}}sendMessage(e){this._log.debug(".sendMessage",JSON.stringify(e));let{content:t,contentType:i,messageType:s}=e;if(null==t)throw new x("`content` is empty");if("string"!=typeof s)throw new x("`messageType` must be a string.");if(0===s.length)throw new x("`messageType` must be a non-empty string.");if(null===this._pstream)throw new T("Could not send CallMessage; Signaling channel is disconnected");let n=this.parameters.CallSid;if(void 0===this.parameters.CallSid)throw new T("Could not send CallMessage; Call has no CallSid");let o=this._voiceEventSidGenerator();return this._messages.set(o,{content:t,contentType:i,messageType:s,voiceEventSid:o}),this._pstream.sendMessage(n,t,i,s,o),o}status(){return this._status}_checkVolume(e,t,i,s){let n=t>=10,o=0;return i===e&&(o=t),o>=10?this._emitWarning("audio-level-",`constant-audio-${s}-level`,10,o,!1):n&&this._emitWarning("audio-level-",`constant-audio-${s}-level`,10,o,!0),o}_cleanupEventListeners(){let e=()=>{this._pstream&&(this._pstream.removeListener("ack",this._onAck),this._pstream.removeListener("answer",this._onAnswer),this._pstream.removeListener("cancel",this._onCancel),this._pstream.removeListener("error",this._onSignalingError),this._pstream.removeListener("hangup",this._onHangup),this._pstream.removeListener("ringing",this._onRinging),this._pstream.removeListener("transportClose",this._onTransportClose),this._pstream.removeListener("connected",this._onConnected),this._pstream.removeListener("message",this._onMessageReceived))};e(),setTimeout(e,0)}_createMetricPayload(){let e={call_sid:this.parameters.CallSid,dscp:!!this._options.dscp,sdk_version:I};return this._options.gateway&&(e.gateway=this._options.gateway),e.direction=this._direction,e}_disconnect(e,t){if(e="string"==typeof e?e:null,this._status===e5.State.Open||this._status===e5.State.Connecting||this._status===e5.State.Reconnecting||this._status===e5.State.Ringing){if(this._log.info("Disconnecting..."),null!==this._pstream&&"disconnected"!==this._pstream.status&&this._shouldSendHangup){let t=this.parameters.CallSid||this.outboundConnectionId;t&&this._pstream.hangup(t,e)}this._cleanupEventListeners(),this._mediaHandler.close(),t||this._publisher.info("connection","disconnected-by-local",null,this)}}_maybeTransitionToOpen(){this._wasConnected,this._isAnswered&&(this._onSignalingReconnected(),this._signalingStatus=e5.State.Open,this._mediaHandler&&"open"===this._mediaHandler.status&&(this._status=e5.State.Open,this._wasConnected||(this._wasConnected=!0,this._log.debug("#accept"),this.emit("accept",this))))}_postFeedbackDeclined(){return this._publisher.info("feedback","received-none",null,this,!0)}_publishMetrics(){0!==this._metricsSamples.length&&this._publisher.postMetrics("quality-metrics-samples","metrics-sample",this._metricsSamples.splice(0),this._createMetricPayload(),this).catch(e=>{this._log.warn("Unable to post metrics to Insights. Received error:",e)})}_setCallSid(e){let t=e.callsid;t&&(this.parameters.CallSid=t,this._mediaHandler.callSid=t)}}e5.toString=()=>"[Twilio.Call class]",function(e){var t,i,s,n,o,r,a;(t=e.State||(e.State={})).Closed="closed",t.Connecting="connecting",t.Open="open",t.Pending="pending",t.Reconnecting="reconnecting",t.Ringing="ringing",(i=e.FeedbackIssue||(e.FeedbackIssue={})).AudioLatency="audio-latency",i.ChoppyAudio="choppy-audio",i.DroppedCall="dropped-call",i.Echo="echo",i.NoisyCall="noisy-call",i.OneWayAudio="one-way-audio",(s=e.FeedbackScore||(e.FeedbackScore={}))[s.One=1]="One",s[s.Two=2]="Two",s[s.Three=3]="Three",s[s.Four=4]="Four",s[s.Five=5]="Five",(n=e.CallDirection||(e.CallDirection={})).Incoming="INCOMING",n.Outgoing="OUTGOING",(o=e.Codec||(e.Codec={})).Opus="opus",o.PCMU="pcmu",(r=e.IceGatheringFailureReason||(e.IceGatheringFailureReason={})).None="none",r.Timeout="timeout",(a=e.MediaFailure||(e.MediaFailure={})).ConnectionDisconnected="ConnectionDisconnected",a.ConnectionFailed="ConnectionFailed",a.IceGatheringFailed="IceGatheringFailed",a.LowBytes="LowBytes"}(e5||(e5={}))},39337:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var s=i(76856),n=i(95155);let o=(0,s.A)((0,n.jsx)("path",{d:"M12 9c-1.6 0-3.15.25-4.6.72v3.1c0 .39-.23.74-.56.9-.98.49-1.87 1.12-2.66 1.85-.18.18-.43.28-.7.28-.28 0-.53-.11-.71-.29L.29 13.08c-.18-.17-.29-.42-.29-.7s.11-.53.29-.71C3.34 8.78 7.46 7 12 7s8.66 1.78 11.71 4.67c.18.18.29.43.29.71s-.11.53-.29.71l-2.48 2.48c-.18.18-.43.29-.71.29-.27 0-.52-.11-.7-.28-.79-.74-1.69-1.36-2.67-1.85-.33-.16-.56-.5-.56-.9v-3.1C15.15 9.25 13.6 9 12 9"}),"CallEnd")},40662:e=>{"use strict";var t,i="object"==typeof Reflect?Reflect:null,s=i&&"function"==typeof i.apply?i.apply:function(e,t,i){return Function.prototype.apply.call(e,t,i)};t=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var n=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,e.exports.once=function(e,t){return new Promise(function(i,s){var n,o,r;function a(i){e.removeListener(t,l),s(i)}function l(){"function"==typeof e.removeListener&&e.removeListener("error",a),i([].slice.call(arguments))}g(e,t,l,{once:!0}),"error"!==t&&(n=e,o=a,r={once:!0},"function"==typeof n.on&&g(n,"error",o,r))})},o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var r=10;function a(e){if("function"!=typeof e)throw TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function c(e,t,i,s){if(a(i),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),o=e._events),r=o[t]),void 0===r)r=o[t]=i,++e._eventsCount;else if("function"==typeof r?r=o[t]=s?[i,r]:[r,i]:s?r.unshift(i):r.push(i),(n=l(e))>0&&r.length>n&&!r.warned){r.warned=!0;var n,o,r,c=Error("Possible EventEmitter memory leak detected. "+r.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=r.length,console&&console.warn&&console.warn(c)}return e}function d(){if(!this.fired)return(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0==arguments.length)?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,i){var s={fired:!1,wrapFn:void 0,target:e,type:t,listener:i},n=d.bind(s);return n.listener=i,s.wrapFn=n,n}function u(e,t,i){var s=e._events;if(void 0===s)return[];var n=s[t];return void 0===n?[]:"function"==typeof n?i?[n.listener||n]:[n]:i?function(e){for(var t=Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}(n):m(n,n.length)}function p(e){var t=this._events;if(void 0!==t){var i=t[e];if("function"==typeof i)return 1;if(void 0!==i)return i.length}return 0}function m(e,t){for(var i=Array(t),s=0;s<t;++s)i[s]=e[s];return i}function g(e,t,i,s){if("function"==typeof e.on)s.once?e.once(t,i):e.on(t,i);else if("function"==typeof e.addEventListener)e.addEventListener(t,function n(o){s.once&&e.removeEventListener(t,n),i(o)});else throw TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return r},set:function(e){if("number"!=typeof e||e<0||n(e))throw RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");r=e}}),o.init=function(){(void 0===this._events||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||n(e))throw RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return l(this)},o.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n="error"===e,o=this._events;if(void 0!==o)n=n&&void 0===o.error;else if(!n)return!1;if(n){if(t.length>0&&(r=t[0]),r instanceof Error)throw r;var r,a=Error("Unhandled error."+(r?" ("+r.message+")":""));throw a.context=r,a}var l=o[e];if(void 0===l)return!1;if("function"==typeof l)s(l,this,t);else for(var c=l.length,d=m(l,c),i=0;i<c;++i)s(d[i],this,t);return!0},o.prototype.addListener=function(e,t){return c(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return c(this,e,t,!0)},o.prototype.once=function(e,t){return a(t),this.on(e,h(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,h(this,e,t)),this},o.prototype.removeListener=function(e,t){var i,s,n,o,r;if(a(t),void 0===(s=this._events)||void 0===(i=s[e]))return this;if(i===t||i.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete s[e],s.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(n=-1,o=i.length-1;o>=0;o--)if(i[o]===t||i[o].listener===t){r=i[o].listener,n=o;break}if(n<0)return this;0===n?i.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(i,n),1===i.length&&(s[e]=i[0]),void 0!==s.removeListener&&this.emit("removeListener",e,r||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,i,s;if(void 0===(i=this._events))return this;if(void 0===i.removeListener)return 0==arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==i[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete i[e]),this;if(0==arguments.length){var n,o=Object.keys(i);for(s=0;s<o.length;++s)"removeListener"!==(n=o[s])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(void 0!==t)for(s=t.length-1;s>=0;s--)this.removeListener(e,t[s]);return this},o.prototype.listeners=function(e){return u(this,e,!0)},o.prototype.rawListeners=function(e){return u(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},o.prototype.listenerCount=p,o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]}},44775:(e,t,i)=>{"use strict";i.d(t,{z:()=>_});var s=i(79630),n=i(12115),o=i(39498),r=i(95256),a=i(31086),l=i(31453),c=i(5418),d=i(95695),h=i(8873),u=i(65302),p=i(6358),m=i(26096),g=i(95155);let _=(0,a.R)(function(e,t){let{slotProps:i={}}=e,a=i.button||{},_=i.tooltip||{},f=(0,d.h)(),v=(0,p.A)(),y=(0,h.Nc)(f,l._v),b=(0,o.A)(),S=(0,o.A)(),[w,C]=n.useState(!1),x=n.useRef(null),T=(0,r.A)(t,x),k=[{icon:(0,g.jsx)(v.slots.densityCompactIcon,{}),label:f.current.getLocaleText("toolbarDensityCompact"),value:"compact"},{icon:(0,g.jsx)(v.slots.densityStandardIcon,{}),label:f.current.getLocaleText("toolbarDensityStandard"),value:"standard"},{icon:(0,g.jsx)(v.slots.densityComfortableIcon,{}),label:f.current.getLocaleText("toolbarDensityComfortable"),value:"comfortable"}],E=n.useMemo(()=>{switch(y){case"compact":return(0,g.jsx)(v.slots.densityCompactIcon,{});case"comfortable":return(0,g.jsx)(v.slots.densityComfortableIcon,{});default:return(0,g.jsx)(v.slots.densityStandardIcon,{})}},[y,v]),I=e=>{f.current.setDensity(e),C(!1)};if(v.disableDensitySelector)return null;let A=k.map((e,t)=>(0,g.jsx)(v.slots.baseMenuItem,{onClick:()=>I(e.value),selected:e.value===y,iconStart:e.icon,children:e.label},t));return(0,g.jsxs)(n.Fragment,{children:[(0,g.jsx)(v.slots.baseTooltip,(0,s.A)({title:f.current.getLocaleText("toolbarDensityLabel"),enterDelay:1e3},v.slotProps?.baseTooltip,_,{children:(0,g.jsx)(v.slots.baseButton,(0,s.A)({size:"small",startIcon:E,"aria-label":f.current.getLocaleText("toolbarDensityLabel"),"aria-haspopup":"menu","aria-expanded":w,"aria-controls":w?S:void 0,id:b},v.slotProps?.baseButton,a,{onClick:e=>{C(e=>!e),a.onClick?.(e)},ref:T,children:f.current.getLocaleText("toolbarDensity")}))})),(0,g.jsx)(u.U,{open:w,target:x.current,onClose:()=>{C(!1)},position:"bottom-end",children:(0,g.jsx)(v.slots.baseMenuList,{id:S,className:m.x.menuList,"aria-labelledby":b,onKeyDown:e=>{"Tab"===e.key&&e.preventDefault(),(0,c.HF)(e.key)&&C(!1)},autoFocusItem:w,children:A})})]})})},49247:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var s=i(76856),n=i(95155);let o=(0,s.A)((0,n.jsx)("path",{d:"M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3m5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72z"}),"Mic")},56548:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var s=i(76856),n=i(95155);let o=(0,s.A)((0,n.jsx)("path",{d:"M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28m-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18zM4.27 3 3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l1.66 1.66c-.71.33-1.5.52-2.31.52-2.76 0-5.3-2.1-5.3-5.1H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c.91-.13 1.77-.45 2.54-.9L19.73 21 21 19.73z"}),"MicOff")},57033:(e,t,i)=>{"use strict";i.d(t,{j:()=>m});var s=i(79630);i(12115);var n=i(39498),o=i(31086),r=i(95256),a=i(8873),l=i(48106),c=i(87465),d=i(95695),h=i(6358),u=i(26401),p=i(95155);let m=(0,o.R)(function(e,t){let{slotProps:i={}}=e,o=i.button||{},m=i.tooltip||{},g=(0,n.A)(),_=(0,n.A)(),f=(0,d.h)(),v=(0,h.A)(),{columnsPanelTriggerRef:y}=(0,u.vR)(),b=(0,a.Nc)(f,l._),S=(0,r.A)(t,y);if(v.disableColumnSelector)return null;let w=b.open&&b.panelId===_;return(0,p.jsx)(v.slots.baseTooltip,(0,s.A)({title:f.current.getLocaleText("toolbarColumnsLabel"),enterDelay:1e3},v.slotProps?.baseTooltip,m,{children:(0,p.jsx)(v.slots.baseButton,(0,s.A)({id:g,size:"small","aria-label":f.current.getLocaleText("toolbarColumnsLabel"),"aria-haspopup":"menu","aria-expanded":w,"aria-controls":w?_:void 0,startIcon:(0,p.jsx)(v.slots.columnSelectorIcon,{})},v.slotProps?.baseButton,o,{onPointerUp:e=>{b.open&&e.stopPropagation(),o.onPointerUp?.(e)},onClick:e=>{b.open&&b.openedPanelValue===c.y.columns?f.current.hidePreferences():f.current.showPreferences(c.y.columns,_,g),o.onClick?.(e)},ref:S,children:f.current.getLocaleText("toolbarColumns")}))}))})},61584:function(e,t,i){var s,n;!function(o,r){"use strict";void 0===(n="function"==typeof(s=r)?s.call(t,i,t,e):s)||(e.exports=n)}(0,function(){"use strict";var e=function(){},t="undefined",i=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),s=["trace","debug","info","warn","error"],n={},o=null;function r(e,t){var i=e[t];if("function"==typeof i.bind)return i.bind(e);try{return Function.prototype.bind.call(i,e)}catch(t){return function(){return Function.prototype.apply.apply(i,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(){for(var i=this.getLevel(),n=0;n<s.length;n++){var o=s[n];this[o]=n<i?e:this.methodFactory(o,i,this.name)}if(this.log=this.debug,typeof console===t&&i<this.levels.SILENT)return"No console available for logging"}function c(e){return function(){typeof console!==t&&(l.call(this),this[e].apply(this,arguments))}}function d(s,n,o){var l;return"debug"===(l=s)&&(l="log"),typeof console!==t&&("trace"===l&&i?a:void 0!==console[l]?r(console,l):void 0!==console.log?r(console,"log"):e)||c.apply(this,arguments)}function h(e,i){var r,a,c,h=this,u="loglevel";function p(){var e;if(typeof window!==t&&u){try{e=window.localStorage[u]}catch(e){}if(typeof e===t)try{var i=window.document.cookie,s=encodeURIComponent(u),n=i.indexOf(s+"=");-1!==n&&(e=/^([^;]+)/.exec(i.slice(n+s.length+1))[1])}catch(e){}return void 0===h.levels[e]&&(e=void 0),e}}function m(e){var t=e;if("string"==typeof t&&void 0!==h.levels[t.toUpperCase()]&&(t=h.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=h.levels.SILENT)return t;throw TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?u+=":"+e:"symbol"==typeof e&&(u=void 0),h.name=e,h.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},h.methodFactory=i||d,h.getLevel=function(){return null!=c?c:null!=a?a:r},h.setLevel=function(e,i){return c=m(e),!1!==i&&function(e){var i=(s[e]||"silent").toUpperCase();if(typeof window!==t&&u){try{window.localStorage[u]=i;return}catch(e){}try{window.document.cookie=encodeURIComponent(u)+"="+i+";"}catch(e){}}}(c),l.call(h)},h.setDefaultLevel=function(e){a=m(e),p()||h.setLevel(e,!1)},h.resetLevel=function(){if(c=null,typeof window!==t&&u){try{window.localStorage.removeItem(u)}catch(e){}try{window.document.cookie=encodeURIComponent(u)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}l.call(h)},h.enableAll=function(e){h.setLevel(h.levels.TRACE,e)},h.disableAll=function(e){h.setLevel(h.levels.SILENT,e)},h.rebuild=function(){if(o!==h&&(r=m(o.getLevel())),l.call(h),o===h)for(var e in n)n[e].rebuild()},r=m(o?o.getLevel():"WARN");var g=p();null!=g&&(c=m(g)),l.call(h)}(o=new h).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw TypeError("You must supply a name when creating a logger.");var t=n[e];return t||(t=n[e]=new h(e,o.methodFactory)),t};var u=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=u),o},o.getLoggers=function(){return n},o.default=o,o})},64637:(e,t,i)=>{"use strict";i.d(t,{A:()=>b});var s=i(12115),n=i(15386),o=i(45450),r=i(9670),a=i(35881),l=i(82700),c=i(57692),d=i(81112);function h(e){return(0,d.Ay)("MuiCardHeader",e)}let u=(0,c.A)("MuiCardHeader",["root","avatar","action","content","title","subheader"]);var p=i(62976),m=i(95155);let g=e=>{let{classes:t}=e;return(0,n.A)({root:["root"],avatar:["avatar"],action:["action"],content:["content"],title:["title"],subheader:["subheader"]},h,t)},_=(0,a.default)("div",{name:"MuiCardHeader",slot:"Root",overridesResolver:(e,t)=>[{["& .".concat(u.title)]:t.title},{["& .".concat(u.subheader)]:t.subheader},t.root]})({display:"flex",alignItems:"center",padding:16}),f=(0,a.default)("div",{name:"MuiCardHeader",slot:"Avatar",overridesResolver:(e,t)=>t.avatar})({display:"flex",flex:"0 0 auto",marginRight:16}),v=(0,a.default)("div",{name:"MuiCardHeader",slot:"Action",overridesResolver:(e,t)=>t.action})({flex:"0 0 auto",alignSelf:"flex-start",marginTop:-4,marginRight:-8,marginBottom:-4}),y=(0,a.default)("div",{name:"MuiCardHeader",slot:"Content",overridesResolver:(e,t)=>t.content})({flex:"1 1 auto",[".".concat(o.A.root,":where(& .").concat(u.title,")")]:{display:"block"},[".".concat(o.A.root,":where(& .").concat(u.subheader,")")]:{display:"block"}}),b=s.forwardRef(function(e,t){let i=(0,l.b)({props:e,name:"MuiCardHeader"}),{action:s,avatar:n,component:o="div",disableTypography:a=!1,subheader:c,subheaderTypographyProps:d,title:h,titleTypographyProps:u,slots:b={},slotProps:S={},...w}=i,C={...i,component:o,disableTypography:a},x=g(C),T={slots:b,slotProps:{title:u,subheader:d,...S}},k=h,[E,I]=(0,p.A)("title",{className:x.title,elementType:r.default,externalForwardedProps:T,ownerState:C,additionalProps:{variant:n?"body2":"h5",component:"span"}});null==k||k.type===r.default||a||(k=(0,m.jsx)(E,{...I,children:k}));let A=c,[P,D]=(0,p.A)("subheader",{className:x.subheader,elementType:r.default,externalForwardedProps:T,ownerState:C,additionalProps:{variant:n?"body2":"body1",color:"textSecondary",component:"span"}});null==A||A.type===r.default||a||(A=(0,m.jsx)(P,{...D,children:A}));let[R,O]=(0,p.A)("root",{ref:t,className:x.root,elementType:_,externalForwardedProps:{...T,...w,component:o},ownerState:C}),[M,L]=(0,p.A)("avatar",{className:x.avatar,elementType:f,externalForwardedProps:T,ownerState:C}),[j,$]=(0,p.A)("content",{className:x.content,elementType:y,externalForwardedProps:T,ownerState:C}),[N,F]=(0,p.A)("action",{className:x.action,elementType:v,externalForwardedProps:T,ownerState:C});return(0,m.jsxs)(R,{...O,children:[n&&(0,m.jsx)(M,{...L,children:n}),(0,m.jsxs)(j,{...$,children:[k,A]}),s&&(0,m.jsx)(N,{...F,children:s})]})})},65068:(e,t,i)=>{"use strict";i.d(t,{Q:()=>x});var s=i(79630),n=i(12115),o=i(35881),r=i(51816),a=i(39498),l=i(75490),c=i(95256),d=i(31086),h=i(24452),u=i(82261),p=i(8873),m=i(9559),g=i(48106),_=i(87465),f=i(95695),v=i(6358),y=i(26096),b=i(26401),S=i(95155);let w=e=>{let{classes:t}=e;return(0,r.A)({root:["toolbarFilterList"]},y.B,t)},C=(0,o.default)("ul",{name:"MuiDataGrid",slot:"ToolbarFilterList"})({margin:h.f.spacing(1,1,.5),padding:h.f.spacing(0,1)}),x=(0,d.R)(function(e,t){let{slotProps:i={}}=e,o=i.button||{},r=i.tooltip||{},d=i.badge||{},h=(0,f.h)(),y=(0,v.A)(),x=(0,p.Nc)(h,m.Ai),T=(0,p.Nc)(h,u.gv),k=(0,p.Nc)(h,g._),E=w(y),I=(0,a.A)(),A=(0,a.A)(),{filterPanelTriggerRef:P}=(0,b.vR)(),D=(0,c.A)(t,P),R=n.useMemo(()=>{if(k.open)return h.current.getLocaleText("toolbarFiltersTooltipHide");if(0===x.length)return h.current.getLocaleText("toolbarFiltersTooltipShow");let e=e=>T[e.field].filterOperators.find(t=>t.value===e.operator).label||h.current.getLocaleText(`filterOperator${(0,l.A)(e.operator)}`).toString(),t=e=>{let{getValueAsString:t}=T[e.field].filterOperators.find(t=>t.value===e.operator);return t?t(e.value):e.value};return(0,S.jsxs)("div",{children:[h.current.getLocaleText("toolbarFiltersTooltipActive")(x.length),(0,S.jsx)(C,{className:E.root,ownerState:y,children:x.map((i,n)=>(0,s.A)({},T[i.field]&&(0,S.jsx)("li",{children:`${T[i.field].headerName||i.field}
                  ${e(i)}
                  ${null!=i.value?t(i):""}`},n)))})]})},[h,y,k.open,x,T,E]);if(y.disableColumnFilter)return null;let O=k.open&&k.panelId===A;return(0,S.jsx)(y.slots.baseTooltip,(0,s.A)({title:R,enterDelay:1e3},y.slotProps?.baseTooltip,r,{children:(0,S.jsx)(y.slots.baseButton,(0,s.A)({id:I,size:"small","aria-label":h.current.getLocaleText("toolbarFiltersLabel"),"aria-controls":O?A:void 0,"aria-expanded":O,"aria-haspopup":!0,startIcon:(0,S.jsx)(y.slots.baseBadge,(0,s.A)({badgeContent:x.length,color:"primary"},y.slotProps?.baseBadge,d,{children:(0,S.jsx)(y.slots.openFilterButtonIcon,{})}))},y.slotProps?.baseButton,o,{onClick:e=>{let{open:t,openedPanelValue:i}=k;t&&i===_.y.filters?h.current.hidePreferences():h.current.showPreferences(_.y.filters,A,I),o.onClick?.(e)},onPointerUp:e=>{k.open&&e.stopPropagation(),o.onPointerUp?.(e)},ref:D,children:h.current.getLocaleText("toolbarFilters")}))}))})},68895:(e,t,i)=>{"use strict";i.d(t,{A:()=>R});var s=i(12115),n=i(15386),o=i(25707),r=i(20522),a=i(64894);let l=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{autoHideDuration:t=null,disableWindowBlurListener:i=!1,onClose:n,open:l,resumeHideDuration:c}=e,d=(0,o.A)();s.useEffect(()=>{if(l)return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)};function e(e){e.defaultPrevented||"Escape"!==e.key||null==n||n(e,"escapeKeyDown")}},[l,n]);let h=(0,r.A)((e,t)=>{null==n||n(e,t)}),u=(0,r.A)(e=>{n&&null!=e&&d.start(e,()=>{h(null,"timeout")})});s.useEffect(()=>(l&&u(t),d.clear),[l,t,u,d]);let p=d.clear,m=s.useCallback(()=>{null!=t&&u(null!=c?c:.5*t)},[t,c,u]),g=e=>t=>{let i=e.onBlur;null==i||i(t),m()},_=e=>t=>{let i=e.onFocus;null==i||i(t),p()},f=e=>t=>{let i=e.onMouseEnter;null==i||i(t),p()},v=e=>t=>{let i=e.onMouseLeave;null==i||i(t),m()};return s.useEffect(()=>{if(!i&&l)return window.addEventListener("focus",m),window.addEventListener("blur",p),()=>{window.removeEventListener("focus",m),window.removeEventListener("blur",p)}},[i,l,m,p]),{getRootProps:function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i={...(0,a.A)(e),...(0,a.A)(t)};return{role:"presentation",...t,...i,onBlur:g(i),onFocus:_(i),onMouseEnter:f(i),onMouseLeave:v(i)}},onClickAway:e=>{null==n||n(e,"clickaway")}}};var c=i(78914),d=i(35881),h=i(73746),u=i(74409),p=i(82700),m=i(39571),g=i(57538),_=i(52596),f=i(78894),v=i(84762),y=i(57692),b=i(81112);function S(e){return(0,b.Ay)("MuiSnackbarContent",e)}(0,y.A)("MuiSnackbarContent",["root","message","action"]);var w=i(95155);let C=e=>{let{classes:t}=e;return(0,n.A)({root:["root"],action:["action"],message:["message"]},S,t)},x=(0,d.default)(v.default,{name:"MuiSnackbarContent",slot:"Root",overridesResolver:(e,t)=>t.root})((0,u.A)(e=>{let{theme:t}=e,i="light"===t.palette.mode?.8:.98,s=(0,f.tL)(t.palette.background.default,i);return{...t.typography.body2,color:t.vars?t.vars.palette.SnackbarContent.color:t.palette.getContrastText(s),backgroundColor:t.vars?t.vars.palette.SnackbarContent.bg:s,display:"flex",alignItems:"center",flexWrap:"wrap",padding:"6px 16px",borderRadius:(t.vars||t).shape.borderRadius,flexGrow:1,[t.breakpoints.up("sm")]:{flexGrow:"initial",minWidth:288}}})),T=(0,d.default)("div",{name:"MuiSnackbarContent",slot:"Message",overridesResolver:(e,t)=>t.message})({padding:"8px 0"}),k=(0,d.default)("div",{name:"MuiSnackbarContent",slot:"Action",overridesResolver:(e,t)=>t.action})({display:"flex",alignItems:"center",marginLeft:"auto",paddingLeft:16,marginRight:-8}),E=s.forwardRef(function(e,t){let i=(0,p.b)({props:e,name:"MuiSnackbarContent"}),{action:s,className:n,message:o,role:r="alert",...a}=i,l=C(i);return(0,w.jsxs)(x,{role:r,square:!0,elevation:6,className:(0,_.A)(l.root,n),ownerState:i,ref:t,...a,children:[(0,w.jsx)(T,{className:l.message,ownerState:i,children:o}),s?(0,w.jsx)(k,{className:l.action,ownerState:i,children:s}):null]})});function I(e){return(0,b.Ay)("MuiSnackbar",e)}(0,y.A)("MuiSnackbar",["root","anchorOriginTopCenter","anchorOriginBottomCenter","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft"]);var A=i(62976);let P=e=>{let{classes:t,anchorOrigin:i}=e,s={root:["root","anchorOrigin".concat((0,m.A)(i.vertical)).concat((0,m.A)(i.horizontal))]};return(0,n.A)(s,I,t)},D=(0,d.default)("div",{name:"MuiSnackbar",slot:"Root",overridesResolver:(e,t)=>{let{ownerState:i}=e;return[t.root,t["anchorOrigin".concat((0,m.A)(i.anchorOrigin.vertical)).concat((0,m.A)(i.anchorOrigin.horizontal))]]}})((0,u.A)(e=>{let{theme:t}=e;return{zIndex:(t.vars||t).zIndex.snackbar,position:"fixed",display:"flex",left:8,right:8,justifyContent:"center",alignItems:"center",variants:[{props:e=>{let{ownerState:t}=e;return"top"===t.anchorOrigin.vertical},style:{top:8,[t.breakpoints.up("sm")]:{top:24}}},{props:e=>{let{ownerState:t}=e;return"top"!==t.anchorOrigin.vertical},style:{bottom:8,[t.breakpoints.up("sm")]:{bottom:24}}},{props:e=>{let{ownerState:t}=e;return"left"===t.anchorOrigin.horizontal},style:{justifyContent:"flex-start",[t.breakpoints.up("sm")]:{left:24,right:"auto"}}},{props:e=>{let{ownerState:t}=e;return"right"===t.anchorOrigin.horizontal},style:{justifyContent:"flex-end",[t.breakpoints.up("sm")]:{right:24,left:"auto"}}},{props:e=>{let{ownerState:t}=e;return"center"===t.anchorOrigin.horizontal},style:{[t.breakpoints.up("sm")]:{left:"50%",right:"auto",transform:"translateX(-50%)"}}}]}})),R=s.forwardRef(function(e,t){let i=(0,p.b)({props:e,name:"MuiSnackbar"}),n=(0,h.default)(),o={enter:n.transitions.duration.enteringScreen,exit:n.transitions.duration.leavingScreen},{action:r,anchorOrigin:{vertical:a,horizontal:d}={vertical:"bottom",horizontal:"left"},autoHideDuration:u=null,children:m,className:_,ClickAwayListenerProps:f,ContentProps:v,disableWindowBlurListener:y=!1,message:b,onBlur:S,onClose:C,onFocus:x,onMouseEnter:T,onMouseLeave:k,open:I,resumeHideDuration:R,slots:O={},slotProps:M={},TransitionComponent:L,transitionDuration:j=o,TransitionProps:{onEnter:$,onExited:N,...F}={},...U}=i,H={...i,anchorOrigin:{vertical:a,horizontal:d},autoHideDuration:u,disableWindowBlurListener:y,TransitionComponent:L,transitionDuration:j},W=P(H),{getRootProps:V,onClickAway:B}=l({...H}),[z,q]=s.useState(!0),G=e=>{q(!0),N&&N(e)},J=(e,t)=>{q(!1),$&&$(e,t)},Q={slots:{transition:L,...O},slotProps:{content:v,clickAwayListener:f,transition:F,...M}},[X,K]=(0,A.A)("root",{ref:t,className:[W.root,_],elementType:D,getSlotProps:V,externalForwardedProps:{...Q,...U},ownerState:H}),[Y,{ownerState:Z,...ee}]=(0,A.A)("clickAwayListener",{elementType:c.x,externalForwardedProps:Q,getSlotProps:e=>({onClickAway:function(){for(var t,i=arguments.length,s=Array(i),n=0;n<i;n++)s[n]=arguments[n];null==(t=e.onClickAway)||t.call(e,...s),B(...s)}}),ownerState:H}),[et,ei]=(0,A.A)("content",{elementType:E,shouldForwardComponentProp:!0,externalForwardedProps:Q,additionalProps:{message:b,action:r},ownerState:H}),[es,en]=(0,A.A)("transition",{elementType:g.A,externalForwardedProps:Q,getSlotProps:e=>({onEnter:function(){for(var t,i=arguments.length,s=Array(i),n=0;n<i;n++)s[n]=arguments[n];null==(t=e.onEnter)||t.call(e,...s),J(...s)},onExited:function(){for(var t,i=arguments.length,s=Array(i),n=0;n<i;n++)s[n]=arguments[n];null==(t=e.onExited)||t.call(e,...s),G(...s)}}),additionalProps:{appear:!0,in:I,timeout:j,direction:"top"===a?"down":"up"},ownerState:H});return!I&&z?null:(0,w.jsx)(Y,{...ee,...O.clickAwayListener&&{ownerState:Z},children:(0,w.jsx)(X,{...K,children:(0,w.jsx)(es,{...en,children:m||(0,w.jsx)(et,{...ei})})})})})},79608:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var s=i(76856),n=i(95155);let o=(0,s.A)((0,n.jsx)("path",{d:"M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"}),"Close")},85396:(e,t,i)=>{"use strict";i.d(t,{A:()=>o});var s=i(76856),n=i(95155);let o=(0,s.A)((0,n.jsx)("path",{d:"M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02z"}),"Phone")},85716:()=>{},89360:(e,t,i)=>{"use strict";i.d(t,{s:()=>a});var s=i(79630),n=i(12115),o=i(82261);let r=(e,t,i)=>{let n=(0,s.A)({},e);return t?.forEach(e=>{i?.includes(e)||(n[e]=!1)}),i?.forEach(e=>{t?.includes(e)||(n[e]=!0)}),n},a=e=>{let t=n.useRef(e),i=n.useRef(e.rowGroupingModel??e.initialState?.rowGrouping?.model);return n.useEffect(()=>{e.apiRef.current?.subscribeEvent("rowGroupingModelChange",t=>{let s=r((0,o.FY)(e.apiRef),t,i.current);e.apiRef.current?.setColumnVisibilityModel(s),i.current=t})},[e.apiRef]),n.useMemo(()=>{let e=t.current.initialState,n=r(e?.columns?.columnVisibilityModel,i.current,void 0);return(0,s.A)({},e,{columns:(0,s.A)({},e?.columns,{columnVisibilityModel:n})})},[])}}}]);